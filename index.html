

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Control Pro - Gestão Multiempresas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* SEU CSS COMPLETO AQUI (mantive o mesmo CSS que você forneceu) */
        :root {
            --primary-color: #2c3e50;
            --primary-light: #34495e;
            --primary-dark: #1a252f;
            --secondary-color: #ecf0f1;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        .system-admin-only {
    display: none;
}
        .theme-pink {
            --primary-color: #e84393;
            --primary-light: #fd79a8;
            --primary-dark: #b33974;
            --secondary-color: #ffeaa7;
        }

        .theme-blue {
            --primary-color: #0984e3;
            --primary-light: #74b9ff;
            --primary-dark: #0652a3;
            --secondary-color: #dfe6e9;
        }

        .theme-green {
            --primary-color: #00b894;
            --primary-light: #55efc4;
            --primary-dark: #008066;
            --secondary-color: #d1f7e8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%);
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            padding: 20px;
        }

        .login-box {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .login-logo {
            margin-bottom: 1.5rem;
        }

        .login-logo h1 {
            font-size: 2rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .login-logo p {
            color: var(--text-light);
        }

        .login-form .form-group {
            margin-bottom: 1.2rem;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .login-form input, .login-form select {
            width: 100%;
            padding: 0.85rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        .login-form input:focus, .login-form select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        .btn {
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .app-container {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background-color: #f9f9f9;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: var(--box-shadow);
        }

        .logo h1 {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
        }

        .logo p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        
        
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info i {
            font-size: 1.2rem;
        }

        .container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
            flex-wrap: wrap;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .tab:hover:not(.active) {
            background-color: var(--primary-light);
            color: white;
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }

        .card h2 {
            margin-bottom: 1rem;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            text-align: center;
            color: white;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: white;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background-color: white;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: #bdc3c7;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #95a5a6;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
.btn-success:hover{ filter:brightness(0.95); }
        .btn-success{ background:#16a34a; color:#fff; border:none; cursor:pointer; 
      
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary-light);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-buttons .btn {
            padding: 0.5rem;
        }

        .admin-section {
            background-color: #fff8f8;
            border-left: 4px solid var(--error-color);
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: var(--border-radius);
        }

        .admin-section h3 {
            color: var(--error-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        .toast.warning {
            background-color: var(--warning-color);
        }

        .toast.info {
            background-color: var(--info-color);
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            height: 300px;
        }

        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-box input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .plan-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .plan-basic {
            background-color: var(--info-color);
            color: white;
        }

        .plan-premium {
            background-color: var(--success-color);
            color: white;
        }

        .plan-trial {
            background-color: var(--warning-color);
            color: white;
        }

        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-active {
            background-color: var(--success-color);
            color: white;
        }

        .status-inactive {
            background-color: var(--error-color);
            color: white;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: white;
        }

        .permission-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            margin-right: 0.5rem;
        }

        .access-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .access-admin {
            background-color: var(--error-color);
            color: white;
        }

        .access-seller {
            background-color: var(--info-color);
            color: white;
        }

        .trial-warning {
            background-color: #ffeaa7;
            border-left: 4px solid var(--warning-color);
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                justify-content: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                height: 250px;
            }
            
            .search-box {
                flex-direction: column;
            }
        }
    </style>




      <!-- ====== LOGIN (visível inicialmente) ====== -->
<div class="login-container" id="login-container" style="display:flex">
  <div class="login-box">
    <div class="login-logo">
      <h1><i class="fas fa-tools"></i> System Control Pro</h1>
      <p>Sistema de Gestão Multiempresas</p>
    </div>

    <form class="login-form" id="login-form">
      <div class="form-group">
        <label for="empresa">Empresa:</label>
        <select id="empresa" required>
          <option value="">Selecione a empresa</option>
          <!-- será populado via JS -->
        </select>
      </div>

      <div class="form-group">
        <label for="username">Usuário:</label>
        <input type="text" id="username" required placeholder="Digite seu usuário">
      </div>

      <div class="form-group">
        <label for="password">Senha:</label>
        <input type="password" id="password" required placeholder="Digite sua senha">
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="remember-me"> Lembrar-me
        </label>
      </div>

      <button type="submit" class="btn btn-primary">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
    </form>
  </div>
</div>
<!-- ====== /LOGIN ====== -->

<!-- ====== APP (fica oculto até logar) ====== -->
<div class="app-container" id="app-container" style="display:none">
  <header>
    <div class="logo">
      <h1><i class="fas fa-tools"></i> System Control Pro</h1>
      <p id="empresa-name">Sistema de Gestão de Varejo</p>
    </div>

    <div class="header-controls">
      <div class="user-info">
        <i class="fas fa-user-circle"></i>
        <span id="current-user">Usuário</span>
        <span id="user-role" class="access-badge access-admin">Admin</span>
      </div>
      
      
      <button class="btn btn-secondary" id="theme-toggle">
        <i class="fas fa-palette"></i> Tema
      </button>
    <button class="btn btn-secondary" id="backup-btn">
  <i class="fas fa-download"></i> Backup
</button>
<button class="btn btn-secondary" id="restore-btn">
  <i class="fas fa-upload"></i> Restaurar
</button>
<input type="file" id="restore-input" accept="application/json,.json" style="display:none">

      <button class="btn btn-secondary" id="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>

        

    </div>
  </header>

  <!-- CONTAINER PRINCIPAL (fora do header) -->
  <div class="container">
    <!-- Abas -->
    <div class="tabs">
      <div class="tab active" data-tab="dashboard"><i class="fas fa-home"></i> Dashboard</div>
      <div class="tab" data-tab="products"><i class="fas fa-box"></i> Produtos</div>
      <div class="tab" data-tab="customers"><i class="fas fa-users"></i> Clientes</div>
      <div class="tab" data-tab="quotes"><i class="fas fa-file-invoice-dollar"></i> Orçamentos</div>
      <div class="tab" data-tab="orders"><i class="fas fa-shopping-cart"></i> Pedidos</div>
      <div class="tab" data-tab="reports"><i class="fas fa-chart-bar"></i> Relatórios</div>
      <div class="tab admin-only" data-tab="admin"><i class="fas fa-lock"></i> Administração</div>
       <div class="tab" data-tab="notas"><i class="fas fa-file-invoice"></i> Notas Fiscais</div>
      <div class="tab admin-only system-admin-only" data-tab="audit"><i class="fas fa-clipboard-list"></i> Auditoria</div>
    </div>
    <!-- /Abas -->

    <!-- Conteúdos -->
    <div id="dashboard" class="tab-content active"></div>
    <div id="products" class="tab-content"></div>
    <div id="customers" class="tab-content"></div>
    <div id="quotes" class="tab-content"></div>
    <div id="orders" class="tab-content"></div>
    <div id="reports" class="tab-content"></div>
    <div id="notas" class="tab-content">
  <h2>Notas Fiscais</h2>
  <div id="notas-list"></div>
  <button id="emitir-nota-btn" class="btn btn-success" onclick="SystemControlPro.abrirFormNota()">+ Emitir Nota</button>
</div>
    <div id="admin" class="tab-content"></div>
   
    <div id="audit" class="tab-content"></div>
    <!-- /Conteúdos -->
  </div>
</div>
<!-- ====== /APP ====== -->


    <!-- Modal genérico para formulários -->
    <div id="form-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="SystemControlPro.closeModal('form-modal')">&times;</span>
            <h2 id="modal-title"><i class="fas fa-plus"></i> Adicionar Item</h2>
            <div id="modal-body">
                <!-- Conteúdo do modal será carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de confirmação -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="SystemControlPro.closeModal('confirm-modal')">&times;</span>
            <h2><i class="fas fa-exclamation-triangle"></i> Confirmar ação</h2>
            <p id="confirm-message">Tem certeza que deseja realizar esta ação?</p>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="SystemControlPro.closeModal('confirm-modal')">Cancelar</button>
                <button class="btn btn-danger" id="confirm-button">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal validar orçamento -->
<div class="modal" id="quote-validate-modal">
  <div class="modal-content">
    <span class="close" onclick="SystemControlPro.closeValidateModal()">&times;</span>
    <h3>Validar preços com fornecedor</h3>
    <p id="qv-info" style="margin:6px 0 12px"></p>
    <div id="qv-items" style="max-height:50vh;overflow:auto"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button class="btn btn-secondary" onclick="SystemControlPro.closeValidateModal()">Cancelar</button>
      <button class="btn btn-success" onclick="SystemControlPro.confirmValidateQuote()">Confirmar e enviar ao cliente</button>
    </div>
  </div>
</div>

     <!-- Modal Relatório Técnico -->
<div class="modal" id="report-modal">
  <div class="modal-content">
    <span class="close" onclick="SystemControlPro.closeReportModal()">&times;</span>
    <h3 id="report-modal-title">Novo Relatório Técnico</h3>

    <form id="report-form">
      <div class="form-row">
        <div class="form-group">
          <label>Título / Tipo</label>
          <input id="rep-tipo" placeholder="ex.: Relatório de Atendimento / Faturamento" required>
        </div>
        <div class="form-group">
          <label>Resumo</label>
          <input id="rep-resumo" placeholder="Resumo do relatório" required>
        </div>
      </div>

      <div class="form-group">
        <label>Atividades</label>
        <textarea id="rep-atividades" rows="3" placeholder="Suporte, vendas, estoque, projetos, logística, pós-venda..."></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Destaques</label>
          <textarea id="rep-destaques" rows="3" placeholder="Novas oportunidades, fidelização, suporte técnico..."></textarea>
        </div>
        <div class="form-group">
          <label>Desafios</label>
          <textarea id="rep-desafios" rows="3" placeholder="Alto volume, atualização constante..."></textarea>
        </div>
      </div>

      <div class="form-group">
        <label>Propostas de melhoria</label>
        <textarea id="rep-melhorias" rows="3" placeholder="Automação de estoque, catálogo digital, treinamento..."></textarea>
      </div>

      <div class="form-group">
        <label>Anexos (PDF/Imagens/XML) — múltiplos</label>
        <input id="rep-files" type="file" multiple>
        <small>Os arquivos serão salvos em base64 no sistema.</small>
      </div>

      <input type="hidden" id="rep-id">
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button type="button" class="btn btn-secondary" onclick="SystemControlPro.closeReportModal()">Cancelar</button>
        <button type="submit" class="btn btn-success">Salvar Relatório</button>
      </div>
    </form>
  </div>
</div>

    <!-- Toast de notificação -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Operação realizada com sucesso!</span>
    </div>

    <script type="module">

        // Estrutura de dados para o sistema
        const SystemControlPro = {
            // Admin principal do sistema
            admin: {
                username: 'admin',
                password: 'laempresaess2023',
                name: 'Administrador Principal',
                role: 'system_admin'
            },
			
			auditLogs: [], // [{ts, userId, userName, role, empresaId, empresaNome, action, details}]

            
            // Planos disponíveis
            plans: {
                basic: {
                    name: 'Básico',
                    maxUsers: 5,
                    maxProducts: 300,
                    price: 199.90
                },
                premium: {
                    name: 'Premium',
                    maxUsers: Infinity,
                    maxProducts: Infinity,
                    price: 499.90
                }
            },
            
            // --- Sessão persistente ---
            SESSION_KEY: 'scp_session',
            SESSION_TTL_MS: 12 * 60 * 60 * 1000, // 12h padrão
            SESSION_TTL_LONG_MS: 30 * 24 * 60 * 60 * 1000, // 30 dias
            inactivityTimer: null,
            heartbeatInterval: null,

            saveSession(user, empresa, remember = false) {
                const data = {
                    username: user.username,
                    role: user.role,
                    empresaId: empresa ? empresa.id : null,
                    ts: Date.now(),
                    remember: remember
                };
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(data));
            },

            loadSession() {
                const raw = localStorage.getItem(this.SESSION_KEY);
                if (!raw) return null;
                try {
                    const s = JSON.parse(raw);
                    const ttl = s.remember ? this.SESSION_TTL_LONG_MS : this.SESSION_TTL_MS;
                    if (!s.ts || (Date.now() - s.ts) > ttl) {
                        localStorage.removeItem(this.SESSION_KEY);
                        return null;
                    }
                    return s;
                } catch {
                    localStorage.removeItem(this.SESSION_KEY);
                    return null;
                }
            },

            refreshSessionTTL() {
                const s = this.loadSession();
                if (!s) return;
                s.ts = Date.now();
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(s));
            },

            clearSession() {
                localStorage.removeItem(this.SESSION_KEY);
            },

            tryAutoLogin() {
                const s = this.loadSession();
                if (!s) return false;

                if (s.role === 'system_admin') {
                    this.currentUser = { ...this.admin };
                    this.currentEmpresa = null;
                    this.showApp();
                    return true;
                }

                // login por empresa
                const emp = this.empresas.find(e => e.id == s.empresaId);
                if (!emp) { this.clearSession(); return false; }

                const users = this.usuarios[s.empresaId] || [];
                const u = users.find(x => x.username === s.username);
                if (!u) { this.clearSession(); return false; }

                this.currentUser = u;
                this.currentEmpresa = emp;
                this.showApp();
                return true;
            },

            setupInactivityTimer() {
                // Limpar timer existente
                if (this.inactivityTimer) clearTimeout(this.inactivityTimer);
                
                // Configurar novo timer (15 minutos)
                this.inactivityTimer = setTimeout(() => {
                    this.handleLogout();
                    this.showToast('Sessão expirada por inatividade', 'warning');
                }, 15 * 60 * 1000);
            },

            resetInactivityTimer() {
                this.setupInactivityTimer();
            },

            setupHeartbeat() {
                // Limpar intervalo existente
                if (this.heartbeatInterval) clearInterval(this.heartbeatInterval);
                
                // Configurar novo intervalo (5 minutos)
                this.heartbeatInterval = setInterval(() => {
                    if (this.currentUser) {
                        this.refreshSessionTTL();
                    }
                }, 5 * 60 * 1000);
            },

            // Empresas cadastradas
            empresas: [],
            
            // Usuários do sistema (por empresa)
            usuarios: {},
            
            // Produtos (por empresa)
            produtos: {},
            
            // Clientes (por empresa)
            clientes: {},
            
            // Orçamentos (por empresa)
            orcamentos: {},
            
            // Pedidos (por empresa)
            pedidos: {},
            
            // Configurações (por empresa)
            configuracoes: {},
            notas: {},
            configFisco: {},
            
            // Estado atual
            currentUser: null,
            currentEmpresa: null,
            currentTab: 'dashboard',
            currentEditingCompanyId: null,
            
			
            // Inicializar o sistema
            init: function() {
                this.loadFromStorage();
                try { this.notas = JSON.parse(localStorage.getItem('scp_notas')) || {}; } catch(e){ this.notas = {}; }

                  // >>> RESTAURAR TEMA SALVO
    try {
        const savedTheme = localStorage.getItem('scp_theme');
        if (savedTheme) {
            document.body.className = savedTheme;
        }
    } catch (e) {}

                this.setupEventListeners();
                this.loadEmpresasDropdown();
                this.checkExpiredTrials();
                
                // Tenta auto-login primeiro
                if (!this.tryAutoLogin()) {
                    // Se não conseguiu, mostra tela de login
                    document.getElementById('login-container').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';

                    try {
  const cfg = JSON.parse(localStorage.getItem('scp_configuracoes') || '{}');
  this.configuracoes = cfg;
} catch (e) {
  this.configuracoes = {};
}
                }
            },
            
            // Carregar dados do localStorage
            loadFromStorage: function() {
                const savedData = localStorage.getItem('systemControlPro_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    this.empresas = data.empresas || [];
                    this.usuarios = data.usuarios || {};
                    this.produtos = data.produtos || {};
                    this.clientes = data.clientes || {};
                    this.orcamentos = data.orcamentos || {};
                    this.pedidos = data.pedidos || {};
                    this.configuracoes = data.configuracoes || {};
                    this.auditLogs = data._auditLogs || [];
                    this.relatorios = data.relatorios || {};
                }
                                // Garantir estrutura das configurações
                for (const empId in this.configuracoes) {
                    this.configuracoes[empId] = {
                        empresaId: parseInt(empId),
                        metaMensal: this.configuracoes[empId].metaMensal || 0,
                        comissaoPercentual: this.configuracoes[empId].comissaoPercentual || 0,
                        metasPorUsuario: this.configuracoes[empId].metasPorUsuario || {},
                        comissaoPorUsuario: this.configuracoes[empId].comissaoPorUsuario || {}
                    };
                }
				
                // Se não há empresas, criar uma padrão para demonstração (somente em modo demo)
if (window.SCP_DEMO_SEED === true && this.empresas.length === 0) {
  this.createDemoData();
}

            },
            
            // Criar dados de demonstração
            createDemoData: function() {
                // Criar empresa de demonstração
                const demoEmpresa = {
                    id: 1,
                    nome: 'Empresa Demonstração',
                    cnpj: '00.000.000/0001-00',
                    endereco: 'Rua Exemplo, 123',
                    telefone: '(11) 9999-9999',
                    email: 'contato@empresademo.com.br',
                    plano: 'premium',
                    dataCriacao: new Date().toISOString(),
                    status: 'active',
                    codigo: '0001',
                    logo: null
                };
                
                this.empresas.push(demoEmpresa);
                
                // Adicionar usuários padrão para a empresa
                this.usuarios[1] = [
                    {
                        id: 1,
                        username: 'admin',
                        password: 'senha123',
                        name: 'Administrador da Empresa',
                        role: 'admin',
                        email: 'admin@empresa.com',
                        permissions: ['all'],
                        status: 'active'
                    },
                    {
                        id: 2,
                        username: 'vendedor',
                        password: 'senha123',
                        name: 'Vendedor Exemplo',
                        role: 'seller',
                        email: 'vendedor@empresa.com',
                        permissions: ['sales', 'customers'],
                        status: 'active'
                    }
                ];
                
                // Adicionar pedidos de exemplo
                this.pedidos[1] = [
                    {
                        id: 1,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        data: new Date().toISOString(),
                        items: [
                            { produtoId: 3, quantidade: 1, preco: 459.90, total: 459.90 }
                        ],
                        total: 459.90,
                        status: 'delivered',
                        vendedorId: 2 // id do 'vendedor' demo, manter coerente com os dados
                    }
                ];
                    
                
                // Adicionar clientes de exemplo
                this.clientes[1] = [
                    {
                        id: 1,
                        nome: 'João Silva',
                        email: 'joao@email.com',
                        telefone: '(11) 99999-9999',
                        cpfCnpj: '123.456.789-00',
                        endereco: 'Rua das Flores, 123 - São Paulo/SP',
                        dataCadastro: new Date().toISOString(),
                        status: 'active'
                    },
                    {
                        id: 2,
                        nome: 'Maria Santos',
                        email: 'maria@email.com',
                        telefone: '(11) 98888-8888',
                        cpfCnpj: '987.654.321-00',
                        endereco: 'Av. Paulista, 1000 - São Paulo/SP',
                        dataCadastro: new Date().toISOString(),
                        status: 'active'
                    }
                ];
                
                // Adicionar orçamentos de exemplo
                this.orcamentos[1] = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        data: new Date().toISOString(),
                        validoAte: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        items: [
                            { produtoId: 1, quantidade: 1, preco: 299.90, total: 299.90 },
                            { produtoId: 2, quantidade: 2, preco: 89.90, total: 179.80 }
                        ],
                        total: 479.70,
                        status: 'pending'
                    }
                ];
                
                // Adicionar pedidos de exemplo
                this.pedidos[1] = [
                    {
                        id: 1,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        data: new Date().toISOString(),
                        items: [
                            { produtoId: 3, quantidade: 1, preco: 459.90, total: 459.90 }
                        ],
                        total: 459.90,
                        status: 'delivered'
                    }
                ];
                
                // Configurações padrão
                this.configuracoes[1] = {
                    empresaId: 1,
                    metaMensal: 100000,
                    comissaoPercentual: 3,
                    metasPorUsuario: {},
                    comissaoPorUsuario: {}
                };
                
                this.saveToStorage();
            },
            
           // Dentro do objeto SystemControlPro { ... }
saveToStorage: function() {
  const data = {
    empresas: this.empresas,
    usuarios: this.usuarios,
    produtos: this.produtos,
    clientes: this.clientes,
    orcamentos: this.orcamentos,
    pedidos: this.pedidos,
    configuracoes: this.configuracoes,
    relatorios: this.relatorios,
    _auditLogs: this.auditLogs
           
  };
  localStorage.setItem('systemControlPro_data', JSON.stringify(data));
},


_saveNotas: function(){
  try { localStorage.setItem('scp_notas', JSON.stringify(this.notas)); } catch(e){}
},

// ================= [FISCAL] Helpers de configuração =================
_getFiscalCfg(empresaId){
  const base = {
    enabled: false,              // liga/desliga emissão oficial
    provider: '',                // 'nfeio' | 'enotas' | 'plugnotas' | 'focus' ...
    apiToken: '',                // token/secret do provedor
    ambiente: 'homolog',         // 'homolog' | 'producao'
    regime: 'mei',               // 'mei' | 'simples_nacional' | 'normal'
    certificadoA1: null,         // DataURL do .pfx se necessário
    certificadoSenha: '',
    autoEmitOnApprove: true,     // aprovar orçamento -> emitir NF-e
    // defaults simples
    cfopDentro: '5102',
    cfopFora: '6102',
    cst_csosn: '102',
    pisCofinsCumulativo: true
  };
  this.configFisco[empresaId] ||= base;
  return Object.assign({}, base, this.configFisco[empresaId]);
},
_saveFiscalCfg(empresaId, cfg){
  this.configFisco[empresaId] = cfg;
  this.saveToStorage?.();
},
// ====================================================================


// Contexto fiscal básico (UF emitente/destinatário, órgão alvo)
_resolveTaxContext(empresaId, pedido){
  const cfg = this._getFiscalCfg(empresaId);
  const empresa = this.currentEmpresa || {};
  const cli = (this.clientes[empresaId]||[]).find(c=>c.id===pedido.clienteId) || {};

  const ufEmit = cfg.ufEmitente || empresa.uf || '';
  const ufDest = cli.uf || (cli.enderecoUf || '');
  const intra = ufEmit && ufDest ? (ufEmit === ufDest) : true;

  return {
    docType: cfg.docType,           // 'nfe' | 'nfse'
    orgao: cfg.docType === 'nfse' ? 'prefeitura' : 'sefaz',
    ufEmitente: ufEmit,
    municipioCodigo: cfg.nfseMunicipioCodigo || '',
    ufDestinatario: ufDest || '',
    intraEstadual: intra,
    regime: cfg.regime
  };
},



// === Helpers de data ===
_addDays(date, days){
  const d = new Date(date);
  d.setDate(d.getDate() + Number(days || 0));
  return d;
},
_fmt(d){
  if(!d) return '';
  const x = new Date(d);
  return x.toLocaleDateString();
},
_nowISO(){ return new Date().toISOString(); },


// Helpers de configuração fiscal
_getFiscalCfg: function(empresaId){
  const base = {
    enabled: false,
    provider: '',
    apiToken: '',
    ambiente: 'homolog',      // 'homolog' | 'producao'
    regime: 'mei',            // 'mei' | 'simples_nacional' | 'normal'
    certificadoA1: null,
    certificadoSenha: '',
    autoEmitOnApprove: true,
    cfopDentro: '5102',
    cfopFora: '6102',
    cst_csosn: '102',
    pisCofinsCumulativo: true
  };
  this.configFisco[empresaId] ||= base;
  return Object.assign({}, base, this.configFisco[empresaId]);
},



abrirFormNota: function(){
  const modal = document.getElementById('form-modal');
  const title = document.getElementById('modal-title');
  const body  = document.getElementById('modal-body');
  if (!modal || !title || !body) return;

  title.innerHTML = `<i class="fas fa-file-invoice"></i> Emitir Nota Fiscal`;
  body.innerHTML = `
    <form id="nota-form">
      <div class="form-row">
        <div class="form-group">
          <label>Número da Nota</label>
          <input id="nf-numero" required placeholder="Ex.: 1234">
        </div>
        <div class="form-group">
          <label>Data</label>
          <input id="nf-data" type="datetime-local" value="${new Date().toISOString().slice(0,16)}">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Cliente (nome)</label>
          <input id="nf-cliente-nome" placeholder="Nome do cliente">
        </div>
        <div class="form-group">
          <label>CPF/CNPJ</label>
          <input id="nf-doc" placeholder="CPF ou CNPJ">
        </div>
      </div>

      <div class="form-group">
        <label>Total (R$)</label>
        <input id="nf-total" type="number" step="0.01" min="0" value="0.00">
      </div>

      <div class="form-group">
        <label>Observações</label>
        <textarea id="nf-obs" rows="2" placeholder="Opcional"></textarea>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button type="button" class="btn btn-secondary" onclick="SystemControlPro.closeModal('form-modal')">Cancelar</button>
        <button type="submit" class="btn btn-success">Salvar</button>
      </div>
    </form>
  `;

  // bind submit
  const form = document.getElementById('nota-form');
  form && form.addEventListener('submit', (e)=> this._submitNotaForm(e));

  // abrir modal
  modal.style.display = 'flex';
},

_submitNotaForm: function(e){
  e.preventDefault();
  const empresaId = this.currentEmpresa?.id;
  if (!empresaId) return;

  // ler campos
  const numero = document.getElementById('nf-numero')?.value?.trim();
  const dataISO = document.getElementById('nf-data')?.value || new Date().toISOString().slice(0,16);
  const clienteNome = document.getElementById('nf-cliente-nome')?.value?.trim();
  const cpfCnpj = document.getElementById('nf-doc')?.value?.trim();
  const total = Number(document.getElementById('nf-total')?.value || 0);
  const obs = document.getElementById('nf-obs')?.value?.trim();

  if (!this.notas[empresaId]) this.notas[empresaId] = [];
  this.notas[empresaId].push({
    numero,
    data: new Date(dataISO).toISOString(),
    clienteNome,
    cpfCnpj,
    total,
    obs,
    anexos: [] // no futuro: DANFE/XML oficiais
  });

  this._saveNotas();
  this.closeModal && this.closeModal('form-modal');
  this.showToast && this.showToast('Nota salva.', 'success');
  this.renderNotas();
},

renderNotas: function(){
  const empresaId = this.currentEmpresa?.id;
  const notas = (this.notas?.[empresaId]) || [];
  const cont = document.getElementById('notas');
  if (!cont) return;

  const rows = notas.map(n => `
    <tr>
      <td>${n.numero || ''}</td>
      <td>${n.clienteNome || ''}</td>
      <td>${new Date(n.data).toLocaleString()}</td>
      <td>R$ ${Number(n.total||0).toFixed(2)}</td>
      <td>
        ${(n.anexos||[]).map(a=>`
          <a href="${a.dataUrl}" download="${a.name}" class="btn btn-sm btn-secondary">
            <i class="fas fa-download"></i> ${a.name}
          </a>
        `).join(' ')}
      </td>
    </tr>
  `).join('');

  cont.innerHTML = `
    <h2><i class="fas fa-file-invoice"></i> Notas Fiscais</h2>
    <div style="margin:0 0 1rem">
      <button class="btn btn-success" onclick="SystemControlPro.abrirFormNota()">+ Emitir Nota</button>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Número</th>
          <th>Cliente</th>
          <th>Data</th>
          <th>Total</th>
          <th>Arquivos</th>
        </tr>
      </thead>
      <tbody>${rows || ''}</tbody>
    </table>
  `;
},


_saveFiscalCfg: function(empresaId, cfg){
  this.configFisco[empresaId] = cfg;
  this.saveToStorage && this.saveToStorage();
},


backupData: function() {
  // baixa tudo que está no localStorage (chave do sistema)
  const raw = localStorage.getItem('systemControlPro_data') || '{}';
  const blob = new Blob([raw], { type: 'application/json' });

  // nome do arquivo: empresa atual (ou 'todas') + data
  let empresa = 'todas';
  try {
    const data = JSON.parse(raw);
    if (this.currentEmpresa && this.currentEmpresa.id) {
      empresa = String(this.currentEmpresa.id).padStart(4, '0');
    } else if (Array.isArray(data.empresas) && data.empresas.length === 1) {
      empresa = String(data.empresas[0].id).padStart(4, '0');
    }
  } catch {}

  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `scp-backup-${empresa}-${ts}.json`;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
  this.showToast?.('Backup gerado', 'success');
}, // ⬅️ vírgula aqui, pois vem outro método depois

restoreFromFile: function(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (!data || typeof data !== 'object' || !('empresas' in data)) {
        alert('Arquivo inválido: estrutura inesperada.');
        return;
      }
      localStorage.setItem('systemControlPro_data', JSON.stringify(data));
      alert('Backup restaurado com sucesso. A página será recarregada.');
      location.reload();
    } catch (e) {
      console.error(e);
      alert('Erro ao ler o JSON: ' + e.message);
    }
  };
  reader.readAsText(file);
}, // ⬅️ vírgula se houver mais métodos depois

 
normalizeData: function () {
  // lê o que está no storage
  const raw = localStorage.getItem('systemControlPro_data') || '{}';
  let d;
  try { d = JSON.parse(raw) } catch { d = {} }

  // garante chaves-raiz
  d.empresas ||= [];
  d.usuarios ||= {};
  d.produtos ||= {};
  d.clientes ||= {};
  d.orcamentos ||= {};
  d.pedidos ||= {};
  d.configuracoes ||= {};
  d._auditLogs ||= [];

  // por empresa
  d.empresas.forEach(emp => {
    const id = emp.id;

    d.usuarios[id] ||= [{
      id: 1, username: 'admin', password: 'admin123',
      name: 'Administrador', role: 'admin', status: 'active'
    }];

    // ✅ defaults sem serem sobrescritos por valores “vazios”
    d.produtos[id] = (d.produtos[id] || []).map(p => ({
      ...p, // primeiro espalha o que já existe
      pricePolicy: p.pricePolicy ?? (p.priceFixed ? 'contract' : 'margin'),
      marginPercent: p.marginPercent ?? 0,
      supplierUrl: p.supplierUrl ?? '',
      lastSupplierPrice: p.lastSupplierPrice ?? null
    }));

    d.clientes[id] ||= [];
    d.orcamentos[id] ||= [];
    d.pedidos[id] ||= [];
    d.configuracoes[id] ||= {
      empresaId: id,
      metaMensal: 10000,
      comissaoPercentual: 5,
      marginGeral: 20, // % margem padrão
      metasPorUsuario: {},
      comissaoPorUsuario: {}
    };
  });

  // grava de volta e atualiza o estado em memória
  localStorage.setItem('systemControlPro_data', JSON.stringify(d));
  this.empresas = d.empresas;
  this.usuarios = d.usuarios;
  this.produtos = d.produtos;
  this.clientes = d.clientes;
  this.orcamentos = d.orcamentos;
  this.pedidos = d.pedidos;
  this.configuracoes = d.configuracoes;
  this.auditLogs = d._auditLogs || [];
},


            // Configurar event listeners
            setupEventListeners: function() {
                 
                
                // Logout button
                document.getElementById('logout-btn').addEventListener('click', () => {
                    this.handleLogout();
                });
                
                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
                document.getElementById('backup-btn')?.addEventListener('click', () => {
  SystemControlPro.backupData();
});

document.getElementById('restore-btn')?.addEventListener('click', () => {
  document.getElementById('restore-input').click();
});

document.getElementById('restore-input')?.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  if (f) SystemControlPro.restoreFromFile(f);
  e.target.value = ''; // permite escolher o mesmo arquivo de novo depois
});
 
      

                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        this.switchTab(tabId);
                    });
                });

                // Eventos de atividade para resetar timer de inatividade
                const activityEvents = ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'];
                activityEvents.forEach(event => {
                    document.addEventListener(event, () => {
                        if (this.currentUser) {
                            this.resetInactivityTimer();
                        }
                    });
                });
            },
            
            // Carregar dropdown de empresas
            loadEmpresasDropdown: function() {
                const select = document.getElementById('empresa');
                select.innerHTML = '<option value="">Selecione a empresa</option>';
                
                this.empresas.forEach(empresa => {
                    // Verificar se a empresa está ativa ou em trial válido
                    if (empresa.status === 'active' || 
                        (empresa.status === 'trial' && this.isTrialValid(empresa.dataCriacao))) {
                        const option = document.createElement('option');
                        option.value = empresa.id;
                        // MOSTRA SÓ O CÓDIGO, NÃO O NOME
                        const codigo = String(empresa.id).padStart(4,'0');
                        option.textContent = `Empresa ${codigo}`;
                        if (empresa.status === 'trial') {
                            option.textContent += ' (Trial)';
                        }
                        select.appendChild(option);
                    }
                });
                
                // Adicionar opção para admin do sistema
                const option = document.createElement('option');
                option.value = 'system_admin';
                option.textContent = 'Administração do Sistema';
                select.appendChild(option);
            },
            
            // Verificar se o trial ainda é válido
            isTrialValid: function(dataCriacao) {
                const criacaoDate = new Date(dataCriacao);
                const hoje = new Date();
                const diffTime = Math.abs(hoje - criacaoDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 7;
            },
            // ================= [FISCAL] Salvar configurações =================
// ================= [FISCAL] Salvar configurações =================
saveFiscalSettings: function(){
  if (!this.currentEmpresa) return;
  const empresaId = this.currentEmpresa.id;
  const old = this._getFiscalCfg(empresaId);

  const readFileAsDataURL = (file)=> new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = e => res(e.target.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });

  (async ()=>{
    const fx = {
      enabled: document.getElementById('fx-enabled').value === 'true',
      docType: document.getElementById('fx-doc').value,
      provider: document.getElementById('fx-provider').value,
      ambiente: document.getElementById('fx-amb').value,
      regime: document.getElementById('fx-regime').value,
      ufEmitente: document.getElementById('fx-uf').value,
      nfseMunicipioCodigo: document.getElementById('fx-mun').value.trim(),
      apiToken: document.getElementById('fx-token').value.trim(),
      autoEmitOnApprove: document.getElementById('fx-auto').value === 'true',
      cfopDentro: document.getElementById('fx-cfop-in').value.trim() || '5102',
      cfopFora: document.getElementById('fx-cfop-out').value.trim() || '6102',
      cst_csosn: document.getElementById('fx-csosn').value.trim() || '102',
      taxApiEnabled: document.getElementById('fx-tax-enabled').value === 'true',
      taxApiBase: document.getElementById('fx-tax-base').value.trim(),
      taxApiKey: document.getElementById('fx-tax-key').value.trim(),
      taxCacheTtlMinutes: Number(document.getElementById('fx-tax-ttl').value || 60),
      certificadoA1: old.certificadoA1,
      certificadoSenha: document.getElementById('fx-a1-pass').value
    };

    const a1Input = document.getElementById('fx-a1');
    if (a1Input?.files?.length) {
      fx.certificadoA1 = await readFileAsDataURL(a1Input.files[0]);
    }

    this._saveFiscalCfg(empresaId, fx);
    this.showToast?.('Configurações fiscais salvas.', 'success');
  })().catch(()=>{
    this.showToast?.('Falha ao salvar configurações fiscais.', 'error');
  });
},
// =================================================================

            // Verificar trials expirados
            checkExpiredTrials: function() {
                this.empresas.forEach(empresa => {
                    if (empresa.status === 'trial' && !this.isTrialValid(empresa.dataCriacao)) {
                        empresa.status = 'expired';
                    }
                });
                this.saveToStorage();
            },
            
            // Manipular login
            handleLogin: function() {
                // Verificar trials expirados antes do login
                this.checkExpiredTrials();
                
                const empresaId = document.getElementById('empresa').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const remember = document.getElementById('remember-me').checked;
                
                // Verificar se é login do admin do sistema
                if (empresaId === 'system_admin') {
                    if (username === this.admin.username && password === this.admin.password) {
                        this.currentUser = this.admin;
                        this.currentEmpresa = null;
                        this.saveSession(this.admin, null, remember);
                        this.showApp();
                        this.showToast('Login como administrador do sistema realizado com sucesso!', 'success');
                        return;
                    } else {
                        this.showToast('Credenciais de administração inválidas', 'error');
                        return;
                    }
                }
                
                // Verificar se é login de empresa
                if (!empresaId) {
                    this.showToast('Selecione uma empresa', 'error');
                    return;
                }
                
                const empresa = this.empresas.find(e => e.id == empresaId);
                
                if (!empresa) {
                    this.showToast('Empresa não encontrada', 'error');
                    return;
                }
                
                // Verificar se a empresa está ativa
                if (empresa.status !== 'active' && 
                    !(empresa.status === 'trial' && this.isTrialValid(empresa.dataCriacao))) {
                    this.showToast('Esta empresa não está ativa ou o trial expirou', 'error');
                    return;
                }
                
                const usuariosEmpresa = this.usuarios[empresaId] || [];
                const user = usuariosEmpresa.find(u => u.username === username && u.password === password);
                
                if (user) {
                    this.currentUser = user;
                    this.currentEmpresa = empresa;
                    this.saveSession(user, empresa, remember);
                    this.showApp();
					this.logAction('login', { username: username }); // ADICIONE ESTA LINHA
                    this.showToast('Login realizado com sucesso!', 'success');
                } else {
                    this.showToast('Usuário ou senha inválidos', 'error');
                }
            },
            
            // Mostrar aplicação
                // Mostrar aplicação
    showApp: function () {
      const login = document.getElementById('login-container');
      const app   = document.getElementById('app-container');
      if (login) login.style.display = 'none';
      if (app)   app.style.display   = 'block';

      // (opcional) se existirem
      try { this.bindUI && this.bindUI(); } catch(e){}
      try { this.renderEmpresas && this.renderEmpresas(); } catch(e){}
      try { this.renderUsuarios && this.renderUsuarios(); } catch(e){}
      try { this.renderAudit && this.renderAudit(); } catch(e){}

      // inicializa troca de abas
      try { setupTabs(); } catch(e){}

      // ... depois de ativar a aba e o conteúdo correspondente:
if (tabName === 'orders' && typeof SystemControlPro.renderOrders === 'function') {
  SystemControlPro.renderOrders();
}
if (tabName === 'notas' && typeof SystemControlPro.renderNotas === 'function') {
  SystemControlPro.renderNotas();
}

      


try { this._loadNotas(); } catch(e){}
try { this.renderNotas(); } catch(e){}




      try { this._loadNotas(); } catch(e){}
      try { this.renderNotas(); } catch(e){}


      // Atualizar papel do usuário
      const roleBadge = document.getElementById('user-role');
      if (roleBadge) {
        const r = this.currentUser?.role;
        roleBadge.textContent = (r === 'system_admin') ? 'System Admin' : (r === 'admin') ? 'Admin' : 'Vendedor';
        roleBadge.className = 'access-badge ' + (r === 'seller' ? 'access-seller' : 'access-admin');
      }

      // Atualizar nome da empresa
      if (this.currentEmpresa) {
        const nm = document.getElementById('empresa-name');
        if (nm) nm.textContent = `${this.currentEmpresa.nome} (${this.currentEmpresa.codigo})`;
        if (this.currentEmpresa.status === 'trial') {
          this.showTrialWarning && this.showTrialWarning();
        }
      }
    },


    // ---- [ORDERS] renderiza a lista de pedidos na aba "Pedidos" ----
renderOrders: function () {
  const empresaId = this.currentEmpresa?.id;
  const tbody = document.getElementById('pedidos-tbody');
  if (!tbody || !empresaId) return;

  const pedidos = (this.pedidos?.[empresaId] || []).slice().sort((a,b)=> (b.id||0)-(a.id||0));
  if (!pedidos.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="padding:10px">Sem pedidos ainda.</td></tr>';
    return;
  }

  const rows = pedidos.map(p=>{
    const data = new Date(p.data || p.createdAt || Date.now()).toLocaleString('pt-BR');
    const total = Number(p.total ?? 0).toFixed(2);
    const cliente = p.clienteNome || '-';
    return `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${p.id}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${cliente}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${data}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">R$ ${total}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">
          <button class="btn" onclick="SystemControlPro.emitInvoiceFromOrder(${p.id})">NF / DANFE</button>
          <button class="btn" onclick="SystemControlPro.generateSalePDF(${p.id})">PDF da Venda</button>
          <button class="btn" onclick="SystemControlPro.abrirFormNota(${p.id})">Emitir Nota (interna)</button>
        </td>
      </tr>
    `;
  }).join('');

  tbody.innerHTML = rows;
},


// ---- [NOTAS] persistência ----
_loadNotas: function () {
  try { this.notas = SCP.getData('notas') || {}; } catch { this.notas = {}; }
},
_saveNotas: function () {
  try { SCP.setData('notas', this.notas || {}); } catch {}
},

// ---- [NOTAS] render da aba "Notas" ----
renderNotas: function () {
  const empresaId = this.currentEmpresa?.id;
  const cont = document.getElementById('notas-list');
  if (!cont || !empresaId) return;

  const lista = (this.notas?.[empresaId] || []).slice().sort((a,b)=> (b.id||0)-(a.id||0));
  if (!lista.length) {
    cont.innerHTML = '<p class="muted">Nenhuma nota emitida ainda.</p>';
    return;
  }

  cont.innerHTML = lista.map(n => {
    const quando = new Date(n.criadoEm || n.ts || Date.now()).toLocaleString('pt-BR');
    const anexos = (n.anexos || []).map(ax => {
      const safe = ax?.dataUrl ? `href="${ax.dataUrl}" download="${ax.name}"` : '';
      const label = ax?.name || 'arquivo';
      return `<a ${safe} class="btn btn-secondary" style="margin-right:6px">${label}</a>`;
    }).join('');
    return `
      <div class="panel" style="margin-bottom:10px">
        <div><b>${n.tipo || 'NF interna'}</b> — Nº ${n.numero || n.pedidoId} — ${quando}</div>
        ${n.chaveAcesso ? `<div>Chave de Acesso: <code>${n.chaveAcesso}</code></div>` : ''}
        <div style="margin-top:8px">${anexos || '<span class="muted">Sem anexos</span>'}</div>
      </div>
    `;
  }).join('');
},



            
            // Mostrar aviso de trial
            showTrialWarning: function() {
                const criacaoDate = new Date(this.currentEmpresa.dataCriacao);
                const hoje = new Date();
                const diffTime = Math.abs(hoje - criacaoDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diasRestantes = 7 - diffDays;
                
                // Criar elemento de aviso
                const warningDiv = document.createElement('div');
                warningDiv.className = 'trial-warning';
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); font-size: 1.5rem;"></i>
                    <div>
                        <strong>Conta em modo Trial</strong>
                        <p>Você tem ${diasRestantes} dias restantes de trial. Entre em contato com nosso suporte para ativar sua conta.</p>
                    </div>
                `;
                
                // Inserir após as abas
                const container = document.querySelector('.container');
                container.insertBefore(warningDiv, container.querySelector('.tab-content'));
            },
            
            // Configurar permissões do usuário
            setupUserPermissions: function() {
              const isAdmin = this.currentUser.role === 'admin' || this.currentUser.role === 'system_admin';
              const isSystemAdmin = this.currentUser.role === 'system_admin';

              // Mostrar/ocultar abas de administração para ADMIN e SYSTEM ADMIN
             document.querySelectorAll('.admin-only').forEach(el => {
             el.style.display = isAdmin ? 'flex' : 'none';
            });

              // Para SYSTEM ADMIN, além disso, mostrar também as abas exclusivas do sistema (ex.: Auditoria)
            document.querySelectorAll('.system-admin-only').forEach(el => {
            el.style.display = isSystemAdmin ? 'flex' : 'none';
            });

            // Garantir que estamos numa aba visível
            if (isSystemAdmin) {
            // pode ser 'admin' ou 'audit'; escolha a que preferir como padrão
            this.switchTab('admin');
               }
            },

            
            // Trocar de aba
            switchTab: function(tabId) {
                this.currentTab = tabId;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // Carregar o conteúdo da aba
                this.loadTabContent(tabId);
            },
            
            // Carregar conteúdo da aba
            loadTabContent: function(tabId) {
                switch(tabId) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'products':
                        this.loadProducts();
                        break;
                    

                    case 'customers':
                        this.loadCustomers();
                        break;
                    case 'quotes':
                        this.loadQuotes();
                        break;
                    case 'orders':
                        this.loadOrders();
                        break;
                    case 'reports':
                        this.loadReports();
                        break;
                    case 'admin':
                        this.loadAdmin();
                        break;
                    case 'users':
                        this.loadUsers();
                        break;
					case 'audit':
                        this.loadAudit();
                        break;	
                }
            },
            
            // Carregar dashboard
loadDashboard: function() {
  const dashboard = document.getElementById('dashboard');
  if (!dashboard) return;

  // ===== Helpers locais =====
  const num = (v, fb=0) => Number.isFinite(+v) ? +v : fb;
  const monthRange = (d) => {
    const first = new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0);
    const last  = new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999);
    return { first, last };
  };
  const addDays = (dt, days) => { const x = new Date(dt); x.setDate(x.getDate()+days); return x; };

  // ===== System Admin (painel global) =====
  if (this.currentUser.role === 'system_admin') {
    const totalEmpresas = this.empresas.length;
    const totalUsers    = Object.values(this.usuarios).reduce((acc, arr)=> acc + (arr?.length||0), 0);
    const totalPedidos  = Object.values(this.pedidos).reduce((acc, arr)=> acc + (arr?.length||0), 0);
    const totalOrcs     = Object.values(this.orcamentos).reduce((acc, arr)=> acc + (arr?.length||0), 0);

    dashboard.innerHTML = `
      <div class="admin-section">
        <h3><i class="fas fa-lock"></i> Área do Administrador do Sistema</h3>
        <p>Esta área permite gerenciar todas as empresas do sistema.</p>
      </div>


      

      
      <div class="stats-grid">
        <div class="stat-card">
          <h3><i class="fas fa-building"></i> Empresas Cadastradas</h3>
          <div class="stat-value">${totalEmpresas}</div>
          <div>${this.empresas.filter(e => e.status === 'active').length} ativas</div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-users"></i> Total de Usuários</h3>
          <div class="stat-value">${totalUsers}</div>
          <div>Em todas as empresas</div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-shopping-cart"></i> Total de Pedidos</h3>
          <div class="stat-value">${totalPedidos}</div>
          <div>Em todas as empresas</div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-file-invoice-dollar"></i> Total de Orçamentos</h3>
          <div class="stat-value">${totalOrcs}</div>
          <div>Em todas as empresas</div>
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-building"></i> Empresas Cadastradas</h2>
        <button class="btn btn-primary" onclick="SystemControlPro.showAddCompanyModal()">
          <i class="fas fa-plus"></i> Adicionar Empresa
        </button>

        <table style="margin-top: 1rem;">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Plano</th>
              <th>Status</th>
              <th>Data de Criação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            ${this.empresas.map(empresa => `
              <tr>
                <td>${empresa.nome}</td>
                <td>
                  ${empresa.plano === 'basic' ? 
                    '<span class="plan-badge plan-basic">Básico</span>' : 
                    '<span class="plan-badge plan-premium">Premium</span>'}
                  ${empresa.status === 'trial' ? '<span class="plan-badge plan-trial">Trial</span>' : ''}
                </td>
                <td>
                  ${empresa.status === 'active' ? 
                    '<span class="status-badge status-active">Ativa</span>' : 
                    empresa.status === 'trial' ? 
                    '<span class="status-badge status-pending">Trial</span>' : 
                    '<span class="status-badge status-inactive">Inativa</span>'}
                </td>
                <td>${new Date(empresa.dataCriacao).toLocaleDateString()}</td>
                <td class="action-buttons">
                  <button class="btn btn-secondary" onclick="SystemControlPro.editCompany(${empresa.id})"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-danger" onclick="SystemControlPro.deleteCompany(${empresa.id})"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    return;
  }

  // ===== Dashboard por empresa (admin/seller) =====
  const empresaId   = this.currentEmpresa.id;
  const produtos    = this.produtos[empresaId]   || [];
  const orcamentos  = this.orcamentos[empresaId] || [];
  const pedidos     = this.pedidos[empresaId]    || [];
  const config      = this.configuracoes[empresaId] || {};

  const isAdminEmpresa = this.currentUser.role === 'admin';
  const isVendedor     = this.currentUser.role === 'seller';

  // metas/comissão por usuário com fallback para geral (ATENÇÃO: comissaoPercentual em FRAÇÃO, ex.: 0.05 = 5%)
  const getUserGoal       = (uid) => num(config.metasPorUsuario?.[uid] ?? config.metaMensal ?? config.meta ?? 0);
  const getUserCommission = (uid) => num(config.comissaoPorUsuario?.[uid] ?? config.comissaoPercentual ?? 0);

  // Pedidos visíveis no painel
  const pedidosAll = pedidos;
  let pedidosParaPainel = [];
  if (isAdminEmpresa) pedidosParaPainel = pedidosAll;
  if (isVendedor)     pedidosParaPainel = pedidosAll.filter(p => p.vendedorId === this.currentUser.id);

  // Faixa do mês atual
  const { first, last } = monthRange(new Date());

  // Pedidos do mês por createdAt/data
  const pedidosDoMes = pedidosParaPainel.filter(p => {
    const d = new Date(p.createdAt || p.data || Date.now());
    return d >= first && d <= last;
  });

  // Total do mês: usa pedido.total se existir; senão calcula pelo orçamento
  const orcPorId = Object.fromEntries(orcamentos.map(o => [o.id, o]));
  const somaItensOrc = (orc) => (orc?.items || orc?.itens || []).reduce((s,i)=> s + num(i.preco)*num(i.quantidade ?? i.qtd ?? 1), 0);
  const totalVendasMes = pedidosDoMes.reduce((acc, p) => {
    if (Number.isFinite(+p.total)) return acc + (+p.total);
    const orc = orcPorId[p.orcamentoId];
    return acc + somaItensOrc(orc);
  }, 0);

  // Meta/Comissão do usuário logado
  const meta = getUserGoal(this.currentUser.id);
  const comissaoRate = getUserCommission(this.currentUser.id);
  const comissao = totalVendasMes * comissaoRate;
  const metaPercentual = meta > 0 ? Math.min((totalVendasMes / meta) * 100, 100) : 0;

  // Alertas
  const estoqueBaixo = produtos.filter(p => num(p.estoque) <= num(p.estoqueMinimo, 5)).length;
  const aguardandoFornecedor = orcamentos.filter(o => o.status === 'pending_supplier').length;
  const validadeDias = num(config.validadeOrcamentoDias, 7);
  const vencidosWaiting = orcamentos.filter(o => {
    const status = o.status || 'pending'; // compat
    if (status !== 'waiting_customer') return false;
    const criado = new Date(o.createdAt || o.data || Date.now());
    return new Date() > addDays(criado, validadeDias);
  }).length;

  // helper: card "Meu Desempenho" (opcional para vendedor)
  const renderMeuDesempenho = () => {
    if (this.currentUser.role !== 'seller') return '';

    const meusPedidosMes = pedidosAll.filter(p => {
      const d = new Date(p.createdAt || p.data || Date.now());
      return p.vendedorId === this.currentUser.id && d >= first && d <= last;
    });

    const minhasVendas = meusPedidosMes.reduce((acc, p) => {
      if (Number.isFinite(+p.total)) return acc + (+p.total);
      const orc = orcPorId[p.orcamentoId];
      return acc + somaItensOrc(orc);
    }, 0);

    const metaUser = getUserGoal(this.currentUser.id);
    const comRate  = getUserCommission(this.currentUser.id); // fração
    const pct = metaUser > 0 ? Math.min(100, (minhasVendas / metaUser) * 100) : 0;
    const minhaComissao = minhasVendas * comRate;

    return `
      <div class="card">
        <h2><i class="fas fa-user-chart"></i> Meu Desempenho</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Meta do Mês</h3>
            <div class="stat-value">R$ ${metaUser.toFixed(2)}</div>
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <div>${pct.toFixed(1)}% atingido</div>
          </div>
          <div class="stat-card">
            <h3>Minhas Vendas</h3>
            <div class="stat-value">R$ ${minhasVendas.toFixed(2)}</div>
            <div>${meusPedidosMes.length} pedidos no mês</div>
          </div>
          <div class="stat-card">
            <h3>Minha Comissão</h3>
            <div class="stat-value">R$ ${minhaComissao.toFixed(2)}</div>
            <div>alíquota: ${(comRate*100).toFixed(1)}%</div>
          </div>
        </div>
      </div>

      

    `;
  };

  // Render
  dashboard.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card">
        <h3><i class="fas fa-bullseye"></i> Meta do Mês</h3>
        <div class="stat-value">R$ ${totalVendasMes.toFixed(2)} / R$ ${meta.toFixed(2)}</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${metaPercentual}%"></div>
        </div>
        <div>${metaPercentual.toFixed(1)}% atingido</div>
      </div>

      <div class="stat-card">
        <h3><i class="fas fa-hand-holding-usd"></i> Vendas (Mês)</h3>
        <div class="stat-value">R$ ${totalVendasMes.toFixed(2)}</div>
        <div>${pedidosDoMes.length} pedidos faturados</div>
      </div>

      <div class="stat-card">
        <h3><i class="fas fa-percentage"></i> Comissão</h3>
        <div class="stat-value">R$ ${comissao.toFixed(2)}</div>
        <div>alíquota: ${(comissaoRate*100).toFixed(1)}%</div>
      </div>

      <div class="stat-card">
        <h3><i class="fas fa-boxes"></i> Produtos</h3>
        <div class="stat-value">${produtos.length}</div>
        <div>${estoqueBaixo} com estoque baixo</div>
      </div>
    </div>

    <div class="card">
      <h2><i class="fas fa-exclamation-triangle"></i> Alertas Importantes</h2>
      <ul>
        ${estoqueBaixo ? `<li>${estoqueBaixo} produto(s) com estoque abaixo do mínimo</li>` : ''}
        ${aguardandoFornecedor ? `<li>${aguardandoFornecedor} orçamento(s) aguardando validação do fornecedor</li>` : ''}
        ${vencidosWaiting ? `<li>${vencidosWaiting} orçamento(s) vencidos (aguardando cliente &gt; ${validadeDias} dias)</li>` : ''}
        ${(!estoqueBaixo && !aguardandoFornecedor && !vencidosWaiting) ? '<li>Nenhum alerta importante no momento</li>' : ''}
      </ul>
    </div>

    ${ renderMeuDesempenho() }
  `;
}, // <— fecha o método loadDashboard


        // ==== Configurações da empresa ====

// Config Fiscal por empresa (opcional)
configFisco: {},

// Helper: garantir objeto de config fiscal
_getFiscalCfg(empresaId){
  const base = {
    enabled: false,             // liga/desliga emissão oficial
    provider: '',               // 'nfeio' | 'enotas' | 'plg' | 'focus' | etc.
    apiToken: '',               // token/secret do provedor
    ambiente: 'homolog',        // 'homolog' | 'producao'
    regime: 'mei',              // 'mei' | 'simples_nacional' | 'normal'
    certificadoA1: null,        // DataURL do .pfx (se o provedor exigir que você envie)
    certificadoSenha: '',       // senha do .pfx
    autoEmitOnApprove: true,    // se true, aprovar orçamento -> emitir NF-e
    // defaults tributários simples (podem ser refinados depois)
    cfopDentro: '5102',
    cfopFora: '6102',
    cst_csosn: '102',           // Simples: CSOSN; Regime normal: CST ICMS
    pisCofinsCumulativo: true   // simplificação inicial
  };
  this.configFisco[empresaId] ||= base;
  // merge não-destrutivo (caso venha de versões antigas)
  return Object.assign({}, base, this.configFisco[empresaId]);
},

// Persistência leve
_saveFiscalCfg(empresaId, cfg){
  this.configFisco[empresaId] = cfg;
  this.saveToStorage?.();
},


showCompanySettingsModal: function () {
  const empresaId = this.currentEmpresa?.id;
  if (!empresaId) { alert('Selecione/entre em uma empresa.'); return; }

  // garantir estrutura
  this.configuracoes = this.configuracoes || {};
  const cfg = this.configuracoes[empresaId] || {};

  // preencher campos gerais
  document.getElementById('cfg-meta-mensal').value = (cfg.metaMensal ?? cfg.meta ?? '') || '';
  // comissaoPercentual é fração; mostrar em %
  const comPerc = (typeof cfg.comissaoPercentual === 'number') ? (cfg.comissaoPercentual * 100) : '';
  document.getElementById('cfg-comissao-percent').value = comPerc;
  document.getElementById('cfg-validade-orc').value = (cfg.validadeOrcamentoDias ?? 7);

  // popular metas por usuário
  const metasWrap = document.getElementById('cfg-metas-por-usuario');
  metasWrap.innerHTML = '';
  const usuarios = (this.usuarios[empresaId] || []).filter(u => u.ativo !== false);
  usuarios.forEach(u => {
    const val = (cfg.metasPorUsuario && typeof cfg.metasPorUsuario[u.id] === 'number') ? cfg.metasPorUsuario[u.id] : '';
    const row = document.createElement('div');
    row.innerHTML = `
      <label style="display:flex;gap:8px;align-items:center">
        <span style="width:200px">${u.username} (${u.role})</span>
        <input type="number" step="0.01" data-user-meta="${u.id}" value="${val}" placeholder="R$">
      </label>
    `;
    metasWrap.appendChild(row);
  });

  // popular comissão por usuário (%)
  const comWrap = document.getElementById('cfg-comissao-por-usuario');
  comWrap.innerHTML = '';
  usuarios.forEach(u => {
    const valFrac = (cfg.comissaoPorUsuario && typeof cfg.comissaoPorUsuario[u.id] === 'number') ? cfg.comissaoPorUsuario[u.id] : '';
    const valPct = valFrac !== '' ? (valFrac * 100) : '';
    const row = document.createElement('div');
    row.innerHTML = `
      <label style="display:flex;gap:8px;align-items:center">
        <span style="width:200px">${u.username} (${u.role})</span>
        <input type="number" step="0.01" data-user-com="${u.id}" value="${valPct}" placeholder="%">
      </label>
    `;
    comWrap.appendChild(row);
  });

  // bind submit uma única vez
  const form = document.getElementById('company-settings-form');
  form.onsubmit = (ev) => {
    ev.preventDefault();
    this.saveCompanySettings();
  };

  document.getElementById('company-settings-modal').style.display = 'flex';
},

hideCompanySettingsModal: function () {
  document.getElementById('company-settings-modal').style.display = 'none';
},

saveCompanySettings: function () {
  const empresaId = this.currentEmpresa?.id;
  if (!empresaId) return;

  this.configuracoes = this.configuracoes || {};
  const cfg = this.configuracoes[empresaId] || {};

  // gerais
  const metaMensal = Number(document.getElementById('cfg-meta-mensal').value || 0);
  const comissaoPercent = Number(document.getElementById('cfg-comissao-percent').value || 0); // em %
  const validadeDias = parseInt(document.getElementById('cfg-validade-orc').value || '7', 10);

  cfg.metaMensal = Number.isFinite(metaMensal) ? metaMensal : 0;
  // salvar como FRAÇÃO (0.05)
  cfg.comissaoPercentual = Number.isFinite(comissaoPercent) ? (comissaoPercent / 100) : 0;
  cfg.validadeOrcamentoDias = Number.isFinite(validadeDias) ? validadeDias : 7;

  // metas por usuário
  const metasPorUsuario = {};
  document.querySelectorAll('input[data-user-meta]').forEach(inp => {
    const uid = Number(inp.getAttribute('data-user-meta'));
    const v = Number(inp.value);
    if (Number.isFinite(v) && v > 0) metasPorUsuario[uid] = v;
  });
  cfg.metasPorUsuario = metasPorUsuario;

  // comissão por usuário (em % → salvar como fração)
  const comissaoPorUsuario = {};
  document.querySelectorAll('input[data-user-com]').forEach(inp => {
    const uid = Number(inp.getAttribute('data-user-com'));
    const v = Number(inp.value);
    if (Number.isFinite(v) && v >= 0) comissaoPorUsuario[uid] = (v / 100);
  });
  cfg.comissaoPorUsuario = comissaoPorUsuario;

  // persistir
  this.configuracoes[empresaId] = cfg;
  try {
    localStorage.setItem('scp_configuracoes', JSON.stringify(this.configuracoes)),
    localStorage.setItem('scp_config_fisco', JSON.stringify(this.configFisco));

} catch (e) {}

  this.hideCompanySettingsModal();
  // recarregar dashboard para refletir as novas metas/comissão/validade
  this.loadDashboard();
},


        // Mostrar modal para adicionar empresa
        showAddCompanyModal: function() {
            this.currentEditingCompanyId = null;
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
// depois de calcular const isEdit e const q ...
const defaultDays = 5;
const daysCalc = (() => {
  try {
    if (!isEdit || !q?.validoAte || !q?.data) return defaultDays;
    const d0 = new Date(q.data);
    const d1 = new Date(q.validoAte);
    const diff = Math.ceil((d1 - d0) / (24*60*60*1000));
    return Math.max(1, diff || defaultDays);
  } catch { return defaultDays; }
})();


            modalTitle.innerHTML = '<i class="fas fa-plus"></i> Adicionar Empresa';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label for="company-name">Nome da Empresa:</label>
                    <input type="text" id="company-name" required>
                </div>
                <div class="form-group">
                    <label for="company-cnpj">CNPJ:</label>
                    <input type="text" id="company-cnpj" required>
                </div>

<div class="form-row" style="gap:1rem; margin-top:.75rem">
    <div class="form-group">
      <label>Validade (dias)</label>
      <input id="qt-valid-days" type="number" min="1" value="${daysCalc}">
    </div>

    <div class="form-group">
      <label>Válido até</label>
      <input id="qt-valid" type="date" value="${new Date(q.validoAte || new Date(Date.now()+defaultDays*86400000).toISOString()).toISOString().slice(0,10)}">
    </div>
  </div>


  
                <div class="form-group">
                    <label for="company-email">E-mail:</label>
                    <input type="email" id="company-email" required>
                </div>
                <div class="form-group">
                    <label for="company-phone">Telefone:</label>
                    <input type="text" id="company-phone" required>
                </div>
                <div class="form-group">
                    <label for="company-address">Endereço:</label>
                    <input type="text" id="company-address" required>
                </div>
                <div class="form-group">
                    <label for="company-plan">Plano:</label>
                    <select id="company-plan" required>
                        <option value="basic">Básico (até 5 usuários e 300 produtos)</option>
                        <option value="premium">Premium (ilimitado)</option>
                        <option value="trial">Trial (7 dias gratuitos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="admin-username">Usuário Admin:</label>
                    <input type="text" id="admin-username" required>
                </div>
                <div class="form-group">
                    <label for="admin-email">E-mail Admin:</label>
                    <input type="email" id="admin-email" required>
                </div>
                <div class="form-group">
                    <label for="admin-password">Senha Admin:</label>
                    <input type="password" id="admin-password" required>
                </div>
                <button class="btn btn-secondary" onclick="SystemControlPro.showCompanySettingsModal()" style="margin:8px 0;">
  <i class="fas fa-cog"></i> Configurações da Empresa
</button>
            `;
            
            document.getElementById('form-modal').style.display = 'flex';
       
       
       
       
       
          },
        
        // Mostrar modal para editar empresa
        showEditCompanyModal: function(companyId) {
            this.currentEditingCompanyId = companyId;
            const empresa = this.empresas.find(e => e.id === companyId);
            
            if (!empresa) {
                this.showToast('Empresa não encontrada', 'error');
                return;
            }
            
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.innerHTML = '<i class="fas fa-edit"></i> Editar Empresa';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label for="company-name">Nome da Empresa:</label>
                    <input type="text" id="company-name" value="${empresa.nome}" required>
                </div>
                <div class="form-group">
                    <label for="company-cnpj">CNPJ:</label>
                    <input type="text" id="company-cnpj" value="${empresa.cnpj}" required>
                </div>
                <div class="form-group">
                    <label for="company-email">E-mail:</label>
                    <input type="email" id="company-email" value="${empresa.email}" required>
                </div>
                <div class="form-group">
                    <label for="company-phone">Telefone:</label>
                    <input type="text" id="company-phone" value="${empresa.telefone}" required>
                </div>
                <div class="form-group">
                    <label for="company-address">Endereço:</label>
                    <input type="text" id="company-address" value="${empresa.endereco}" required>
                </div>
                <div class="form-group">
                    <label for="company-plan">Plano:</label>
                    <select id="company-plan" required>
                        <option value="basic" ${empresa.plano === 'basic' ? 'selected' : ''}>Básico (até 5 usuários e 300 produtos)</option>
                        <option value="premium" ${empresa.plano === 'premium' ? 'selected' : ''}>Premium (ilimitado)</option>
                        <option value="trial" ${empresa.plano === 'trial' ? 'selected' : ''}>Trial (7 dias gratuitos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="company-status">Status:</label>
                    <select id="company-status" required>
                        <option value="active" ${empresa.status === 'active' ? 'selected' : ''}>Ativa</option>
                        <option value="inactive" ${empresa.status === 'inactive' ? 'selected' : ''}>Inativa</option>
                        <option value="trial" ${empresa.status === 'trial' ? 'selected' : ''}>Trial</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="SystemControlPro.saveCompany()">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            `;
            
            document.getElementById('form-modal').style.display = 'flex';
        },
        
        // Salvar empresa
        saveCompany: function() {
            const name = document.getElementById('company-name').value;
            const cnpj = document.getElementById('company-cnpj').value;
            const email = document.getElementById('company-email').value;
            const phone = document.getElementById('company-phone').value;
            const address = document.getElementById('company-address').value;
            const plan = document.getElementById('company-plan').value;
            
            if (!name || !cnpj || !email || !phone || !address) {
                this.showToast('Preencha todos os campos', 'error');
                return;
            }
            
            if (this.currentEditingCompanyId) {
                // Modo edição
                const empresaIndex = this.empresas.findIndex(e => e.id === this.currentEditingCompanyId);
                if (empresaIndex === -1) {
                    this.showToast('Empresa não encontrada', 'error');
                    return;
                }
                
                const status = document.getElementById('company-status').value;
                
                this.empresas[empresaIndex] = {
                    ...this.empresas[empresaIndex],
                    nome: name,
                    cnpj: cnpj,
                    email: email,
                    telefone: phone,
                    endereco: address,
                    plano: plan,
                    status: status
                };
                
                this.saveToStorage();
                this.closeModal('form-modal');
                this.loadAdmin();
                this.showToast('Empresa atualizada com sucesso!', 'success');
            } else {
                // Modo criação
                const adminUsername = document.getElementById('admin-username').value;
                const adminEmail = document.getElementById('admin-email').value;
                const adminPassword = document.getElementById('admin-password').value;
                
                if (!adminUsername || !adminEmail || !adminPassword) {
                    this.showToast('Preencha todos os campos do administrador', 'error');
                    return;
                }
                
                const newCompany = {
                    id: Date.now(),
                    codigo: String(Date.now()).slice(-4),
                    nome: name,
                    cnpj: cnpj,
                    email: email,
                    telefone: phone,
                    endereco: address,
                    plano: plan,
                    dataCriacao: new Date().toISOString(),
                    status: plan === 'trial' ? 'trial' : 'active',
                    logo: null
                };
                
                this.empresas.push(newCompany);
                
                // Criar usuário admin para a nova empresa
                this.usuarios[newCompany.id] = [
                    {
                        id: 1,
                        username: adminUsername,
                        password: adminPassword,
                        name: 'Administrador',
                        role: 'admin',
                        email: adminEmail,
                        permissions: ['all'],
                        status: 'active'
                    }
                ];
                
                // Inicializar arrays vazios para os dados da empresa
                this.produtos[newCompany.id] = [];
                this.clientes[newCompany.id] = [];
                this.orcamentos[newCompany.id] = [];
                this.pedidos[newCompany.id] = [];
                
                // Configurações padrão
                this.configuracoes[newCompany.id] = {
                    empresaId: newCompany.id,
                    metaMensal: 100000,
                    comissaoPercentual: 3,
                    metasPorUsuario: {},
                    comissaoPorUsuario: {}
                };
                
                this.saveToStorage();
                this.closeModal('form-modal');
                this.loadAdmin();
                this.showToast('Empresa adicionada com sucesso!', 'success');
            }
        },
        
        // Editar empresa
        editCompany: function(companyId) {
            this.showEditCompanyModal(companyId);
        },
        
        // Excluir empresa
        deleteCompany: function(companyId) {
            this.showConfirmModal(
                'Excluir Empresa',
                'Tem certeza que deseja excluir esta empresa? Todos os dados serão perdidos.',
                () => {
                    this.empresas = this.empresas.filter(e => e.id !== companyId);
                    delete this.usuarios[companyId];
                    delete this.produtos[companyId];
                    delete this.clientes[companyId];
                    delete this.orcamentos[companyId];
                    delete this.pedidos[companyId];
                    delete this.configuracoes[companyId];
                    this.saveToStorage();
                    this.loadAdmin();
                    this.showToast('Empresa excluída com sucesso!', 'success');
                }
            );
        },
        
        // Manipular logout
        handleLogout: function() {
            // Limpar timers
            if (this.inactivityTimer) clearTimeout(this.inactivityTimer);
            if (this.heartbeatInterval) clearInterval(this.heartbeatInterval);
            
            this.clearSession();
			this.logAction('logout', {}); // ADICIONE ESTA LINHA
			
            this.currentUser = null;
            this.currentEmpresa = null;
            
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            
            document.getElementById('login-form').reset();
            
            this.showToast('Logout realizado com sucesso', 'success');
        },
        
        // Alternar tema
        toggleTheme: function() {
            const themes = ['theme-gray', 'theme-pink', 'theme-blue', 'theme-green'];
            const currentTheme = document.body.className;
            let currentIndex = themes.indexOf(currentTheme);
            
            if (currentIndex === -1) currentIndex = 0;
            
            const nextIndex = (currentIndex + 1) % themes.length;
document.body.className = themes[nextIndex];
localStorage.setItem('scp_theme', themes[nextIndex]);  // <<< ADICIONE ESTA LINHA

this.showToast(`Tema alterado para ${themes[nextIndex].replace('theme-', '')}`, 'info');
        },
        
        // Mostrar toast de notificação
        showToast: function(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const icon = toast.querySelector('i');
            
            toastMessage.textContent = message;
            toast.className = 'toast show ' + type;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            } else if (type === 'info') {
                icon.className = 'fas fa-info-circle';
            }
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        },
        
		        logAction: function(action, details = {}){
            const entry = {
                ts: Date.now(),
                userId: this.currentUser?.id ?? null,
                userName: this.currentUser?.name ?? this.currentUser?.username ?? 'desconhecido',
                role: this.currentUser?.role ?? 'unknown',
                empresaId: this.currentEmpresa?.id ?? null,
                empresaNome: this.currentEmpresa?.nome ?? null,
                action,
                details
            };

            // persistir junto do data principal
            this.auditLogs.push(entry);
            // espelha no storage principal
            const saved = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
            saved._auditLogs = saved._auditLogs || [];
            saved._auditLogs.push(entry);
            localStorage.setItem('systemControlPro_data', JSON.stringify(saved));
        },
		
		
		
		
        // Fechar modal
        closeModal: function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        },
        
        // Mostrar modal de confirmação
        showConfirmModal: function(title, message, callback) {
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-button').onclick = callback;
            document.getElementById('confirm-modal').style.display = 'flex';
        },
        
        // ===== CLIENTES =====
        loadCustomers: function () {
            const empresaId = this.currentEmpresa?.id;
            if (!empresaId) { document.getElementById('customers').innerHTML = ''; return; }

            const cls = (this.clientes[empresaId] || []);
            const rows = cls.map(c => `
                <tr>
                    <td>${c.nome}</td>
                    <td>${c.email || '-'}</td>
                    <td>${c.telefone || '-'}</td>
                    <td>${new Date(c.dataCadastro).toLocaleDateString()}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="SystemControlPro.showCustomerForm(${c.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="SystemControlPro.deleteCustomer(${c.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('customers').innerHTML = `
                <div class="card">
                    <h2><i class="fas fa-users"></i> Gerenciamento de Clientes</h2>
                    <div style="display:flex; gap:1rem; flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="SystemControlPro.showCustomerForm()">
                            <i class="fas fa-plus"></i> Adicionar Cliente
                        </button>
                        <input id="cust-search" type="text" placeholder="Buscar cliente..." style="flex:1;min-width:240px">
                    </div>
                    <table style="margin-top:1rem">
                        <thead>
                            <tr><th>Nome</th><th>E-mail</th><th>Telefone</th><th>Cadastro</th><th>Ações</th></tr>
                        </thead>
                        <tbody id="cust-tbody">${rows}</tbody>
                    </table>
                </div>
            `;

            document.getElementById('cust-search').oninput = (e)=>{
                const q = e.target.value.toLowerCase();
                document.querySelectorAll('#cust-tbody tr').forEach(r=>{
                    r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
                });
            };
        },

        showCustomerForm: function(id = null) {
            const empresaId = this.currentEmpresa.id;
            this.clientes[empresaId] = this.clientes[empresaId] || [];
            const isEdit = !!id;

         




            const c = isEdit
                ? this.clientes[empresaId].find(x => x.id === id)
                : { id: Date.now(), nome:'', email:'', telefone:'', cpfCnpj:'', endereco:'', dataCadastro:new Date().toISOString(), status:'active' };

            const modalTitle = document.getElementById('modal-title');
            const modalBody  = document.getElementById('modal-body');
            modalTitle.innerHTML = `${isEdit ? '<i class="fas fa-edit"></i> Editar' : '<i class="fas fa-plus"></i> Novo'} Cliente`;

            modalBody.innerHTML = `
                <div class="form-row">
                    <div class="form-group"><label>Nome</label><input id="c-nome" value="${c.nome}" required></div>
                    <div class="form-group"><label>E-mail</label><input id="c-email" value="${c.email || ''}" type="email"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Telefone</label><input id="c-tel" value="${c.telefone || ''}"></div>
                    <div class="form-group"><label>CPF/CNPJ</label><input id="c-doc" value="${c.cpfCnpj || ''}"></div>
                </div>
                <div class="form-group"><label>Endereço</label><input id="c-end" value="${c.endereco || ''}"></div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="c-status">
                        <option value="active" ${c.status==='active'?'selected':''}>Ativo</option>
                        <option value="inactive" ${c.status==='inactive'?'selected':''}>Inativo</option>
                    </select>
                </div>
                <div style="display:flex; gap:1rem; margin-top:1rem">
                    <button class="btn btn-primary" onclick="SystemControlPro.saveCustomerFromModal(${isEdit ? c.id : 'null'})"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn btn-secondary" onclick="SystemControlPro.closeModal('form-modal')">Cancelar</button>
                </div>
            `;
            document.getElementById('form-modal').style.display = 'flex';
        },

        saveCustomerFromModal: function(id = null) {
            const empresaId = this.currentEmpresa.id;
            this.clientes[empresaId] = this.clientes[empresaId] || [];

            const data = {
                id: id ?? Date.now(),
                nome: document.getElementById('c-nome').value.trim(),
                email: document.getElementById('c-email').value.trim(),
                telefone: document.getElementById('c-tel').value.trim(),
                cpfCnpj: document.getElementById('c-doc').value.trim(),
                endereco: document.getElementById('c-end').value.trim(),
                dataCadastro: new Date().toISOString(),
                status: document.getElementById('c-status').value
            };

            if (!data.nome) { this.showToast('Informe o nome do cliente', 'error'); return; }

            const idx = this.clientes[empresaId].findIndex(c => c.id === data.id);
if (idx >= 0) {
  this.clientes[empresaId][idx] = {
    ...this.clientes[empresaId][idx],
    ...data
  };
} else {
  this.clientes[empresaId].push(data);
}
            this.saveToStorage();
			this.logAction('customer.save', { id: data.id, nome: data.nome }); // ADICIONE ESTA LINHA
            this.closeModal('form-modal');
            this.loadCustomers();
            this.showToast('Cliente salvo com sucesso!', 'success');
        },

        deleteCustomer: function(id){
            const empresaId = this.currentEmpresa.id;
            this.showConfirmModal('Excluir cliente', 'Confirma excluir este cliente?', ()=>{
                this.clientes[empresaId] = (this.clientes[empresaId] || []).filter(c => c.id !== id);
                this.logAction('customer.delete', { id: id }); // ADICIONE ESTA LINHA
				this.saveToStorage();
                this.loadCustomers();
                this.closeModal('confirm-modal');
                this.showToast('Cliente excluído.', 'success');
            });
        },

        // ===== PRODUTOS =====
        loadProducts: function () {
            const empresaId = this.currentEmpresa?.id;
            if (!empresaId) { document.getElementById('products').innerHTML = ''; return; }

            const list = (this.produtos[empresaId] || []).map(p => `
                <tr>
                    <td>${p.nome}</td>
                    <td>${p.categoria}</td>
                    <td>R$ ${p.preco.toFixed(2)}</td>
                    <td>${p.estoque}</td>
                    <td>${p.status === 'active' ? 'Ativo' : 'Inativo'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="SystemControlPro.showProductForm(${p.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="SystemControlPro.deleteProduct(${p.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('products').innerHTML = `
                <div class="card">
                    <h2><i class="fas fa-box"></i> Gerenciamento de Produtos</h2>
                    <div style="display:flex; gap:1rem; flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="SystemControlPro.showProductForm()">
                            <i class="fas fa-plus"></i> Adicionar Produto
                        </button>
                        <input id="prod-search" type="text" placeholder="Buscar produto..." style="flex:1;min-width:240px">
                    </div>
                    <table style="margin-top: 1rem;">
                        <thead>
                            <tr>
                                <th>Nome</th><th>Categoria</th><th>Preço</th><th>Estoque</th><th>Status</th><th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="prod-tbody">${list}</tbody>
                    </table>
                </div>
            `;

            // filtro simples
            const search = document.getElementById('prod-search');
            search.oninput = () => {
                const q = search.value.toLowerCase();
                const rows = document.querySelectorAll('#prod-tbody tr');
                rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
            };
        },

        // abre modal para criar/editar produto
        showProductForm: function (id = null) {
            const empresaId = this.currentEmpresa.id;
            const isEdit = !!id;
            const produto = isEdit ? (this.produtos[empresaId] || []).find(p => p.id === id) : {
                id: Date.now(), nome:'', categoria:'', preco:0, custo:0, estoque:0, estoqueMinimo:0, codigo:'', status:'active', image: null
            };

            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            modalTitle.innerHTML = `${isEdit ? '<i class="fas fa-edit"></i> Editar' : '<i class="fas fa-plus"></i> Novo'} Produto`;

            modalBody.innerHTML = `
                <div class="form-row">
                    <div class="form-group"><label>Nome</label>
                        <input id="p-nome" value="${produto.nome}" required></div>
                    <div class="form-group"><label>Categoria</label>
                        <input id="p-cat" value="${produto.categoria}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Preço (R$)</label>
                        <input id="p-preco" type="number" step="0.01" value="${produto.preco}"></div>
                    <div class="form-group"><label>Custo (R$)</label>
                        <input id="p-custo" type="number" step="0.01" value="${produto.custo}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Estoque</label>
                        <input id="p-estoque" type="number" value="${produto.estoque}"></div>
                    <div class="form-group"><label>Estoque mínimo</label>
                        <input id="p-min" type="number" value="${produto.estoqueMinimo}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Código/SKU</label>
                        <input id="p-codigo" value="${produto.codigo}"></div>
                    <div class="form-group"><label>Status</label>
                        <select id="p-status">
                            <option value="active" ${produto.status==='active'?'selected':''}>Ativo</option>
                            <option value="inactive" ${produto.status==='inactive'?'selected':''}>Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Imagem do Produto</label>
                    <input type="file" id="p-image" accept="image/*">
                    ${produto.image ? `
                        <div style="margin-top: 10px;">
                            <img src="${produto.image}" alt="Preview" style="max-width: 100px; max-height: 100px;">
                        </div>
                    ` : ''}
                </div>
                <div style="display:flex; gap:1rem; margin-top:1rem">
                    <button class="btn btn-primary" onclick="SystemControlPro.saveProductFromModal(${isEdit ? produto.id : 'null'})">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button class="btn btn-secondary" onclick="SystemControlPro.closeModal('form-modal')">Cancelar</button>
                </div>
            `;

            document.getElementById('form-modal').style.display = 'flex';
        },


        saveProductFromModal: function (id = null) {
  // torna robusto caso o template passe a string 'null'
  if (id === 'null' || typeof id === 'undefined') id = null;

  const empresaId = this.currentEmpresa.id;
  this.produtos[empresaId] = this.produtos[empresaId] || [];

  const data = {
    id: id ?? Date.now(),
    nome: (document.getElementById('p-nome')?.value || '').trim(),
    categoria: (document.getElementById('p-cat')?.value || '').trim(),
    preco: Number(document.getElementById('p-preco')?.value || 0),
    custo: Number(document.getElementById('p-custo')?.value || 0),
    estoque: parseInt(document.getElementById('p-estoque')?.value || 0),
    estoqueMinimo: parseInt(document.getElementById('p-min')?.value || 0),
    codigo: (document.getElementById('p-codigo')?.value || '').trim(),
    status: (document.getElementById('p-status')?.value || 'active'),
    image: null
  };

  if (!data.nome) { this.showToast('Informe o nome do produto', 'error'); return; }
  if (data.preco < 0 || data.estoque < 0 || data.estoqueMinimo < 0) {
    this.showToast('Valores negativos não são permitidos', 'error');
    return;
  }

  // imagem (se enviada)
  const imageInput = document.getElementById('p-image');
  if (imageInput && imageInput.files && imageInput.files.length > 0) {
    const file = imageInput.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
      data.image = e.target.result;
      this.finalizeProductSave(data, empresaId, id);
    };
    reader.readAsDataURL(file);
  } else {
    // mantendo imagem existente quando editar sem trocar
    if (id) {
      const existing = this.produtos[empresaId].find(p => String(p.id) === String(id));
      if (existing) data.image = existing.image;
    }
    this.finalizeProductSave(data, empresaId, id);
  }
},


        saveOrderFromModal: function(orderId = null) {
  if (!this.currentEmpresa) return;
  const empresaId = this.currentEmpresa.id;
  this.pedidos[empresaId] = this.pedidos[empresaId] || [];

  const isEdit = !!orderId;
  const old = isEdit ? this.pedidos[empresaId].find(p => p.id === orderId) : null;

  const clienteId = parseInt(document.getElementById('ord-cliente').value);
  const cli = (this.clientes[empresaId] || []).find(c => c.id === clienteId);
  const desc = Number(document.getElementById('ord-desc').value || 0);
  const pg   = document.getElementById('ord-pg').value;

  // === 1) coletar itens do formulário ===
  // Assumindo que você cria linhas com selects/inputs e a função abaixo já existe:
  const itens = this._collectOrderItemsFromDOM
    ? this._collectOrderItemsFromDOM()
    : Array.from(document.querySelectorAll('#ord-itens .order-item-row')).map(row=>{
        const pid  = parseInt(row.querySelector('.ord-prod')?.value);
        const qnt  = Number(row.querySelector('.ord-qtd')?.value || 0);
        const prec = Number(row.querySelector('.ord-preco')?.value || 0);
        const tot  = qnt * prec;
        return { produtoId: pid, quantidade: qnt, preco: prec, total: tot };
      });

  // === 2) se for edição, devolve estoque dos itens antigos antes de checar ===
  if (isEdit && old?.items?.length) {
    old.items.forEach(it=>{
      const p = (this.produtos[empresaId]||[]).find(x=>x.id===it.produtoId);
      if (p) p.estoque += it.quantidade;
    });
  }

  // === 3) checar estoque pros novos itens ===
  for (const it of itens) {
    const p = (this.produtos[empresaId] || []).find(x => x.id === it.produtoId);
    if (!p || p.estoque < it.quantidade) {
      this.showToast(`Estoque insuficiente para ${p?.nome || 'produto'}.`, 'error');
      // rollback: se era edição, volta a baixar o que devolvemos
      if (isEdit && old?.items?.length) {
        old.items.forEach(it2=>{
          const p2 = (this.produtos[empresaId]||[]).find(x=>x.id===it2.produtoId);
          if (p2) p2.estoque -= it2.quantidade;
        });
      }
      return;
    }
  }

  // === 4) baixar estoque com os novos itens ===
  itens.forEach(it=>{
    const p = (this.produtos[empresaId]||[]).find(x=>x.id===it.produtoId);
    if (p) p.estoque -= it.quantidade;
  });

  // === 5) totais ===
  const subtotal = itens.reduce((a,b)=>a + (Number(b.total)||0), 0);
  const total    = subtotal - desc;

  // === 6) salvar ===
  if (isEdit) {
    Object.assign(old, {
      clienteId: cli?.id, clienteNome: cli?.nome,
      items: itens,
      subtotal, desconto: desc, total,
      pagamento: pg,
      updatedAt: new Date().toISOString()
    });
  } else {
    this.pedidos[empresaId].push({
      id: Date.now(),
      data: new Date().toISOString(),
      clienteId: cli?.id, clienteNome: cli?.nome,
      items: itens,
      subtotal, desconto: desc, total,
      pagamento: pg,
      status: 'pending',
      vendedorId: this.currentUser?.id || null
    });
  }

  this.saveToStorage?.();
  this.closeModal?.('form-modal');
  this.loadOrders?.();
  this.loadProducts?.();
  this.showToast(isEdit ? 'Pedido atualizado!' : 'Pedido criado!', 'success');
},

        finalizeProductSave: function(data, empresaId, id) {
            const idx = this.produtos[empresaId].findIndex(p => p.id === data.id);
            if (idx >= 0) this.produtos[empresaId][idx] = data; else this.produtos[empresaId].push(data);
            
			
			
            this.saveToStorage();
			
			this.logAction('product.save', { id: data.id, nome: data.nome }); // ADICIONE ESTA LINHA
			
            this.closeModal('form-modal');
            this.loadProducts();
            this.showToast('Produto salvo com sucesso!', 'success');
        },

        deleteProduct: function (id) {
            const empresaId = this.currentEmpresa.id;
            this.showConfirmModal('Excluir produto', 'Confirma excluir este produto?', () => {
                this.produtos[empresaId] = (this.produtos[empresaId] || []).filter(p => p.id !== id);
				
                this.logAction('product.delete', { id: id }); // ADICIONE ESTA LINHA
                this.saveToStorage();
                this.loadProducts();
                this.closeModal('confirm-modal');
                this.showToast('Produto excluído.', 'success');
            });
        },

        // === Helpers de orçamento (cole dentro do objeto SystemControlPro) ===
_sumBudget: function (orc) {
  const itens = (orc?.itens || orc?.items || []);
  return itens.reduce((acc, i) => {
    const preco = Number(i.preco ?? i.price ?? 0);
    const qtd   = Number(i.qtd ?? i.quantidade ?? i.qty ?? 1);
    return acc + preco * qtd;
  }, 0);
}, 


        // ===== ORÇAMENTOS =====
loadQuotes: function() {
  const empresaId = this.currentEmpresa?.id;
  const host = document.getElementById('quotes');
  if (!empresaId || !host) { if (host) host.innerHTML=''; return; }

  const orcs = (this.orcamentos[empresaId] || []);
  // mais recentes primeiro
  const data = [...orcs].sort((a,b) =>
  new Date(b.createdAt || b.data || 0) - new Date(a.createdAt || a.data || 0)
);

  const rows = data.map(o => {
    const itens = (o.itens || o.items || []);
    const precisaConf = itens.some(i => i.needsPriceConfirm === true || ['margin','consult'].includes(i.pricePolicy));
    const dt = new Date(o.createdAt || o.data || Date.now()).toLocaleString();
    const status = o.status || 'pending_supplier';

    // botões por status (fluxo: pending_supplier -> waiting_customer -> approved -> invoiced)
    const btns = [
   `<button class="btn btn-secondary" onclick="SystemControlPro.openQuote(${o.id})">Abrir</button>`,
   // NOVO: editar orçamento no mesmo modal
   `<button class="btn btn-primary" onclick="SystemControlPro.showQuoteForm(${o.id})">Editar</button>`
 ];
    if (status === 'pending_supplier') {
      btns.push(`<button class="btn btn-success" onclick="SystemControlPro.openValidateModal(${o.id})">Validar</button>`);
    }
    if (status === 'waiting_customer' || status === 'pending') {
  btns.push(`<button class="btn btn-success" onclick="SystemControlPro.approveQuote(${o.id})">Aprovar</button>`);
}
    // se quiser manter ações antigas, acrescente aqui mais botões

    return `
      <tr>
        <td>#${o.id}</td>
        <td>${dt}</td>
        <td>${itens.length}</td>
        <td>${precisaConf ? 'Sim' : 'Não'}</td>
        <td>${status}</td>
        <td class="action-buttons" style="display:flex;gap:6px;flex-wrap:wrap">
          ${btns.join('')}
        </td>
      </tr>
    `;
  }).join('');

  host.innerHTML = `
    <div class="card">
      <h2><i class="fas fa-file-invoice-dollar"></i> Orçamentos</h2>


<!-- NOVO: botão para vendedor criar orçamento manual -->
    <div style="margin: .5rem 0 1rem 0; display:flex; gap:.5rem; flex-wrap:wrap">
      <button class="btn btn-primary" onclick="SystemControlPro.showQuoteForm()">
        <i class="fas fa-plus"></i> Novo Orçamento
      </button>
    </div>
 

      <div class="table-container">
        <table id="quotes-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Data</th>
              <th>Itens</th>
              <th>Precisa Conf.</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>
  `;
},
         
        openQuote: function (orcId) {
  const empresaId = this.currentEmpresa?.id;
  const o = (this.orcamentos[empresaId] || []).find(x => x.id === orcId);
  if (!o) return alert('Orçamento não encontrado.');
  const total = this._sumBudget(o).toFixed(2);
  alert(`Orçamento #${o.id}\nStatus: ${o.status || 'pending_supplier'}\nItens: ${(o.itens||o.items||[]).length}\nTotal: R$ ${total}`);
},

// ---- Validação com fornecedor ----
_openValidateState: { orc: null, ajustes: {} },

openValidateModal: function (orcId) {
  const empresaId = this.currentEmpresa?.id;
  const o = (this.orcamentos[empresaId] || []).find(x => x.id === orcId);
  if (!o) return alert('Orçamento não encontrado.');

  this._openValidateState = { orc: JSON.parse(JSON.stringify(o)), ajustes: {} };

  document.getElementById('qv-info').textContent =
    `Orçamento #${o.id} — ${new Date(o.createdAt || o.data || Date.now()).toLocaleString()}`;

  const box = document.getElementById('qv-items');
  const itens = (o.itens || o.items || []);
  box.innerHTML = itens.map(i => {
    const contrato = i.pricePolicy === 'contract';
    const readonly = contrato ? 'readonly' : '';
    const hint = contrato ? ' (contrato — preço fixo)' : ' (ajustável)';
    return `
      <div style="display:flex;gap:10px;align-items:center;margin:6px 0">
        <span style="width:110px">Prod ${i.produtoId}</span>
        <span>Qtd ${i.qtd ?? i.quantidade ?? 1}</span>
        <span>Preço atual: R$ ${Number(i.preco||0).toFixed(2)}</span>
        <label>Novo preço:
          <input type="number" step="0.01" data-pid="${i.produtoId}" ${readonly} style="width:120px">
        </label>
        <small>${hint}</small>
      </div>
    `;
  }).join('');

  Array.from(box.querySelectorAll('input[data-pid]')).forEach(inp => {
    inp.addEventListener('input', e => {
      const pid = Number(e.target.getAttribute('data-pid'));
      this._openValidateState.ajustes[pid] = Number(e.target.value || 0);
    });
  });

  document.getElementById('quote-validate-modal').style.display = 'flex';
},

closeValidateModal: function () {
  document.getElementById('quote-validate-modal').style.display = 'none';
  this._openValidateState = { orc: null, ajustes: {} };
},

confirmValidateQuote: function () {
  const empresaId = this.currentEmpresa?.id;
  const state = this._openValidateState;
  if (!empresaId || !state.orc) return;

  const orcs = this.orcamentos[empresaId] || [];
  const idx = orcs.findIndex(o => o.id === state.orc.id);
  if (idx < 0) { this.closeValidateModal(); return; }

  // aplica ajustes só em margin/consult
  const itens = (orcs[idx].itens || orcs[idx].items || []);
  itens.forEach(i => {
    if (['margin','consult'].includes(i.pricePolicy)) {
      const novo = state.ajustes[i.produtoId];
      if (Number.isFinite(novo) && novo > 0) i.preco = Number(novo);
    }
  });

  // status -> waiting_customer
  orcs[idx].status = 'waiting_customer';
  this.orcamentos[empresaId] = orcs;
  try { localStorage.setItem('scp_orcamentos', JSON.stringify(this.orcamentos)); } catch(e){}

  this.closeValidateModal();
  this.showToast?.('Orçamento validado e enviado ao cliente.', 'success');
  this.loadQuotes();
  this.loadDashboard?.();
},


_fallbackInvoice: function(pedido){
  this.generateInvoice(pedido).then(nf=>{
    const anexos = [];
    if (nf?.pdfDataUrl) anexos.push({
      name: `NF_${pedido.numero}.pdf`,
      type: 'application/pdf',
      dataUrl: nf.pdfDataUrl
    });
    if (nf?.xmlContent) anexos.push({
      name: `NF_${pedido.numero}.xml`,
      type: 'application/xml',
      dataUrl: 'data:application/xml;base64,' + btoa(unescape(encodeURIComponent(nf.xmlContent)))
    });
    this._autoReportInvoice(pedido, anexos);
  });
},



// ---- Aprovação -> pedido + NF ----
// ---- Aprovação -> pedido + NF ----
approveQuote: function (orcId) {
  const empresaId = this.currentEmpresa?.id;
  if (!empresaId) return;

  const orcs = this.orcamentos[empresaId] || [];
  const idx = orcs.findIndex(o => o.id === orcId);
  if (idx < 0) return alert('Orçamento não encontrado.');

  // aprova
  orcs[idx].status = 'approved';
  this.orcamentos[empresaId] = orcs;

  // cria pedido
  this.pedidos[empresaId] = this.pedidos[empresaId] || [];
  const numero = `P${String(Date.now()).slice(-6)}`;
  const pedido = {
    id: this._nextId?.('pedidos', empresaId) ?? Date.now(),
    empresaId,
    orcamentoId: orcId,
    numero,
    createdAt: new Date().toISOString(),
    total: this._sumBudget(orcs[idx]),
    // (se tiver cliente/itens disponíveis, inclua aqui também)
    clienteId: orcs[idx].clienteId,
    clienteNome: orcs[idx].clienteNome,
    items: (orcs[idx].items || []).map(it => ({ ...it }))
  };
  this.pedidos[empresaId].push(pedido);

 // ==================== [FISCAL] Tentar emissão oficial ====================
const fx = (this._getFiscalCfg?.(empresaId)) || (window.SCP?._getFiscalCfg?.(empresaId));
if (fx?.enabled && fx?.autoEmitOnApprove && this.emitOfficialNFe) {
  this.emitOfficialNFe(pedido).then(ret => {
    if (ret?.ok) {
      const anexosNF = [];
      if (ret.pdfUrl || ret.pdfDataUrl) {
        anexosNF.push({
          name: `DANFE_${pedido.numero || pedido.id}.pdf`,
          type: 'application/pdf',
          dataUrl: ret.pdfDataUrl || ret.pdfUrl
        });
      }
      if (ret.xml || ret.xmlDataUrl) {
        anexosNF.push({
          name: `NFe_${pedido.numero || pedido.id}.xml`,
          type: 'application/xml',
          dataUrl: ret.xmlDataUrl || ('data:application/xml;base64,' + btoa(unescape(encodeURIComponent(ret.xml))))
        });
      }
      this._autoReportInvoice?.(pedido, anexosNF);
      this.showToast?.(`NF-e emitida (${ret.chaveAcesso?.slice(0,8)}...)`, 'success');
    } else {
      this.showToast?.('Não foi possível emitir NF-e agora. Comprovante interno gerado.', 'warning');
      this._calcTributosInternos?.(pedido);
      this.generateInvoice?.(pedido).then(nf => {
        const anexos = [];
        if (nf?.pdfDataUrl) anexos.push({
          name: `NF_${pedido.numero || pedido.id}.pdf`,
          type: 'application/pdf',
          dataUrl: nf.pdfDataUrl
        });
        if (nf?.xmlContent) anexos.push({
          name: `NF_${pedido.numero || pedido.id}.xml`,
          type: 'application/xml',
          dataUrl: 'data:application/xml;base64,' + btoa(unescape(encodeURIComponent(nf.xmlContent)))
        });
        this._autoReportInvoice?.(pedido, anexos);
        try {
          const pdf = anexos.find(a => a.type === 'application/pdf');
          if (pdf?.dataUrl) {
            const a = document.createElement('a');
            a.href = pdf.dataUrl; a.download = pdf.name;
            document.body.appendChild(a); a.click(); a.remove();
          }
        } catch (e) {}
      });
    }
  }).catch(() => {
    this.showToast?.('Erro na tentativa de emissão oficial. Comprovante interno gerado.', 'warning');
    this.generateInvoice?.(pedido).then(nf => {
      const anexos = [];
      if (nf?.pdfDataUrl) anexos.push({
        name: `NF_${pedido.numero || pedido.id}.pdf`,
        type: 'application/pdf',
        dataUrl: nf.pdfDataUrl
      });
      if (nf?.xmlContent) anexos.push({
        name: `NF_${pedido.numero || pedido.id}.xml`,
        type: 'application/xml',
        dataUrl: 'data:application/xml;base64,' + btoa(unescape(encodeURIComponent(nf.xmlContent)))
      });
      this._autoReportInvoice?.(pedido, anexos);
      try {
        const pdf = anexos.find(a => a.type === 'application/pdf');
        if (pdf?.dataUrl) {
          const a = document.createElement('a');
          a.href = pdf.dataUrl; a.download = pdf.name;
          document.body.appendChild(a); a.click(); a.remove();
        }
      } catch (e) {}
    });
  });
} else {
  // Sem emissão oficial configurada -> gera PDF/XML interno e registra
  this._calcTributosInternos?.(pedido);

  this.generateInvoice?.(pedido).then(nf => {
    const anexos = [];
    if (nf?.pdfDataUrl) anexos.push({
      name: `NF_${pedido.numero || pedido.id}.pdf`,
      type: 'application/pdf',
      dataUrl: nf.pdfDataUrl
    });
    if (nf?.xmlContent) anexos.push({
      name: `NF_${pedido.numero || pedido.id}.xml`,
      type: 'application/xml',
      dataUrl: 'data:application/xml;base64,' + btoa(unescape(encodeURIComponent(nf.xmlContent)))
    });
    this._autoReportInvoice?.(pedido, anexos);
  });
}
// ==================== [/FISCAL] ==========================================

// persistir e atualizar UI
this.saveToStorage?.();
this.renderQuotes?.();
this.loadOrders?.();
this.showToast?.('Orçamento aprovado e convertido em Pedido.', 'success');
}, 


        showQuoteForm: function (id=null) {
            const empresaId = this.currentEmpresa.id;
            this.orcamentos[empresaId] = this.orcamentos[empresaId] || [];
            const clientes = (this.clientes[empresaId]||[]);
            const produtos = (this.produtos[empresaId]||[]).filter(p=>p.status==='active');

            if (clientes.length===0){
                this.showToast('Cadastre um cliente antes de criar o orçamento.', 'warning');
            }
            
            

            const isEdit = !!id;
            const q = isEdit ? this.orcamentos[empresaId].find(x=>x.id===id) : {
                id: Date.now(),
                clienteId: clientes[0]?.id || null,
                clienteNome: clientes[0]?.nome || '',
                data: new Date().toISOString(),
                validoAte: new Date(Date.now()+7*24*60*60*1000).toISOString(),
                items: [],
                total: 0,
                status: 'pending'
            };

// === cálculo de dias para o campo "Validade (dias)" ===
    const defaultDays = 5;
    const daysCalc = (() => {
      try {
        if (!isEdit || !q?.validoAte || !q?.data) return defaultDays;
        const d0 = new Date(q.data);
        const d1 = new Date(q.validoAte);
        const diff = Math.ceil((d1 - d0) / 86400000);
        return Math.max(1, diff || defaultDays);
      } catch { return defaultDays; }
    })();

    const modalTitle = document.getElementById('modal-title');
    const modalBody  = document.getElementById('modal-body');
            
             

            
            modalTitle.innerHTML = `${isEdit?'<i class="fas fa-edit"></i> Editar':'<i class="fas fa-plus"></i> Novo'} Orçamento`;

            modalBody.innerHTML = `
                <div class="form-group"><label>Cliente</label>
                    <select id="qt-cliente">${clientes.map(c=>`<option value="${c.id}" ${c.id===q.clienteId?'selected':''}>${c.nome}</option>`).join('')}</select>
                    <div style="margin-top:.5rem"><button class="btn btn-secondary" onclick="SystemControlPro.showCustomerForm()"><i class="fas fa-user-plus"></i> Novo cliente</button></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Validade</label><input id="qt-valid" type="date" value="${q.validoAte.slice(0,10)}"></div>
                    <div class="form-group"><label>Status</label>
                        <select id="qt-status">
                            <option value="pending"  ${q.status==='pending'?'selected':''}>Pendente</option>
                            <option value="approved" ${q.status==='approved'?'selected':''}>Aprovado</option>
                            <option value="rejected" ${q.status==='rejected'?'selected':''}>Recusado</option>
                        </select>
                    </div>
                </div>
                <div id="qt-itens"></div>
                <button class="btn btn-secondary" onclick="SystemControlPro.addQuoteItemRow()"><i class="fas fa-plus"></i> Adicionar Item</button>
                <div style="display:flex; gap:1rem; margin-top:1rem">
                    <button class="btn btn-primary" onclick="SystemControlPro.saveQuoteFromModal(${isEdit?q.id:'null'})"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn btn-secondary" onclick="SystemControlPro.closeModal('form-modal')">Cancelar</button>
                </div>
            `;
            document.getElementById('form-modal').style.display = 'flex';

            

            // preencher itens existentes
            if (q.items.length===0) this.addQuoteItemRow();
            else q.items.forEach(it => this.addQuoteItemRow(it));

            // manter rascunho atual na memória do objeto para edição
            this._editingQuoteId = isEdit ? q.id : null;
        },

        addQuoteItemRow: function(existing=null) {
            const empresaId = this.currentEmpresa.id;
            const produtos = (this.produtos[empresaId]||[]).filter(p=>p.status==='active');
            const ctn = document.getElementById('qt-itens');
            const rowId = 'qi-'+Date.now()+Math.random().toString(36).slice(2);

            const linha = document.createElement('div');
            linha.className = 'form-row';
            linha.id = rowId;
            const sel = produtos.map(p=>`<option value="${p.id}" data-preco="${p.preco}" ${existing && p.id===existing.produtoId?'selected':''}>${p.nome}</option>`).join('');
            const precoIni = existing ? existing.preco : (produtos[0]?.preco || 0);
            const qtdIni   = existing ? existing.quantidade : 1;

            linha.innerHTML = `
                <div class="form-group" style="flex:2">
                    <label>Produto</label>
                    <select class="qt-prod">${sel}</select>
                </div>
                <div class="form-group"><label>Qtd</label><input class="qt-qtd" type="number" min="1" value="${qtdIni}"></div>
                <div class="form-group"><label>Preço (R$)</label><input class="qt-preco" type="number" step="0.01" value="${precoIni}"></div>
                <div class="form-group" style="align-self:end">
                    <button class="btn btn-danger" onclick="document.getElementById('${rowId}').remove()"><i class="fas fa-trash"></i></button>
                </div>
            `;
            ctn.appendChild(linha);

            // ao trocar produto → atualizar preço
            linha.querySelector('.qt-prod').onchange = (e)=>{
                const opt = e.target.selectedOptions[0];
                linha.querySelector('.qt-preco').value = Number(opt.dataset.preco || 0);
            };
        },

        saveQuoteFromModal: function (id=null) {
            const empresaId = this.currentEmpresa.id;
            this.orcamentos[empresaId] = this.orcamentos[empresaId] || [];

            const clienteId = parseInt(document.getElementById('qt-cliente').value);
            const cli = (this.clientes[empresaId]||[]).find(c=>c.id===clienteId);
            const status = document.getElementById('qt-status').value;
            const validade = document.getElementById('qt-valid').value;

            const items = [];
            document.querySelectorAll('#qt-itens .form-row').forEach(r=>{
                const prodId = parseInt(r.querySelector('.qt-prod').value);
                const qtd    = parseInt(r.querySelector('.qt-qtd').value || 1);
                const preco  = Number(r.querySelector('.qt-preco').value || 0);
                if (prodId && qtd>0 && preco>=0) items.push({produtoId:prodId, quantidade:qtd, preco, total:qtd*preco});
            });
            if (items.length===0){ this.showToast('Adicione ao menos 1 item', 'error'); return; }

            const total = items.reduce((a,b)=>a+b.total,0);

            const data = {
                id: id ?? Date.now(),
                clienteId, clienteNome: cli?.nome || '',
                data: new Date().toISOString(),
                validoAte: new Date(validade || new Date()).toISOString(),
                items, total, status
            };

            const idx = this.orcamentos[empresaId].findIndex(x=>x.id===data.id);
            if (idx>=0) this.orcamentos[empresaId][idx] = data; else this.orcamentos[empresaId].push(data);
            
			
			
            this.saveToStorage();
			this.logAction('quote.save', { id: data.id, clienteId: data.clienteId }); // ADICIONE ESTA LINHA
            this.closeModal('form-modal');
            this.loadQuotes();
            this.showToast('Orçamento salvo!', 'success');
        },

        deleteQuote: function (id) {
            const empresaId = this.currentEmpresa.id;
            this.showConfirmModal('Excluir orçamento','Confirma excluir este orçamento?', ()=>{
                this.orcamentos[empresaId] = (this.orcamentos[empresaId]||[]).filter(o=>o.id!==id);
                
				this.logAction('quote.delete', { id: id }); // ADICIONE ESTA LINHA
				this.saveToStorage();
				
				
                this.loadQuotes();
                this.closeModal('confirm-modal');
                this.showToast('Orçamento excluído.', 'success');
            });
        },

        setQuoteStatus: function(id, status){
            const empresaId = this.currentEmpresa.id;
            const q = (this.orcamentos[empresaId]||[]).find(o=>o.id===id);
            if (!q){ this.showToast('Orçamento não encontrado', 'error'); return; }
            q.status = status;
			this.logAction('quote.status', { id: id, status: status }); // ADICIONE ESTA LINHA
            this.saveToStorage();
            this.loadQuotes();
        },

        generateQuotePDF: function (quoteId) {
            const empresa = this.currentEmpresa;
            const empresaId = empresa.id;
            const q = (this.orcamentos[empresaId]||[]).find(o=>o.id===quoteId);
            if (!q){ this.showToast('Orçamento não encontrado', 'error'); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(14);
            doc.text(`${empresa.nome} - Proposta Comercial`, 14, 16);
            doc.setFontSize(11);
            doc.text(`Orçamento: #${q.id}`, 14, 24);
            doc.text(`Cliente: ${q.clienteNome || '-'}`, 14, 30);
            doc.text(`Data: ${new Date(q.data).toLocaleDateString()}`, 14, 36);
            doc.text(`Validade: ${new Date(q.validoAte).toLocaleDateString()}`, 14, 42);
            doc.text(`Status: ${q.status==='approved'?'Aprovado': q.status==='rejected'?'Recusado':'Pendente'}`, 14, 48);

            const rows = q.items.map(it=>{
                const prod = (this.produtos[empresaId]||[]).find(p=>p.id===it.produtoId);
                return [prod?.nome || it.produtoId, String(it.quantidade), `R$ ${it.preco.toFixed(2)}`, `R$ ${it.total.toFixed(2)}`];
            });

            doc.autoTable({ startY: 56, head: [['Produto','Qtd','Preço','Total']], body: rows });
            let y = doc.lastAutoTable.finalY + 8;
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: R$ ${q.total.toFixed(2)}`, 14, y);

            doc.save(`orcamento_${q.id}.pdf`);
        },

        convertQuoteToOrder: function (quoteId) {
            const empresaId = this.currentEmpresa.id;
            const q = (this.orcamentos[empresaId]||[]).find(o=>o.id===quoteId);
            if (!q){ this.showToast('Orçamento não encontrado', 'error'); return; }

            // checar estoque
            for (const it of q.items) {
                const p = (this.produtos[empresaId]||[]).find(x=>x.id===it.produtoId);
                if (!p || p.estoque < it.quantidade) {
                    this.showToast(`Estoque insuficiente para ${p?.nome || 'produto'}`, 'error'); return;
                }
            }

            // baixar estoque e criar pedido
            q.items.forEach(it=>{
                const p = this.produtos[empresaId].find(x=>x.id===it.produtoId);
                p.estoque -= it.quantidade;
            });

                        this.pedidos[empresaId].push({
                id: Date.now(),
                clienteId: q.clienteId, clienteNome: q.clienteNome,
                data: new Date().toISOString(),
                items: q.items,
                subtotal: q.total, desconto: 0, total: q.total,
                pagamento: 'A definir',
                status: 'delivered',
                vendedorId: this.currentUser?.id || null // vendedor responsável
            });

            q.status = 'approved';
			
			this.logAction('quote.convertToOrder', { id: quoteId }); // ADICIONE ESTA LINHA
            this.saveToStorage();
            this.loadQuotes();
            this.loadOrders();
            this.loadProducts();
            this.loadDashboard();
            this.showToast('Orçamento convertido em pedido!', 'success');
        },


            

// (opcional) fallback simples usando seu gerador atual
_fallbackInvoice: function(pedido){
  if (this.generateInvoice) {
    this.generateInvoice(pedido).then(nf=>{
      // se tiver relatório técnico, anexa
      const anexos = [];
      if (nf?.pdfDataUrl) anexos.push({name:`NF_${pedido.numero||pedido.id}.pdf`, type:'application/pdf', dataUrl:nf.pdfDataUrl});
      if (nf?.xmlContent) anexos.push({name:`NF_${pedido.numero||pedido.id}.xml`, type:'application/xml', dataUrl:'data:application/xml;base64,' + btoa(unescape(encodeURIComponent(nf.xmlContent)))});
      this._autoReportInvoice?.(pedido, anexos);
      this.showToast('Comprovante interno gerado.', 'success');
    }).catch(()=> this.showToast('Falha ao gerar comprovante interno.', 'error'));
  } else {
    this.showToast('Gerador de comprovante não disponível.', 'error');
  }
},



        // ===== PEDIDOS =====
        loadOrders: function () {
            const empresaId = this.currentEmpresa?.id;
            if (!empresaId) { document.getElementById('orders').innerHTML = ''; return; }

            const lista = (this.pedidos[empresaId] || []).map(p => `
                <tr>
                    <td>#${p.id}</td>
                    <td>${p.clienteNome || '-'}</td>
                    <td>${new Date(p.data).toLocaleString()}</td>
                    <td>R$ ${p.total.toFixed(2)}</td>
                    <td><span class="status-badge ${p.status==='delivered'?'status-active':'status-pending'}">
                        ${p.status==='delivered'?'Entregue':'Pendente'}</span></td>
                    <td class="action-buttons">
                        <!-- NOVO: Editar pedido -->
  <button class="btn btn-primary" onclick="SystemControlPro.showOrderForm(${p.id})">
    <i class="fas fa-edit"></i>
  </button>

  <!-- NOVO: Emitir NF -->
  <button class="btn btn-success" onclick="SystemControlPro.emitInvoiceFromOrder(${p.id})">
    <i class="fas fa-file-invoice"></i>
  </button>
                        <button class="btn btn-secondary" onclick="SystemControlPro.generateSalePDF(${p.id})"><i class="fas fa-file-pdf"></i></button>
                        <button class="btn btn-danger" onclick="SystemControlPro.cancelOrder(${p.id})"><i class="fas fa-times"></i></button>
                    </td>
                    
                </tr>
            `).join('');

            document.getElementById('orders').innerHTML = `
                <div class="card">
                    <h2><i class="fas fa-shopping-cart"></i> Gerenciamento de Pedidos</h2>
                    <button class="btn btn-primary" onclick="SystemControlPro.showOrderForm()">
                        <i class="fas fa-plus"></i> Novo Pedido
                    </button>
                    <div class="form-group" style="margin-top: 1rem;">
                        <input type="text" id="order-search" placeholder="Buscar pedido...">
                    </div>
                    <table>
                        <thead>
                            <tr><th>Número</th><th>Cliente</th><th>Data</th><th>Valor</th><th>Status</th><th>Ações</th></tr>
                        </thead>
                        <tbody id="orders-tbody">${lista}</tbody>
                    </table>
                </div>
            `;

            document.getElementById('order-search').oninput = e => {
                const q = e.target.value.toLowerCase();
                document.querySelectorAll('#orders-tbody tr').forEach(r => {
                    r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
                });
            };
        },

        showOrderForm: function (orderId = null) {
  if (!this.currentEmpresa) return;
  const empresaId = this.currentEmpresa.id;

  const clientes = this.clientes[empresaId] || [];
  const produtos = (this.produtos[empresaId] || []).filter(p => p.status === 'active');

  if (clientes.length === 0) {
    this.showToast('Cadastre um cliente antes de criar o pedido.', 'warning');
    this.showCustomerForm();
    return;
  }

  const isEdit = !!orderId;
  const old = isEdit ? (this.pedidos[empresaId] || []).find(p => p.id === orderId) : null;

  const modalTitle = document.getElementById('modal-title');
  const modalBody  = document.getElementById('modal-body');
  modalTitle.innerHTML = isEdit
    ? '<i class="fas fa-edit"></i> Editar Pedido'
    : '<i class="fas fa-plus"></i> Novo Pedido';

  modalBody.innerHTML = `
    <div class="form-group">
      <label>Cliente</label>
      <select id="ord-cliente">
        ${clientes.map(c => `<option value="${c.id}" ${isEdit && old?.clienteId===c.id?'selected':''}>${c.nome}</option>`).join('')}
      </select>
    </div>

    <div id="ord-itens"></div>
    <button class="btn btn-secondary" onclick="SystemControlPro.addOrderItemRow()">
      <i class="fas fa-plus"></i> Adicionar Item
    </button>

    <div class="form-row" style="margin-top:1rem">
      <div class="form-group">
        <label>Desconto (R$)</label>
        <input id="ord-desc" type="number" step="0.01" value="${isEdit ? (old?.desconto||0) : 0}">
      </div>
      <div class="form-group">
        <label>Forma de Pagamento</label>
        <select id="ord-pg">
          ${['PIX','Cartão','Dinheiro','Boleto'].map(opt=>`<option ${isEdit && old?.pagamento===opt?'selected':''}>${opt}</option>`).join('')}
        </select>
      </div>
    </div>

    <div style="display:flex; gap:1rem; margin-top:1rem">
      <button class="btn btn-primary" onclick="SystemControlPro.saveOrderFromModal(${isEdit ? old.id : 'null'})">
        <i class="fas fa-save"></i> ${isEdit ? 'Salvar alterações' : 'Finalizar'}
      </button>
      <button class="btn btn-secondary" onclick="SystemControlPro.closeModal('form-modal')">Cancelar</button>
    </div>
  `;

  // Monta linhas de itens (reaproveita sua addOrderItemRow(existing))
  if (isEdit && old?.items?.length) {
    old.items.forEach(it => this.addOrderItemRow(it));
  } else {
    this.addOrderItemRow();
  }

  document.getElementById('form-modal').style.display = 'flex';
},


        addOrderItemRow: function() {
            const empresaId = this.currentEmpresa.id;
            const produtos = (this.produtos[empresaId] || []).filter(p => p.status==='active' && p.estoque>0);
            const ctn = document.getElementById('ord-itens');
            const rowId = 'row-'+Date.now();

            const linha = document.createElement('div');
            linha.className = 'form-row';
            linha.id = rowId;
            linha.innerHTML = `
                <div class="form-group" style="flex:2">
                    <label>Produto</label>
                    <select class="ord-prod">
                        ${produtos.map(p => `<option value="${p.id}" data-preco="${p.preco}">${p.nome} (Estq: ${p.estoque})</option>`).join('')}
                    </select>
                </div>
                <div class="form-group"><label>Qtd</label><input class="ord-qtd" type="number" min="1" value="1"></div>
                <div class="form-group"><label>Preço (R$)</label><input class="ord-preco" type="number" step="0.01" value="${produtos[0]?.preco || 0}"></div>
                <div class="form-group" style="align-self:end">
                    <button class="btn btn-danger" onclick="document.getElementById('${rowId}').remove()"><i class="fas fa-trash"></i></button>
                </div>
            `;
            ctn.appendChild(linha);

            // ao trocar produto → atualizar preço
            linha.querySelector('.ord-prod').onchange = (e)=>{
                const opt = e.target.selectedOptions[0];
                linha.querySelector('.ord-preco').value = Number(opt.dataset.preco || 0);
            };
        },

        saveOrderFromModal: function() {
            const empresaId = this.currentEmpresa.id;
            this.pedidos[empresaId] = this.pedidos[empresaId] || [];

            const clienteId = parseInt(document.getElementById('ord-cliente').value);
            const cli = (this.clientes[empresaId] || []).find(c => c.id === clienteId);
            const desc = Number(document.getElementById('ord-desc').value || 0);
            const pg = document.getElementById('ord-pg').value;

            // coletar itens
            const itens = [];
            document.querySelectorAll('#ord-itens .form-row').forEach(r=>{
                const prodId = parseInt(r.querySelector('.ord-prod').value);
                const qtd = parseInt(r.querySelector('.ord-qtd').value || 1);
                const preco = Number(r.querySelector('.ord-preco').value || 0);
                if (prodId && qtd>0 && preco>=0) itens.push({produtoId:prodId, quantidade:qtd, preco, total:qtd*preco});
            });

            if (itens.length===0) { this.showToast('Adicione ao menos 1 item', 'error'); return; }

            // checar estoque
            for (const it of itens) {
                const p = (this.produtos[empresaId] || []).find(x=>x.id===it.produtoId);
                if (!p || p.estoque < it.quantidade) {
                    this.showToast(`Estoque insuficiente para ${p?.nome || 'produto'}`, 'error'); return;
                }
            }

            const subtotal = itens.reduce((a,b)=>a+b.total,0);
            const total = Math.max(0, subtotal - desc);

            // baixar estoque
            itens.forEach(it=>{
                const p = this.produtos[empresaId].find(x=>x.id===it.produtoId);
                p.estoque -= it.quantidade;
            });

            const order = {
                id: Date.now(),
                clienteId, clienteNome: cli?.nome || '',
                data: new Date().toISOString(),
                items: itens,
                subtotal, desconto: desc, total,
                pagamento: pg,
                status: 'delivered',
                vendedorId: this.currentUser?.id || null // vendedor responsável
            };

            this.pedidos[empresaId].push(order);

            
			
			
			this.logAction('order.save', { id: order.id, total: order.total }); // ADICIONE ESTA LINHA
            this.saveToStorage();
            this.closeModal('form-modal');
            this.loadOrders();
            this.loadDashboard();
            this.showToast('Pedido finalizado!', 'success');
        },

        cancelOrder: function(id){
            const empresaId = this.currentEmpresa.id;
            const idx = (this.pedidos[empresaId]||[]).findIndex(p=>p.id===id);
            if (idx<0){ this.showToast('Pedido não encontrado', 'error'); return; }
            // (opcional) não devolvemos estoque automaticamente aqui
            this.pedidos[empresaId].splice(idx,1);
			this.logAction('order.cancel', { id: id }); // ADICIONE ESTA LINHA
            this.saveToStorage();
            this.loadOrders();
            this.showToast('Pedido cancelado.', 'success');

            
        },
  // emite/gera NF a partir de um pedido já criado
  emitInvoiceFromOrder: function(orderId){
    const empresaId = this.currentEmpresa?.id;
    if (!empresaId) { this.showToast?.('Empresa não selecionada', 'error'); return; }

    // procura o pedido
    const pedido = (this.pedidos[empresaId] || []).find(p => String(p.id) === String(orderId));
    if (!pedido) { this.showToast?.('Pedido não encontrado', 'error'); return; }

    const cfg = this._getFiscalCfg?.(empresaId) || {};

    // helper p/ salvar & mostrar a nota na aba "Notas"
    const anexarNota = (nota) => {
      this.notas = this.notas || {};
      const lista = this.notas[empresaId] || [];
      lista.unshift(nota);
      this.notas[empresaId] = lista;
      // persiste e atualiza UI
      this._saveNotas?.();
      this.renderNotas?.();
    };

    // SE TIVER emissão oficial ligada, tenta primeiro
    if (cfg.enabled && this.emitOfficialNFe) {
      this.emitOfficialNFe(pedido).then(ret => {
        if (ret?.ok) {
          const anexos = [];
          if (ret.pdfDataUrl || ret.pdfUrl) {
            anexos.push({
              name: `DANFE_${pedido.numero || pedido.id}.pdf`,
              type: 'application/pdf',
              dataUrl: ret.pdfDataUrl || ret.pdfUrl
            });
          }
          if (ret.xmlDataUrl || ret.xml) {
            anexos.push({
              name: `NFe_${pedido.numero || pedido.id}.xml`,
              type: 'application/xml',
              dataUrl: ret.xmlDataUrl || ('data:application/xml;base64,' + btoa(unescape(encodeURIComponent(ret.xml))))
            });
          }

          anexarNota({
            id: (Date.now()),
            pedidoId: pedido.id,
            numero: pedido.numero || pedido.id,
            tipo: 'NF-e (oficial)',
            chaveAcesso: ret.chaveAcesso || '',
            criadoEm: new Date().toISOString(),
            anexos
          });

          // tenta baixar o PDF oficial (qualquer um dos dois campos)
          try {
            const pdf = anexos.find(a => a.type === 'application/pdf');
            if (pdf?.dataUrl) {
              const a = document.createElement('a');
              a.href = pdf.dataUrl; a.download = pdf.name;
              document.body.appendChild(a); a.click(); a.remove();
            }
          } catch(e){/* noop */}

          this._autoReportInvoice?.(pedido, anexos);
          this.showToast?.('NF-e emitida com sucesso!', 'success');
        } else {
          // fallback -> NF interna
          this.showToast?.('NF-e não disponível agora. Gerando comprovante interno…', 'warning');
          return this.generateInvoice?.(pedido).then(nf => {
            const anexos = [];
            if (nf?.pdfDataUrl) anexos.push({ name:`NF_${pedido.numero || pedido.id}.pdf`, type:'application/pdf', dataUrl:nf.pdfDataUrl });
            if (nf?.xmlContent)  anexos.push({ name:`NF_${pedido.numero || pedido.id}.xml`, type:'application/xml', dataUrl:'data:application/xml;base64,'+btoa(unescape(encodeURIComponent(nf.xmlContent))) });

            anexarNota({
              id: (Date.now()),
              pedidoId: pedido.id,
              numero: pedido.numero || pedido.id,
              tipo: 'NF interna',
              criadoEm: new Date().toISOString(),
              anexos
            });

            try {
              const pdf = anexos.find(a => a.type === 'application/pdf');
              if (pdf?.dataUrl) {
                const a = document.createElement('a');
                a.href = pdf.dataUrl; a.download = pdf.name;
                document.body.appendChild(a); a.click(); a.remove();
              }
            } catch(e){/* noop */}

            this._autoReportInvoice?.(pedido, anexos);
          });
        }
      }).catch(() => {
        // erro na oficial => NF interna
        this.showToast?.('Erro na emissão oficial. Gerando comprovante interno…', 'warning');
        return this.generateInvoice?.(pedido).then(nf => {
          const anexos = [];
          if (nf?.pdfDataUrl) anexos.push({ name:`NF_${pedido.numero || pedido.id}.pdf`, type:'application/pdf', dataUrl:nf.pdfDataUrl });
          if (nf?.xmlContent)  anexos.push({ name:`NF_${pedido.numero || pedido.id}.xml`, type:'application/xml', dataUrl:'data:application/xml;base64,'+btoa(unescape(encodeURIComponent(nf.xmlContent))) });

          anexarNota({
            id: (Date.now()),
            pedidoId: pedido.id,
            numero: pedido.numero || pedido.id,
            tipo: 'NF interna',
            criadoEm: new Date().toISOString(),
            anexos
          });

          try {
            const pdf = anexos.find(a => a.type === 'application/pdf');
            if (pdf?.dataUrl) {
              const a = document.createElement('a');
              a.href = pdf.dataUrl; a.download = pdf.name;
              document.body.appendChild(a); a.click(); a.remove();
            }
          } catch(e){/* noop */}

          this._autoReportInvoice?.(pedido, anexos);
        });
      });
    } else {
      // sem emissão oficial -> apenas NF interna
      this.generateInvoice?.(pedido).then(nf => {
        const anexos = [];
        if (nf?.pdfDataUrl) anexos.push({ name:`NF_${pedido.numero || pedido.id}.pdf`, type:'application/pdf', dataUrl:nf.pdfDataUrl });
        if (nf?.xmlContent)  anexos.push({ name:`NF_${pedido.numero || pedido.id}.xml`, type:'application/xml', dataUrl:'data:application/xml;base64,'+btoa(unescape(encodeURIComponent(nf.xmlContent))) });

        anexarNota({
          id: (Date.now()),
          pedidoId: pedido.id,
          numero: pedido.numero || pedido.id,
          tipo: 'NF interna',
          criadoEm: new Date().toISOString(),
          anexos
        });

        try {
          const pdf = anexos.find(a => a.type === 'application/pdf');
          if (pdf?.dataUrl) {
            const a = document.createElement('a');
            a.href = pdf.dataUrl; a.download = pdf.name;
            document.body.appendChild(a); a.click(); a.remove();
          }
        } catch(e){/* noop */}

        this._autoReportInvoice?.(pedido, anexos);
      });
    }
  },

        // PDF do pedido (recibo/comprovante)
        generateSalePDF: function (orderId) {
            const empresa = this.currentEmpresa;
            const empresaId = empresa.id;
            const pedido = (this.pedidos[empresaId]||[]).find(p=>p.id===orderId);
            if (!pedido) { this.showToast('Pedido não encontrado', 'error'); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(14);
            doc.text(`${empresa.nome} - Comprovante de Venda`, 14, 16);
            doc.setFontSize(11);
            doc.text(`Pedido: #${pedido.id}`, 14, 24);
            doc.text(`Cliente: ${pedido.clienteNome || '-'}`, 14, 30);
            doc.text(`Data: ${new Date(pedido.data).toLocaleString()}`, 14, 36);
            doc.text(`Pagamento: ${pedido.pagamento}`, 14, 42);

            const rows = pedido.items.map(it=>{
                const prod = (this.produtos[empresaId]||[]).find(p=>p.id===it.produtoId);
                return [
                    prod?.nome || it.produtoId, 
                    String(it.quantidade), 
                    `R$ ${it.preco.toFixed(2)}`, 
                    `R$ ${it.total.toFixed(2)}`
                ];
            });

            doc.autoTable({
                startY: 50,
                head: [['Produto','Qtd','Preço','Total']],
                body: rows
            });

            let y = doc.lastAutoTable.finalY + 8;
            doc.text(`Subtotal: R$ ${pedido.subtotal.toFixed(2)}`, 14, y); y+=6;
            doc.text(`Desconto: R$ ${pedido.desconto.toFixed(2)}`, 14, y); y+=6;
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: R$ ${pedido.total.toFixed(2)}`, 14, y);

            doc.save(`pedido_${pedido.id}.pdf`);

 
            
        },
        

        // ===== NF-e (PDF + XML simples) =====
generateInvoice: async function (pedido) {
  const empresa = this.currentEmpresa;
  const empresaId = empresa.id;

  // 1) Monta XML (modelo simplificado para seu fluxo)
  const xml = this._makeNFeXML(pedido, empresa);

  // 2) Monta PDF (espelhando o comprovante, mas como "Nota Fiscal")
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(14);
  doc.text(`${empresa.nome} - Nota Fiscal (NF-e simplificada)`, 14, 16);
  doc.setFontSize(11);
  doc.text(`Pedido/NF: ${pedido.numero || '#' + pedido.id}`, 14, 24);
  const cliNome = (() => {
    // tenta pegar cliente do orçamento ou do cadastro
    const orc = (this.orcamentos[empresaId]||[]).find(o => o.id === pedido.orcamentoId);
    const cId = orc?.clienteId ?? pedido.clienteId;
    const c   = (this.clientes[empresaId]||[]).find(x => x.id === cId);
    return c?.nome || pedido.clienteNome || '-';
  })();
  doc.text(`Cliente: ${cliNome}`, 14, 30);
  doc.text(`Data: ${new Date(pedido.createdAt || pedido.data || Date.now()).toLocaleString()}`, 14, 36);

  // Linhas de itens
  const rows = (() => {
    // tenta recuperar itens do orçamento do pedido
    const orc = (this.orcamentos[empresaId]||[]).find(o => o.id === pedido.orcamentoId);
    const itens = (orc?.itens || orc?.items || pedido.items || []);
    return itens.map(it => {
      const prod = (this.produtos[empresaId]||[]).find(p => p.id === (it.produtoId ?? it.id));
      const nome = prod?.nome || it.nome || String(it.produtoId ?? it.id);
      const qtd  = Number(it.qtd ?? it.quantidade ?? it.qty ?? 1);
      const preco = Number(it.preco ?? it.price ?? 0);
      const total = preco * qtd;
      return [nome, String(qtd), `R$ ${preco.toFixed(2)}`, `R$ ${total.toFixed(2)}`];
    });
  })();

  if (doc.autoTable) {
    doc.autoTable({
      startY: 46,
      head: [['Produto','Qtd','Preço','Total']],
      body: rows
    });
  }

  let y = doc.lastAutoTable ? (doc.lastAutoTable.finalY + 8) : 54;
  const total = Number(pedido.total ?? 0) || (() => {
    const orc = (this.orcamentos[empresaId]||[]).find(o => o.id === pedido.orcamentoId);
    return (orc?.itens || orc?.items || []).reduce((s,i) => {
      const preco = Number(i.preco ?? i.price ?? 0);
      const qtd   = Number(i.qtd ?? i.quantidade ?? 1);
      return s + preco*qtd;
    }, 0);
  })();

  doc.text(`TOTAL: R$ ${total.toFixed(2)}`, 14, y);

  doc.save(`pedido_${pedido.id}.pdf`);

  if (pedido.tributosResumo) {
  y += 10;
  doc.setFontSize(11);
  doc.text("Resumo de Tributos:", 14, y); 
  y += 8;
  doc.text(`Base: R$ ${pedido.tributosResumo.base.toFixed(2)}`, 20, y); y += 6;
  doc.text(`ICMS: R$ ${pedido.tributosResumo.icms.toFixed(2)}`, 20, y); y += 6;
  doc.text(`PIS: R$ ${pedido.tributosResumo.pis.toFixed(2)}`, 20, y); y += 6;
  doc.text(`COFINS: R$ ${pedido.tributosResumo.cofins.toFixed(2)}`, 20, y); y += 6;
  doc.text(`Total Impostos: R$ ${pedido.tributosResumo.totalImpostos.toFixed(2)}`, 20, y);
}


  // Gera DataURL do PDF (para anexar / baixar)
  const pdfDataUrl = doc.output('datauristring'); // "data:application/pdf;base64,..."

  // Retorna objetos para quem chamou
  return { pdfDataUrl, xmlContent: xml };
},

// Gera um XML simples de NF-e para arquivar/anexar
_makeNFeXML: function(pedido, empresa) {
  const empresaId = empresa.id;
  const orc = (this.orcamentos[empresaId]||[]).find(o => o.id === pedido.orcamentoId);
  const itens = (orc?.itens || orc?.items || pedido.items || []);
  const total = itens.reduce((s,i)=>{
    const p = Number(i.preco ?? i.price ?? 0);
    const q = Number(i.qtd ?? i.quantidade ?? i.qty ?? 1);
    return s + p*q;
  }, 0);

  // cliente
  const cliente = (() => {
    const cId = orc?.clienteId ?? pedido.clienteId;
    return (this.clientes[empresaId]||[]).find(c => c.id === cId) || {};
  })();

  // XML simplificado (não fiscal/SEFAZ), apenas para seu fluxo interno
  const esc = (s) => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const itensXml = itens.map((i,ix) => {
    const prod = (this.produtos[empresaId]||[]).find(p => p.id === (i.produtoId ?? i.id));
    const nome = prod?.nome || i.nome || String(i.produtoId ?? i.id);
    const qtd  = Number(i.qtd ?? i.quantidade ?? i.qty ?? 1);
    const preco= Number(i.preco ?? i.price ?? 0);
    return `
      <det nItem="${ix+1}">
        <prod>
          <cProd>${esc(i.produtoId ?? i.id)}</cProd>
          <xProd>${esc(nome)}</xProd>
          <qCom>${qtd.toFixed(2)}</qCom>
          <vUnCom>${preco.toFixed(2)}</vUnCom>
          <vProd>${(qtd*preco).toFixed(2)}</vProd>
        </prod>
      </det>`;
  }).join('');

  const xml =
`<?xml version="1.0" encoding="UTF-8"?>
<NFe>
  <infNFe Id="NF${pedido.numero || pedido.id}" versao="1.00">
    <ide>
      <natOp>VENDA</natOp>
      <dhEmi>${new Date(pedido.createdAt || Date.now()).toISOString()}</dhEmi>
      <nNF>${esc(pedido.numero || pedido.id)}</nNF>
    </ide>
    <emit>
      <xNome>${esc(empresa.nome)}</xNome>
      <CNPJ>${esc(empresa.cnpj || '00000000000000')}</CNPJ>
    </emit>
    <dest>
      <xNome>${esc(cliente.nome || pedido.clienteNome || 'Consumidor')}</xNome>
      <CPF>${esc(cliente.cpf || '')}</CPF>
      <email>${esc(cliente.email || '')}</email>
    </dest>
    ${itensXml}
    <total>
  <vNF>${total.toFixed(2)}</vNF>
  ${pedido.tributosResumo ? `
    <vBC>${pedido.tributosResumo.base.toFixed(2)}</vBC>
    <vICMS>${pedido.tributosResumo.icms.toFixed(2)}</vICMS>
    <vPIS>${pedido.tributosResumo.pis.toFixed(2)}</vPIS>
    <vCOFINS>${pedido.tributosResumo.cofins.toFixed(2)}</vCOFINS>
    <vTotTrib>${pedido.tributosResumo.totalImpostos.toFixed(2)}</vTotTrib>
  ` : ''}
</total>
  </infNFe>
</NFe>`;
  return xml;
},

// (Opcional) Gera Relatório Técnico automático anexando NF
_autoReportInvoice: function(pedido, anexos = []) {
  const empresaId = this.currentEmpresa?.id;
  if (!empresaId) return;
  this.relatorios = this.relatorios || {};
  const lista = this.relatorios[empresaId] || [];

  const resumo = `NF gerada para o pedido ${pedido.numero || '#' + pedido.id}.`;
  lista.push({
    id: this._nextId?.('relatorios', empresaId) ?? (lista.reduce((m,x)=>Math.max(m, x.id||0), 0)+1),
    empresaId,
    createdAt: new Date().toISOString(),
    usuarioId: this.currentUser?.id,
    tipo: 'Faturamento',
    resumo,
    atividades: `Emissão automática de NF do pedido ${pedido.numero || '#' + pedido.id}.`,
    destaques: `Total faturado: R$ ${(pedido.total ?? 0).toFixed(2)}.`,
    desafios: '',
    melhorias: '',
    anexos
  });

  this.relatorios[empresaId] = lista;
  this.saveToStorage?.();
},

logAction: function(event, payload){
  this.auditLogs = this.auditLogs || [];
  this.auditLogs.push({ ts: new Date().toISOString(), event, payload, userId: this.currentUser?.id });
  this.saveToStorage?.();
},



        // ===== RELATÓRIOS =====
        // ===== RELATÓRIOS =====
loadReports: function () {
  const el = document.getElementById('reports');
  if (!el) return;

  el.innerHTML = `
    <div class="card">
      <h2><i class="fas fa-chart-bar"></i> Relatórios</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="report-type">Tipo de Relatório:</label>
          <select id="report-type">
            <option value="sales">Vendas</option>
            <option value="products">Produtos</option>
            <option value="customers">Clientes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="report-period">Período:</label>
          <select id="report-period">
            <option value="month">Mensal</option>
            <option value="quarter">Trimestral</option>
            <option value="semester">Semestral</option>
            <option value="year">Anual</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:1rem; flex-wrap:wrap">
        <button class="btn btn-primary" onclick="SystemControlPro.generatePeriodReportPDF()">
          <i class="fas fa-file-pdf"></i> Gerar PDF
        </button>
      </div>

      <div style="margin-top: 2rem;">
        <div class="chart-card">
          <h3 id="rep-chart-title"><i class="fas fa-chart-line"></i> Visualização</h3>
          <canvas id="monthlySalesChart"></canvas>
        </div>
      </div>
    </div>
  `;

  // Depois de el.innerHTML = `...`; e antes dos listeners do gráfico:
const empresaId = this.currentEmpresa?.id;
const lista = (this.relatorios?.[empresaId] || []).slice().reverse().slice(0, 20);

const rows = lista.map(r => `
  <tr>
    <td>${new Date(r.createdAt).toLocaleString('pt-BR')}</td>
    <td>${r.tipo || ''}</td>
    <td>${r.resumo || ''}</td>
    <td>
      ${(r.anexos||[]).map(a => `
        <a href="${a.dataUrl}" download="${a.name}" class="btn btn-sm btn-secondary">
          <i class="fas fa-download"></i> ${a.name}
        </a>
      `).join(' ')}
    </td>
  </tr>
`).join('') || '<tr><td colspan="4">Sem relatórios ainda</td></tr>';

const wrap = document.createElement('div');
wrap.innerHTML = `
  <div class="card" style="margin-top:16px">
    <h3><i class="fas fa-clipboard-list"></i> Relatórios recentes</h3>
    <table class="table">
      <thead>
        <tr><th>Quando</th><th>Tipo</th><th>Resumo</th><th>Anexos</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  </div>
`;
el.appendChild(wrap);


  // listeners para atualizar gráfico ao trocar filtros
  const typeSel = document.getElementById('report-type');
  const perSel  = document.getElementById('report-period');
  const rerender = () => this._renderReportsChartAndSummary();
  typeSel.addEventListener('change', rerender);
  perSel.addEventListener('change', rerender);

  // primeira renderização
  this._renderReportsChartAndSummary();
},

  _reportsChart: null, // instância atual do Chart

_renderReportsChartAndSummary: function(){
  const empresaId = this.currentEmpresa?.id;
  const type  = document.getElementById('report-type')?.value || 'sales';
  const period= document.getElementById('report-period')?.value || 'month';
  const title = document.getElementById('rep-chart-title');

  // protege contra falta do Chart.js para não “quebrar” a aba
  if (!window.Chart) {
    if (title) title.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Visualização indisponível (Chart.js não carregado)`;
    return;
  }

  // calcula janela do período
  const now = new Date();
  const start = new Date(now);
  if (period==='month')   start.setMonth(start.getMonth()-1);
  if (period==='quarter') start.setMonth(start.getMonth()-3);
  if (period==='semester')start.setMonth(start.getMonth()-6);
  if (period==='year')    start.setFullYear(start.getFullYear()-1);

  const ctx = document.getElementById('monthlySalesChart')?.getContext('2d');
  if (!ctx) return;

  // destrói gráfico anterior (evita sobreposição)
  if (this._reportsChart && typeof this._reportsChart.destroy === 'function') {
    this._reportsChart.destroy();
    this._reportsChart = null;
  }

  let labels = [];
  let data   = [];
  let chartType = 'bar';
  let datasetLabel = '';

  if (type === 'sales') {
    // VENDAS por mês no período (respeita papel do usuário)
    if (title) title.innerHTML = `<i class="fas fa-chart-line"></i> Vendas por mês`;
    const pedidosVisiveis = this._getOrdersForCurrentRole(empresaId)
      .filter(p => { const d=new Date(p.data); return d>=start && d<=now; });

    const map = {}; // YYYY-MM -> total
    pedidosVisiveis.forEach(p=>{
      const k = new Date(p.data).toISOString().slice(0,7);
      map[k] = (map[k]||0) + (Number(p.total)||0);
    });
    labels = Object.keys(map).sort();
    data   = labels.map(k=>map[k]);
    chartType = 'bar';
    datasetLabel = 'Vendas (R$)';
  }

  if (type === 'products') {
    // PRODUTOS: Top 10 vendidos no período (por quantidade)
    if (title) title.innerHTML = `<i class="fas fa-cubes"></i> Top produtos vendidos`;
    const pedidosVisiveis = this._getOrdersForCurrentRole(empresaId)
      .filter(p => { const d=new Date(p.data); return d>=start && d<=now; });

    const qtyByProd = {}; // produtoId -> qtd
    pedidosVisiveis.forEach(p=>{
      (p.items||[]).forEach(it=>{
        qtyByProd[it.produtoId] = (qtyByProd[it.produtoId]||0) + (Number(it.quantidade)||0);
      });
    });

    // resolve nomes e ordena
    const prods = this.produtos[empresaId]||[];
    const arr = Object.entries(qtyByProd).map(([id,q])=>{
      const nome = prods.find(pp=>pp.id==id)?.nome || `#${id}`;
      return { nome, qtd:q };
    }).sort((a,b)=>b.qtd-a.qtd).slice(0,10);

    labels = arr.map(x=>x.nome);
    data   = arr.map(x=>x.qtd);
    chartType = 'bar';
datasetLabel = 'Qtde vendida';
var extraOpts = { indexAxis: 'y' }; // deixa o bar em horizontal no v3+
  }

  if (type === 'customers') {
    // CLIENTES: Novos clientes por mês no período
    if (title) title.innerHTML = `<i class="fas fa-user-friends"></i> Novos clientes por mês`;
    const cls = (this.clientes[empresaId]||[]).filter(c=>{
      const d = new Date(c.dataCadastro || c.createdAt || c.updatedAt || Date.now());
      return d>=start && d<=now;
    });
    const map = {};
    cls.forEach(c=>{
      const k = new Date(c.dataCadastro || c.createdAt || Date.now()).toISOString().slice(0,7);
      map[k] = (map[k]||0) + 1;
    });
    labels = Object.keys(map).sort();
    data   = labels.map(k=>map[k]);
    chartType = 'line';
    datasetLabel = 'Novos clientes';
  }

  // cria o gráfico
  try {
  const baseOpts = { responsive:true, maintainAspectRatio:false };
  const opts = Object.assign({}, baseOpts, (typeof extraOpts === 'object' ? extraOpts : {}));

  this._reportsChart = new Chart(ctx, {
    type: chartType,
    data: { labels, datasets: [{ label: datasetLabel, data }] },
    options: opts
  });
} catch (err) {
  console.error('Erro ao renderizar gráfico de relatórios:', err);
  if (title) title.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Não foi possível renderizar o gráfico.`;
}
},

        // Pedidos visíveis nos relatórios conforme o papel
_getOrdersForCurrentRole: function(empresaId){
  const todos = this.pedidos[empresaId] || [];
  if (this.currentUser?.role === 'seller') {
    return todos.filter(p => p.vendedorId === this.currentUser.id);
  }
  return todos; // admin / system_admin
},


        generatePeriodReportPDF: function(){
            const type = document.getElementById('report-type').value; // 'sales'|'products'|'customers'
            const period = document.getElementById('report-period').value; // 'month'|'quarter'|'semester'|'year'
            const empresa = this.currentEmpresa;
            const empresaId = empresa.id;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // range de datas
            const now = new Date();
            const start = new Date(now);
            if (period==='month') start.setMonth(start.getMonth()-1);
            if (period==='quarter') start.setMonth(start.getMonth()-3);
            if (period==='semester') start.setMonth(start.getMonth()-6);
            if (period==='year') start.setFullYear(start.getFullYear()-1);

            doc.setFontSize(14);
            doc.text(`${empresa.nome} - Relatório ${type==='sales'?'de Vendas': type==='products'?'de Produtos':'de Clientes'}`, 14, 16);
            doc.setFontSize(11);
            doc.text(`Período: ${start.toLocaleDateString()} a ${now.toLocaleDateString()}`, 14, 24);

            if (type==='sales') {
                const pedidos = this._getOrdersForCurrentRole(empresaId).filter(p=>{
  const d = new Date(p.data);
  return d>=start && d<=now;
});

                const body = pedidos.flatMap(p => p.items.map(it=>{
                    const nome = (this.produtos[empresaId]||[]).find(pp=>pp.id===it.produtoId)?.nome || it.produtoId;
                    return [ `#${p.id}`, new Date(p.data).toLocaleDateString(), nome, String(it.quantidade), `R$ ${(it.preco).toFixed(2)}`, `R$ ${(it.total).toFixed(2)}` ];
                }));

                const totalPeriodo = pedidos.reduce((a,b)=>a+b.total,0);

                if (doc.autoTable) {
  doc.autoTable({
    startY: 30,
    head: [['Pedido','Data','Produto','Qtd','Preço','Total']],
    body: body.length ? body : [['-','-','-','-','-','-']]
  });
}

                let y = doc.lastAutoTable.finalY + 8;
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAL DO PERÍODO: R$ ${totalPeriodo.toFixed(2)}`, 14, y);
            }

            if (type==='products') {
                const prods = (this.produtos[empresaId]||[]);
                const body = prods.map(p=>[p.nome,p.categoria,`R$ ${p.preco.toFixed(2)}`, p.estoque, p.status==='active'?'Ativo':'Inativo']);
                doc.autoTable({ startY: 30, head: [['Produto','Categoria','Preço','Estoque','Status']], body: body.length?body:[['-','-','-','-','-']] });
            }

            if (type==='customers') {
                const cls = (this.clientes[empresaId]||[]);
                const body = cls.map(c=>[c.nome, c.email || '-', c.telefone || '-', new Date(c.dataCadastro).toLocaleDateString(), c.status==='active'?'Ativo':'Inativo']);
                doc.autoTable({ startY: 30, head: [['Cliente','E-mail','Telefone','Cadastro','Status']], body: body.length?body:[['-','-','-','-','-']] });
            }

            doc.save(`relatorio_${type}_${period}.pdf`);
        }, 
        
        // ===== ADMINISTRAÇÃO =====
loadAdmin: function() {
  const adminTab = document.getElementById('admin');

  // Se for system_admin, vê TODAS as empresas
  if (this.currentUser.role === 'system_admin') {
    adminTab.innerHTML = `
      <div class="admin-section">
        <h3><i class="fas fa-lock"></i> Área do Administrador do Sistema</h3>
        <p>Gerencie todas as empresas do sistema.</p>
      </div>

      <div class="card">
        <h2><i class="fas fa-building"></i> Gerenciamento de Empresas</h2>
        <button class="btn btn-primary" onclick="SystemControlPro.showCompanyForm()">
          <i class="fas fa-plus"></i> Adicionar Empresa
        </button>

        <table style="margin-top: 1rem;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Plano</th>
              <th>Status</th>
              <th>CNPJ</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            ${this.empresas.map(empresa => `
              <tr>
                <td>${empresa.id}</td>
                <td>${empresa.nome}</td>
                <td>${empresa.plano||'-'}</td>
                <td>${empresa.status||'-'}</td>
                <td>${empresa.cnpj||'-'}</td>
                <td class="action-buttons">
                  <button class="btn btn-secondary" onclick="SystemControlPro.showCompanyForm(${empresa.id})">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-danger" onclick="SystemControlPro.deleteCompany(${empresa.id})">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    return;

    // [FISCAL] Card Fiscal
adminTab.innerHTML += `
  <div class="card">
    <h2><i class="fas fa-file-invoice"></i> Faturamento Fiscal</h2>

    <div class="form-row">
      <div class="form-group">
        <label>Ativar emissão oficial</label>
        <select id="fx-enabled"><option value="false">Desativado</option><option value="true">Ativado</option></select>
      </div>

      <div class="form-group">
        <label>Tipo de Documento</label>
        <select id="fx-doc">
          <option value="nfe">NF-e (produtos)</option>
          <option value="nfse">NFS-e (serviços)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Provedor</label>
        <select id="fx-provider">
          <option value="">Selecione</option>
          <option value="nfeio">NFe.io</option>
          <option value="enotas">eNotas</option>
          <option value="plugnotas">Plugnotas</option>
          <option value="focus">Focus NFe</option>
        </select>
      </div>

      <div class="form-group">
        <label>Ambiente</label>
        <select id="fx-amb"><option value="homolog">Homologação</option><option value="producao">Produção</option></select>
      </div>

      <div class="form-group">
        <label>Regime Tributário</label>
        <select id="fx-regime">
          <option value="mei">MEI</option>
          <option value="simples_nacional">Simples Nacional</option>
          <option value="normal">Regime Normal</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>UF Emitente (SEFAZ/Prefeitura)</label>
        <select id="fx-uf">
          <option value="">Selecione</option>
          ${['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'].map(UF=>`<option value="${UF}">${UF}</option>`).join('')}
        </select>
      </div>

      <div class="form-group">
        <label>Código do Município (NFS-e)</label>
        <input id="fx-mun" placeholder="Ex.: 3550308 (São Paulo)">
      </div>

      <div class="form-group" style="flex:1">
        <label>API Token do Provedor</label>
        <input type="password" id="fx-token" placeholder="Cole aqui o token/secret">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>CFOP dentro do estado</label>
        <input id="fx-cfop-in" value="5102">
      </div>
      <div class="form-group">
        <label>CFOP fora do estado</label>
        <input id="fx-cfop-out" value="6102">
      </div>
      <div class="form-group">
        <label>CST/CSOSN (padrão)</label>
        <input id="fx-csosn" value="102">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Atualizar tributos automaticamente via API?</label>
        <select id="fx-tax-enabled">
          <option value="false">Não</option>
          <option value="true">Sim</option>
        </select>
      </div>
      <div class="form-group" style="flex:1">
        <label>Base URL da Tax API</label>
        <input id="fx-tax-base" placeholder="https://suaapi.com">
      </div>
      <div class="form-group" style="flex:1">
        <label>Chave da Tax API</label>
        <input id="fx-tax-key" placeholder="api_key_ou_secret">
      </div>
      <div class="form-group">
        <label>Cache TTL (min)</label>
        <input id="fx-tax-ttl" type="number" min="1" value="60">
      </div>
    </div>

    <div class="form-group">
      <label>Certificado A1 (.pfx) — se necessário</label>
      <input type="file" id="fx-a1" accept=".pfx,.p12">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Senha do certificado A1</label>
        <input type="password" id="fx-a1-pass" placeholder="Senha do PFX">
      </div>
      <div class="form-group">
        <label>Auto emitir ao aprovar orçamento?</label>
        <select id="fx-auto"><option value="true">Sim</option><option value="false">Não</option></select>
      </div>
    </div>

    <button class="btn btn-primary" onclick="SystemControlPro.saveFiscalSettings()">
      <i class="fas fa-save"></i> Salvar Fiscal
    </button>
  </div>
`;

// [FISCAL] Hidratar card com valores atuais
try{
  const empresaIdFX = this.currentEmpresa?.id;
  const fx = this._getFiscalCfg(empresaIdFX);
  document.getElementById('fx-enabled').value   = String(!!fx.enabled);
  document.getElementById('fx-doc').value       = fx.docType || 'nfe';
  document.getElementById('fx-provider').value  = fx.provider || '';
  document.getElementById('fx-amb').value       = fx.ambiente || 'homolog';
  document.getElementById('fx-regime').value    = fx.regime || 'mei';
  document.getElementById('fx-uf').value        = fx.ufEmitente || '';
  document.getElementById('fx-mun').value       = fx.nfseMunicipioCodigo || '';
  document.getElementById('fx-token').value     = fx.apiToken || '';
  document.getElementById('fx-auto').value      = String(!!fx.autoEmitOnApprove);
  document.getElementById('fx-cfop-in').value   = fx.cfopDentro || '5102';
  document.getElementById('fx-cfop-out').value  = fx.cfopFora || '6102';
  document.getElementById('fx-csosn').value     = fx.cst_csosn || '102';
  document.getElementById('fx-tax-enabled').value = String(!!fx.taxApiEnabled);
  document.getElementById('fx-tax-base').value  = fx.taxApiBase || '';
  document.getElementById('fx-tax-key').value   = fx.taxApiKey || '';
  document.getElementById('fx-tax-ttl').value   = fx.taxCacheTtlMinutes || 60;
} catch(e){}



// [FISCAL] Card Fiscal (colar após construir os outros cards do Admin)
adminTab.innerHTML += `
  <div class="card">
    <h2><i class="fas fa-file-invoice"></i> Faturamento Fiscal (NF-e/NFS-e)</h2>
    <div class="form-row">
      <div class="form-group">
        <label>Ativar emissão oficial</label>
        <select id="fx-enabled">
          <option value="false">Desativado</option>
          <option value="true">Ativado</option>
        </select>
      </div>
      <div class="form-group">
        <label>Provedor</label>
        <select id="fx-provider">
          <option value="">Selecione</option>
          <option value="nfeio">NFe.io</option>
          <option value="enotas">eNotas</option>
          <option value="plugnotas">Plugnotas</option>
          <option value="focus">Focus NFe</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ambiente</label>
        <select id="fx-amb">
          <option value="homolog">Homologação</option>
          <option value="producao">Produção</option>
        </select>
      </div>
      <div class="form-group">
        <label>Regime Tributário</label>
        <select id="fx-regime">
          <option value="mei">MEI</option>
          <option value="simples_nacional">Simples Nacional</option>
          <option value="normal">Regime Normal</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group" style="flex:1">
        <label>API Token do Provedor</label>
        <input type="password" id="fx-token" placeholder="Cole aqui o token/secret">
      </div>
      <div class="form-group">
        <label>Auto emitir ao aprovar orçamento?</label>
        <select id="fx-auto">
          <option value="true">Sim</option>
          <option value="false">Não</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>CFOP dentro do estado</label>
        <input id="fx-cfop-in" value="5102">
      </div>
      <div class="form-group">
        <label>CFOP fora do estado</label>
        <input id="fx-cfop-out" value="6102">
      </div>
      <div class="form-group">
        <label>CST/CSOSN (padrão)</label>
        <input id="fx-csosn" value="102">
      </div>
    </div>

    <div class="form-group">
      <label>Certificado A1 (.pfx) — se o provedor exigir upload do seu lado</label>
      <input type="file" id="fx-a1" accept=".pfx,.p12">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Senha do certificado A1</label>
        <input type="password" id="fx-a1-pass" placeholder="Senha do PFX (se necessário)">
      </div>
    </div>

    <button class="btn btn-primary" onclick="SystemControlPro.saveFiscalSettings()">
      <i class="fas fa-save"></i> Salvar Fiscal
    </button>
  </div>
`;

// [FISCAL] Hidratar card com valores atuais
try{
  const empresaIdFX = this.currentEmpresa?.id;
  const fx = this._getFiscalCfg(empresaIdFX);
  document.getElementById('fx-enabled').value   = String(!!fx.enabled);
  document.getElementById('fx-provider').value  = fx.provider || '';
  document.getElementById('fx-amb').value       = fx.ambiente || 'homolog';
  document.getElementById('fx-regime').value    = fx.regime || 'mei';
  document.getElementById('fx-token').value     = fx.apiToken || '';
  document.getElementById('fx-auto').value      = String(!!fx.autoEmitOnApprove);
  document.getElementById('fx-cfop-in').value   = fx.cfopDentro || '5102';
  document.getElementById('fx-cfop-out').value  = fx.cfopFora || '6102';
  document.getElementById('fx-csosn').value     = fx.cst_csosn || '102';
} catch(e){}

  }

  // Admin de EMPRESA (ou seller com acesso) vê as configs da própria empresa
  const e = this.currentEmpresa || {};
  const empresaId = e.id;
  const config = this.configuracoes[empresaId] || {};
  adminTab.innerHTML = `
    <div class="admin-section">
      <h3><i class="fas fa-lock"></i> Configurações da Empresa</h3>
      <p>Altere dados básicos, segurança e metas/comissões.</p>
    </div>

    <div class="card">
      <h2><i class="fas fa-cog"></i> Dados da Empresa</h2>
      <div class="form-group">
        <label>Nome</label>
        <input type="text" id="company-name" value="${e.nome||''}">
      </div>
      <div class="form-group">
        <label>CNPJ</label>
        <input type="text" id="company-cnpj" value="${e.cnpj||''}">
      </div>
      <div class="form-group">
        <label>Endereço</label>
        <input type="text" id="company-address" value="${e.endereco||''}">
      </div>
      <div class="form-group">
        <label>Telefone</label>
        <input type="text" id="company-phone" value="${e.telefone||''}">
      </div>
      <div class="form-group">
        <label>E-mail</label>
        <input type="email" id="company-email" value="${e.email||''}">
      </div>
      <button class="btn btn-primary" onclick="SystemControlPro.updateCompanySettings()">
        <i class="fas fa-save"></i> Salvar
      </button>
    </div>

    <div class="card">
      <h2><i class="fas fa-shield-alt"></i> Segurança</h2>
      <div class="form-group">
        <label>Nova senha (meu usuário)</label>
        <input type="password" id="admin-password" placeholder="Nova senha">
      </div>
      <div class="form-group">
        <label>Confirmar</label>
        <input type="password" id="admin-password-confirm" placeholder="Confirmar nova senha">
      </div>
      <button class="btn btn-primary" onclick="SystemControlPro.updateAdminPassword()">
        <i class="fas fa-key"></i> Atualizar Senha
      </button>
    </div>

    <div class="card">
      <h2><i class="fas fa-bullseye"></i> Metas e Comissões</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Meta Mensal Geral (R$)</label>
          <input type="number" id="cfg-meta-geral" value="${config.metaMensal||0}" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label>Comissão (%)</label>
          <input type="number" id="cfg-com-geral" value="${config.comissaoPercentual||0}" step="0.01" min="0">
        </div>
      </div>
      <button class="btn btn-primary" onclick="SystemControlPro.saveGeneralGoalCommission()">
        <i class="fas fa-save"></i> Salvar Geral
      </button>
    </div>

    <div class="card">
      <h2><i class="fas fa-image"></i> Logo</h2>
      ${e.logo ? `<div style="margin-bottom: 1rem;"><img src="${e.logo}" style="max-width:150px;max-height:150px;border-radius:50%"></div>`:''}
      <div class="form-group">
        <input type="file" id="company-logo" accept="image/*">
      </div>
      <button class="btn btn-primary" onclick="SystemControlPro.uploadLogo()">
        <i class="fas fa-upload"></i> Upload Logo
      </button>
    </div>
  `;

// Preencher o card com os valores atuais
try {
  const empresaIdFX = this.currentEmpresa?.id;
  const fx = this._getFiscalCfg(empresaIdFX);
  document.getElementById('fx-enabled').value = String(!!fx.enabled);
  document.getElementById('fx-provider').value = fx.provider || '';
  document.getElementById('fx-amb').value = fx.ambiente || 'homolog';
  document.getElementById('fx-regime').value = fx.regime || 'mei';
  document.getElementById('fx-token').value = fx.apiToken || '';
  document.getElementById('fx-auto').value = String(!!fx.autoEmitOnApprove);
  document.getElementById('fx-cfop-in').value = fx.cfopDentro || '5102';
  document.getElementById('fx-cfop-out').value = fx.cfopFora || '6102';
  document.getElementById('fx-csosn').value = fx.cst_csosn || '102';
} catch(e){}
},


        

// Form de empresa (criar/editar) no modal
showCompanyForm: function(id=null){
  const isEdit = !!id;
  const emp = isEdit ? this.empresas.find(e=>e.id===id) : { nome:'', cnpj:'', endereco:'', telefone:'', email:'', plano:'basic', status:'active', codigo:'' };

  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  modalTitle.innerHTML = `${isEdit?'<i class="fas fa-edit"></i> Editar':'<i class="fas fa-plus"></i> Nova'} Empresa`;

  modalBody.innerHTML = `
    <div class="form-row">
      <div class="form-group">
        <label>Nome</label>
        <input id="emp-nome" value="${emp.nome||''}">
      </div>
      <div class="form-group">
        <label>Código</label>
        <input id="emp-codigo" value="${emp.codigo||''}" placeholder="0001">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>CNPJ</label>
        <input id="emp-cnpj" value="${emp.cnpj||''}">
      </div>
      <div class="form-group">
        <label>Plano</label>
        <select id="emp-plano">
          <option value="basic" ${emp.plano==='basic'?'selected':''}>Basic</option>
          <option value="premium" ${emp.plano==='premium'?'selected':''}>Premium</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Status</label>
        <select id="emp-status">
          <option value="active" ${emp.status==='active'?'selected':''}>Ativa</option>
          <option value="inactive" ${emp.status==='inactive'?'selected':''}>Inativa</option>
          <option value="pending" ${emp.status==='pending'?'selected':''}>Pendente</option>
        </select>
      </div>
      <div class="form-group">
        <label>E-mail</label>
        <input id="emp-email" value="${emp.email||''}">
      </div>
    </div>
    <div class="form-group">
      <label>Endereço</label>
      <input id="emp-endereco" value="${emp.endereco||''}">
    </div>
    <div class="form-group">
      <label>Telefone</label>
      <input id="emp-telefone" value="${emp.telefone||''}">
    </div>

    <div style="display:flex;gap:1rem;margin-top:1rem;">
      <button class="btn btn-primary" onclick="SystemControlPro.saveCompanyFromModal(${isEdit?id:'null'})">
        <i class="fas fa-save"></i> Salvar
      </button>
      <button class="btn btn-secondary" onclick="SystemControlPro.closeModal('form-modal')">Cancelar</button>
    </div>
  `;

  document.getElementById('form-modal').style.display='flex';
},

saveCompanyFromModal: function(id=null){
  const nome = document.getElementById('emp-nome').value.trim();
  const codigo = document.getElementById('emp-codigo').value.trim();
  const cnpj = document.getElementById('emp-cnpj').value.trim();
  const plano = document.getElementById('emp-plano').value;
  const status = document.getElementById('emp-status').value;
  const email = document.getElementById('emp-email').value.trim();
  const endereco = document.getElementById('emp-endereco').value.trim();
  const telefone = document.getElementById('emp-telefone').value.trim();

  if(!nome){ this.showToast('Informe o nome da empresa','error'); return; }

  if(id){ // editar
    const i = this.empresas.findIndex(e=>e.id===id);
    if(i<0){ this.showToast('Empresa não encontrada','error'); return; }
    Object.assign(this.empresas[i],{nome,codigo,cnpj,plano,status,email,endereco,telefone});
    this.saveToStorage();
    this.logAction?.('empresa.update',{empresaId:id});
  } else { // criar
    const newId = (this.empresas.reduce((m,e)=>Math.max(m,e.id),0)||0)+1;
    const emp = { id:newId, nome,codigo,cnpj,plano,status,email,endereco,telefone, dataCriacao:new Date().toISOString(), logo:null };
    this.empresas.push(emp);

    // estruturas da empresa
    this.usuarios[newId] = [{ id:1, username:'admin', password:'admin123', name:'Administrador', role:'admin', status:'active', email }];
    this.produtos[newId] ||= [];
    this.clientes[newId] ||= [];
    this.orcamentos[newId] ||= [];
    this.pedidos[newId] ||= [];
    this.configuracoes[newId] = { empresaId:newId, metaMensal:10000, comissaoPercentual:5, metasPorUsuario:{}, comissaoPorUsuario:{} };

    this.saveToStorage();
    this.logAction?.('empresa.create',{empresaId:newId});
    this.showToast('Empresa criada. Admin padrão: admin / admin123','success');
  }

  this.closeModal('form-modal');
  this.loadAdmin();
},

deleteCompany: function(id) {
    this.showConfirmModal(
        'Excluir Empresa',
        'Tem certeza que deseja excluir esta empresa? Todos os dados associados serão permanentemente removidos.',
        () => {
            // Encontrar o índice da empresa
            const index = this.empresas.findIndex(e => e.id === id);
            if (index === -1) {
                this.showToast('Empresa não encontrada', 'error');
                return;
            }
            
            // Remover a empresa do array
            this.empresas.splice(index, 1);
            
            // Remover todos os dados associados à empresa
            delete this.usuarios[id];
            delete this.produtos[id];
            delete this.clientes[id];
            delete this.orcamentos[id];
            delete this.pedidos[id];
            delete this.configuracoes[id];
            delete this.notas[id];
            delete this.configFisco[id];
            
            // Salvar alterações
            this.saveToStorage();
            
            // Recarregar a interface administrativa
            this.loadAdmin();
            
            // Fechar o modal de confirmação
            this.closeModal('confirm-modal');
            
            // Mostrar mensagem de sucesso
            this.showToast('Empresa excluída com sucesso!', 'success');
  });
},

updateAdminPassword: function() {
  const pass  = document.getElementById('admin-password').value;
  const pass2 = document.getElementById('admin-password-confirm').value;

  if (!pass) { this.showToast('Informe a nova senha', 'error'); return; }
  if (pass !== pass2) { this.showToast('As senhas não coincidem', 'error'); return; }
  if (!this.currentEmpresa) { this.showToast('Entre em uma empresa primeiro', 'error'); return; }

  const empresaId = this.currentEmpresa.id;
  const users = this.usuarios[empresaId] || [];
  const idx = users.findIndex(u => u.id === this.currentUser.id);
  if (idx < 0) { this.showToast('Usuário não encontrado', 'error'); return; }

  this.usuarios[empresaId][idx].password = pass;
  this.currentUser.password = pass; // mantém a sessão coerente
  this.saveToStorage();

  document.getElementById('admin-password').value = '';
  document.getElementById('admin-password-confirm').value = '';
  this.showToast('Senha atualizada com sucesso!', 'success');
},



updateCompanySettings: function() {
  if (!this.currentEmpresa) return;
  const name = document.getElementById('company-name').value.trim();
  const cnpj = document.getElementById('company-cnpj').value.trim();
  const addr = document.getElementById('company-address').value.trim();
  const phone = document.getElementById('company-phone').value.trim();
  const email = document.getElementById('company-email').value.trim();

  if (!name || !cnpj || !addr) { this.showToast('Preencha nome, CNPJ e endereço', 'error'); return; }

  const i = this.empresas.findIndex(e => e.id === this.currentEmpresa.id);
  if (i < 0) { this.showToast('Empresa não encontrada', 'error'); return; }

  Object.assign(this.empresas[i], {nome:name, cnpj, endereco:addr, telefone:phone, email});
  this.currentEmpresa = this.empresas[i];
  this.saveToStorage();
  this.logAction?.('company.update',{empresaId:this.currentEmpresa.id});
  document.getElementById('empresa-name').textContent = `${this.currentEmpresa.nome} (${this.currentEmpresa.codigo||''})`;
  this.showToast('Configurações salvas!', 'success');
},

saveGeneralGoalCommission: function(){
  if (!this.currentEmpresa) return;
  const empresaId = this.currentEmpresa.id;
  const cfg = this.configuracoes[empresaId] || (this.configuracoes[empresaId] = { empresaId, metasPorUsuario:{}, comissaoPorUsuario:{} });
  cfg.metaMensal = Number(document.getElementById('cfg-meta-geral').value || 0);
  cfg.comissaoPercentual = Number(document.getElementById('cfg-com-geral').value || 0);
  this.saveToStorage();
  this.logAction?.('kpi.general.update', { meta: cfg.metaMensal, comissao: cfg.comissaoPercentual });
  this.showToast('Configurações gerais salvas.', 'success');
},

uploadLogo: function() {
  if (!this.currentEmpresa) return;
  const fileInput = document.getElementById('company-logo');
  if (!fileInput.files.length){ this.showToast('Selecione uma imagem','error'); return; }

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const logoDataUrl = e.target.result;
    const empresaId = this.currentEmpresa.id;
    const i = this.empresas.findIndex(e => e.id === empresaId);
    if (i >= 0) {
      this.empresas[i].logo = logoDataUrl;
      this.currentEmpresa.logo = logoDataUrl;
      this.saveToStorage();
      this.loadAdmin();
      this.showToast('Logo atualizada com sucesso!','success');
    }
  };
  reader.readAsDataURL(file);
},

		saveGeneralGoalCommission: function(){
  if (!this.currentEmpresa) return;
  const empresaId = this.currentEmpresa.id;
  const cfg = this.configuracoes[empresaId] || (this.configuracoes[empresaId] = { empresaId, metasPorUsuario:{}, comissaoPorUsuario:{} });
  cfg.metaMensal = Number(document.getElementById('cfg-meta-geral').value || 0);
  cfg.comissaoPercentual = Number(document.getElementById('cfg-com-geral').value || 0);
  this.saveToStorage();
  this.logAction?.('kpi.general.update', { meta: cfg.metaMensal, comissao: cfg.comissaoPercentual });
  this.showToast('Configurações gerais salvas.', 'success');
},

uploadLogo: function() {
  if (!this.currentEmpresa) return;
  const fileInput = document.getElementById('company-logo');
  if (!fileInput.files.length){ this.showToast('Selecione uma imagem','error'); return; }

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const logoDataUrl = e.target.result;
    const empresaId = this.currentEmpresa.id;
    const i = this.empresas.findIndex(e => e.id === empresaId);
    if (i >= 0) {
      this.empresas[i].logo = logoDataUrl;
      this.currentEmpresa.logo = logoDataUrl;
      this.saveToStorage();
      this.logAction?.('company.logo.update', { empresaId }); // log correto aqui
      this.loadAdmin();
      this.showToast('Logo atualizada com sucesso!','success');
    }
  };
  reader.readAsDataURL(file);
},

saveUserGoalCommission: function(userId){
  if (!this.currentEmpresa) return;
  const empresaId = this.currentEmpresa.id;
  const cfg = this.configuracoes[empresaId] || (this.configuracoes[empresaId] = { empresaId, metasPorUsuario:{}, comissaoPorUsuario:{} });

  const goalEl = document.getElementById(`goal-${userId}`);
  const commEl = document.getElementById(`comm-${userId}`);
  const goal = goalEl.value === '' ? null : Number(goalEl.value);
  const comi = commEl.value === '' ? null : Number(commEl.value);

  cfg.metasPorUsuario ||= {};
  cfg.comissaoPorUsuario ||= {};

  if (goal === null) delete cfg.metasPorUsuario[userId]; else cfg.metasPorUsuario[userId] = Math.max(0, goal);
  if (comi === null) delete cfg.comissaoPorUsuario[userId]; else cfg.comissaoPorUsuario[userId] = Math.max(0, comi);

  this.saveToStorage();
  this.logAction?.('kpi.user.update', { userId, meta: goal ?? '(geral)', comissao: comi ?? '(geral)' });
  this.showToast('Meta/Comissão do vendedor atualizadas.', 'success');
},

resetUserGoalCommissionToGeneral: function(userId){
  if (!this.currentEmpresa) return;
  const empresaId = this.currentEmpresa.id;
  const cfg = this.configuracoes[empresaId] || (this.configuracoes[empresaId] = { empresaId, metasPorUsuario:{}, comissaoPorUsuario:{} });

  if (cfg.metasPorUsuario) delete cfg.metasPorUsuario[userId];
  if (cfg.comissaoPorUsuario) delete cfg.comissaoPorUsuario[userId];

  const goalEl = document.getElementById(`goal-${userId}`);
  const commEl = document.getElementById(`comm-${userId}`);
  if (goalEl) goalEl.value = '';
  if (commEl) commEl.value = '';

  this.saveToStorage();
  if (typeof this.logAction === 'function') {
    this.logAction('kpi.user.reset', { userId });
  }
  this.showToast('Vendedor voltou a usar os valores gerais.', 'info');
}


}; // <= fecha o objeto SystemControlPro certinho

// [TABS] ativa/desativa abas e renderiza conteúdo quando necessário
function setupTabs(){
  const tabs  = document.querySelectorAll('.tabs .tab');
  const views = document.querySelectorAll('.tab-content');

  tabs.forEach(tab=>{
    tab.addEventListener('click', ()=>{
      const tabName = tab.dataset.tab;

      // ativa a aba clicada
      tabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');

      // mostra o conteúdo correspondente
      views.forEach(v=>v.classList.remove('active'));
      const pane = document.getElementById(tabName);
      if (pane) pane.classList.add('active');

      // renderizações sob demanda
      if (tabName === 'orders' && typeof SystemControlPro.renderOrders === 'function') {
        SystemControlPro.renderOrders();
      }
      if (tabName === 'notas' && typeof SystemControlPro.renderNotas === 'function') {
        SystemControlPro.renderNotas();
      }
      if (tabName === 'quotes' && typeof SystemControlPro.renderQuotes === 'function') {
        SystemControlPro.renderQuotes();
      }
    });
  });
}


// --- Inicialização (versão final do portal de vendas) ---
window.onload = async () => {
  if (typeof seedIfEmptyVendor === 'function') {
    await seedIfEmptyVendor();
  } else if (typeof seedIfEmpty === 'function') {
    await seedIfEmpty();
  }

  if (SystemControlPro.loadFromStorage) SystemControlPro.loadFromStorage();
  SystemControlPro.normalizeData();
  if (SystemControlPro.saveToStorage) SystemControlPro.saveToStorage();

  SystemControlPro.init();
};
	
</script>
<!-- Modal Configurações da Empresa -->
<div class="modal" id="company-settings-modal">
  <div class="modal-content">
    <span class="close" onclick="SystemControlPro.hideCompanySettingsModal()">&times;</span>
    <h3>Configurações da Empresa</h3>

    <form id="company-settings-form">
      <div class="form-row">
        <div class="form-group">
          <label>Meta mensal (R$)</label>
          <input id="cfg-meta-mensal" type="number" step="0.01" placeholder="ex.: 20000">
        </div>
        <div class="form-group">
          <label>Comissão (%)</label>
          <input id="cfg-comissao-percent" type="number" step="0.01" placeholder="ex.: 5">
          <small>Obs.: será salva como fração (5% = 0,05).</small>
        </div>
        <div class="form-group">
          <label>Validade do orçamento (dias)</label>
          <input id="cfg-validade-orc" type="number" step="1" placeholder="ex.: 7">
        </div>
      </div>

      <div class="form-group">
        <label>Metas por usuário (opcional)</label>
        <div id="cfg-metas-por-usuario" style="display:grid;gap:8px"></div>
        <small>Preencha valores em R$; vazio = usa meta geral.</small>
      </div>

      <div class="form-group">
        <label>Comissão por usuário (%) (opcional)</label>
        <div id="cfg-comissao-por-usuario" style="display:grid;gap:8px"></div>
        <small>Vazio = usa comissão geral.</small>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button type="button" class="btn btn-secondary" onclick="SystemControlPro.hideCompanySettingsModal()">Cancelar</button>
        <button type="submit" class="btn btn-success">Salvar</button>
      </div>
    </form>
  </div>
</div>
<script>window.SCP_DEMO_SEED = true;</script>

 <!-- suporte: limpar storage do app e forçar seed quando ?scp_reseed=1 -->
<script>
  (function () {
    const p = new URLSearchParams(location.search);
    const shouldReseed = p.get('scp_reseed') === '1';
    // sempre mantenha true no portal do vendedor (index) para buscar empresas.json
    window.SCP_DEMO_SEED = true;

    if (shouldReseed) {
      const KEYS = [
        'systemControlPro_data','empresas','usuarios','produtos','clientes',
        'orcamentos','pedidos','configFisco','scp_session','scp_last_session'
      ];
      KEYS.forEach(k => { try { localStorage.removeItem(k); } catch(e){} });
      try { sessionStorage.removeItem('scp_session'); } catch(e){}
      // pronto: na próxima carga o core-storage vai semear a partir do empresas.json
    }
   })();

</script>
<!-- suporte: limpar storage do app e forçar seed quando ?scp_reseed=1 -->
<script>
  (function () {
    const p = new URLSearchParams(location.search);
    const shouldReseed = p.get('scp_reseed') === '1';
    window.SCP_DEMO_SEED = true;

    if (shouldReseed) {
      const KEYS = ['systemControlPro_data','empresas','usuarios','produtos','clientes','orcamentos','pedidos','configFisco','scp_session','scp_last_session'];
      KEYS.forEach(k => { try { localStorage.removeItem(k); } catch(e){} });
      try { sessionStorage.removeItem('scp_session'); } catch(e){}
    }
  })();
</script>

<!-- bloco com popularSelectEmpresas / carregarEmpresas / DOMContentLoaded -->
<script>
  (function () {
    // ... todo o seu código mostrado (popularSelectEmpresas, carregarEmpresas, DOMContentLoaded) ...
    document.addEventListener('DOMContentLoaded', async () => {
      const empresas = await carregarEmpresas();
      popularSelectEmpresas(empresas);
    });
  // Carrega empresas a partir do core-storage (SCP) ou do espelho no localStorage
  async function carregarEmpresas() {
    try {
      if (window.SCP_DEMO_SEED === true && window.SCP?.seedIfEmpty) {
        await window.SCP.seedIfEmpty();
      }
    } catch (e) {
      console.warn('Seed falhou:', e);
    }

    if (window.SCP?.getData) {
      return window.SCP.getData('empresas') || [];
    }

    try {
      const raw = localStorage.getItem('systemControlPro_data') || '{}';
      const parsed = JSON.parse(raw);
      return parsed.empresas || [];
    } catch (e) {
      return [];
    }
  }


  })();


</script>

<script src="core-storage.js" defer></script>
<script src="vendedor.js" defer></script>

 

</body>

</html>