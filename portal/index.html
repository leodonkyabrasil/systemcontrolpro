<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Cliente - System Control Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #FF8C00; /* Laranja */
            --primary-light: #FFA500;
            --primary-dark: #FF4500;
            --secondary-color: #3498db; /* Azul */
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
        }

        .customer-portal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: var(--box-shadow);
        }

        .customer-portal-header h1 {
            font-size: 1.8rem;
        }

        .customer-nav {
            display: flex;
            gap: 20px;
        }

        .customer-nav a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .customer-nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filters input, .search-filters select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            flex: 1;
            min-width: 200px;
        }

        .sorting-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 8px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sort-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .sort-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .product-image {
            height: 200px;
            width: 100%;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }

        .product-info {
            padding: 15px;
        }

        .product-company {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .product-price {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .add-to-cart {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: var(--border-radius);
            width: 100%;
            cursor: pointer;
            transition: var(--transition);
        }

        .add-to-cart:hover {
            background-color: var(--primary-dark);
        }

        .cart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .cart-item-actions button {
            background: var(--primary-light);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
        }

        .cart-total {
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 20px;
            text-align: right;
        }

        .checkout-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: var(--transition);
        }

        .checkout-btn:hover {
            background-color: #219653;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .payment-methods {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .payment-method {
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            flex: 1;
            min-width: 120px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-method.selected {
            border-color: var(--primary-color);
            background-color: rgba(255, 140, 0, 0.1);
        }

        .payment-method i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .login-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 1.5rem;
        }

        .phone-btn, .google-btn {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            border: none;
            font-size: 1rem;
            transition: var(--transition);
        }

        .phone-btn {
            background-color: var(--success-color);
            color: white;
        }

        .phone-btn:hover {
            background-color: #219653;
        }

        .google-btn {
            background-color: #4285F4;
            color: white;
        }

        .google-btn:hover {
            background-color: #357ae8;
        }

        .sms-verification {
            margin-top: 1.5rem;
            text-align: left;
        }

        .resend-code {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: pointer;
            text-align: center;
        }

        .resend-code:hover {
            color: var(--primary-color);
        }

        .countdown {
            color: var(--primary-color);
            font-weight: bold;
        }

        .best-sellers {
            margin-bottom: 30px;
        }

        .best-sellers h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .best-sellers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .payment-methods {
                flex-direction: column;
            }

            .customer-nav {
                flex-direction: column;
                gap: 10px;
            }

            .sorting-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header do Portal do Cliente -->
    <header class="customer-portal-header">
        <h1><i class="fas fa-store"></i> Portal do Cliente</h1>
        <nav class="customer-nav">
            <a href="#products"><i class="fas fa-box"></i> Produtos</a>
            <a href="#cart"><i class="fas fa-shopping-cart"></i> Carrinho</a>
            <a href="#quotes"><i class="fas fa-file-invoice-dollar"></i> Meus Orçamentos</a>
            <a href="#" onclick="CustomerPortal.logout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </nav>
    </header>

    <div class="container">
        <!-- Barra de pesquisa e filtros -->
        <div class="search-filters">
            <input type="text" id="search-input" placeholder="Buscar produtos...">
            <select id="company-filter">
                <option value="">Todas as empresas</option>
                <!-- Empresas serão carregadas via JavaScript -->
            </select>
            <select id="category-filter">
                <option value="">Todas as categorias</option>
                <!-- Categorias serão carregadas via JavaScript -->
            </select>
        </div>

        <!-- Opções de ordenação -->
        <div class="sorting-options">
            <button class="sort-btn" data-sort="default" id="sort-default">
                <i class="fas fa-sort"></i> Padrão
            </button>
            <button class="sort-btn" data-sort="price-asc" id="sort-price-asc">
                <i class="fas fa-sort-amount-down-alt"></i> Preço (Menor)
            </button>
            <button class="sort-btn" data-sort="price-desc" id="sort-price-desc">
                <i class="fas fa-sort-amount-down"></i> Preço (Maior)
            </button>
            <button class="sort-btn" data-sort="company" id="sort-company">
                <i class="fas fa-building"></i> Empresa
            </button>
            <button class="sort-btn" data-sort="sales" id="sort-sales">
                <i class="fas fa-trophy"></i> Mais Vendidos
            </button>
        </div>

        <!-- Ranking de produtos mais vendidos -->
        <div class="best-sellers" id="best-sellers-section">
            <h2><i class="fas fa-trophy"></i> Produtos Mais Vendidos</h2>
            <div class="best-sellers-grid" id="best-sellers-container">
                <!-- Produtos mais vendidos serão carregados via JavaScript -->
            </div>
        </div>

        <!-- Lista de produtos -->
        <div class="products-grid" id="products-container">
            <!-- Produtos serão carregados via JavaScript -->
        </div>

        <!-- Carrinho de compras -->
        <div class="cart-container" id="cart-section">
            <h2><i class="fas fa-shopping-cart"></i> Meu Carrinho</h2>
            <div id="cart-items">
                <!-- Itens do carrinho serão carregados via JavaScript -->
            </div>
            <div class="cart-total" id="cart-total">Total: R$ 0,00</div>

            <button class="checkout-btn" onclick="CustomerPortal.showCheckoutModal()">
                <i class="fas fa-check"></i> Finalizar Pedido
            </button>
        </div>
    </div>

    <!-- Modal de Finalização de Compra -->
    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="CustomerPortal.closeModal('checkout-modal')">&times;</span>
            <h2><i class="fas fa-check-circle"></i> Finalizar Pedido</h2>
            
            <div class="form-group">
                <label for="customer-name">Nome completo *</label>
                <input type="text" id="customer-name" required>
            </div>

            <div class="form-group">
                <label for="customer-cpf">CPF/CNPJ *</label>
                <input type="text" id="customer-cpf" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-email">E-mail *</label>
                    <input type="email" id="customer-email" required>
                </div>
                <div class="form-group">
                    <label for="customer-phone">Telefone *</label>
                    <input type="tel" id="customer-phone" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="customer-address">Endereço *</label>
                <input type="text" id="customer-address" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-city">Cidade *</label>
                    <input type="text" id="customer-city" required>
                </div>
                <div class="form-group">
                    <label for="customer-state">Estado *</label>
                    <input type="text" id="customer-state" required>
                </div>
                <div class="form-group">
                    <label for="customer-zip">CEP *</label>
                    <input type="text" id="customer-zip" required>
                </div>
            </div>
            
            <h3>Forma de Pagamento</h3>
            <div class="payment-methods">
                <div class="payment-method" onclick="CustomerPortal.selectPayment('pix')">
                    <i class="fas fa-qrcode"></i>
                    <div>PIX</div>
                </div>
                <div class="payment-method" onclick="CustomerPortal.selectPayment('credit')">
                    <i class="fas fa-credit-card"></i>
                    <div>Cartão de Crédito</div>
                </div>
                <div class="payment-method" onclick="CustomerPortal.selectPayment('debit')">
                    <i class="fas fa-credit-card"></i>
                    <div>Cartão de Débito</div>
                </div>
                <div class="payment-method" onclick="CustomerPortal.selectPayment('boleto')">
                    <i class="fas fa-barcode"></i>
                    <div>Boleto</div>
                </div>
            </div>
            
            <button class="checkout-btn" onclick="CustomerPortal.finalizeOrder()">
                <i class="fas fa-check"></i> Confirmar Pedido
            </button>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <h2><i class="fas fa-store"></i> Portal do Cliente</h2>
            <p>Faça login para continuar</p>
            
            <div class="login-options">
                <button class="phone-btn" onclick="CustomerPortal.showPhoneLogin()">
                    <i class="fas fa-phone"></i> Entrar com Telefone
                </button>
                <button class="google-btn" onclick="CustomerPortal.loginWithGoogle()">
                    <i class="fab fa-google"></i> Entrar com Google
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Login com Telefone -->
    <div id="phone-login-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="CustomerPortal.closeModal('phone-login-modal')">&times;</span>
            <h2><i class="fas fa-phone"></i> Login com Telefone</h2>
            
            <div class="form-group">
                <label for="phone-number">Número de Telefone:</label>
                <input type="tel" id="phone-number" placeholder="(11) 99999-9999" required>
            </div>
            
            <button class="phone-btn" onclick="CustomerPortal.sendVerificationCode()">
                <i class="fas fa-sms"></i> Enviar Código
            </button>
        </div>
    </div>

    <!-- Modal de Verificação de Código SMS -->
    <div id="sms-verification-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="CustomerPortal.closeModal('sms-verification-modal')">&times;</span>
            <h2><i class="fas fa-sms"></i> Verificação de Código</h2>
            
            <div class="form-group">
                <label for="sms-code">Código de 6 dígitos:</label>
                <input type="text" id="sms-code" placeholder="123456" maxlength="6" required>
            </div>
            
            <button class="phone-btn" onclick="CustomerPortal.verifySMSCode()">
                <i class="fas fa-check"></i> Verificar
            </button>
            
            <div class="resend-code" id="resend-code">
                Não recebeu o código? <span class="countdown" id="countdown">60</span>s para reenviar
            </div>
        </div>
    </div>

    <script>
        // Módulo do Portal do Cliente
        const CustomerPortal = {
            cart: [],
            selectedPayment: null,
            currentUser: null,
            smsCode: null,
            currentSort: 'default',
            phoneNumber: null,
            
            init: function() {
                // Verificar se o usuário está logado
                this.checkLoginStatus();
                
                // Se estiver logado, carregar os dados
                if (this.currentUser) {
                    this.loadProducts();
                    this.loadCompaniesFilter();
                    this.loadCategoriesFilter();
                    this.loadCartFromStorage();
                    this.updateCartUI();
                    this.loadBestSellers();
                }
                
                // Configurar eventos de ordenação
                this.setupSortingEvents();
                
                // Aplicar ordenação automática baseada no dia
                this.applyDailySorting();
            },
            
            // Configurar eventos de ordenação
            setupSortingEvents: function() {
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const sortType = e.currentTarget.getAttribute('data-sort');
                        this.sortProducts(sortType);
                        
                        // Atualizar UI dos botões
                        document.querySelectorAll('.sort-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        e.currentTarget.classList.add('active');
                    });
                });
            },
            
            // Aplicar ordenação automática baseada no dia
            applyDailySorting: function() {
                const dayOfWeek = new Date().getDay(); // 0 = Domingo, 1 = Segunda, etc.
                
                let sortType = 'default';
                
                switch(dayOfWeek) {
                    case 0: // Domingo - ordenar por preço (menor primeiro)
                        sortType = 'price-asc';
                        break;
                    case 1: // Segunda - ordenar por preço (maior primeiro)
                        sortType = 'price-desc';
                        break;
                    case 2: // Terça - ordenar por empresa
                        sortType = 'company';
                        break;
                    case 3: // Quarta - ordenar por vendas
                        sortType = 'sales';
                        break;
                    case 4: // Quinta - ordenar por preço (menor primeiro)
                        sortType = 'price-asc';
                        break;
                    case 5: // Sexta - ordenar por preço (maior primeiro)
                        sortType = 'price-desc';
                        break;
                    case 6: // Sábado - ordenar por empresa em destaque
                        sortType = 'company-featured';
                        break;
                }
                
                // Aplicar a ordenação
                this.sortProducts(sortType);
                
                // Atualizar UI do botão ativo
                document.querySelectorAll('.sort-btn').forEach(b => {
                    b.classList.remove('active');
                    if (b.getAttribute('data-sort') === sortType) {
                        b.classList.add('active');
                    }
                });
            },
            
            // Ordenar produtos
            sortProducts: function(sortType) {
                this.currentSort = sortType;
                this.filterProducts();
            },
            
            // Verificar status de login
            checkLoginStatus: function() {
                const user = JSON.parse(localStorage.getItem('customerPortal_user'));
                if (user) {
                    this.currentUser = user;
                    document.getElementById('login-container').style.display = 'none';
                    document.querySelector('header').style.display = 'flex';
                    document.querySelector('.container').style.display = 'block';
                } else {
                    document.getElementById('login-container').style.display = 'flex';
                    document.querySelector('header').style.display = 'none';
                    document.querySelector('.container').style.display = 'none';
                }
            },
            
            // Mostrar login com telefone
            showPhoneLogin: function() {
                document.getElementById('phone-login-modal').style.display = 'flex';
            },
            
            // Enviar código de verificação
            sendVerificationCode: function() {
                const phoneNumber = document.getElementById('phone-number').value;
                
                if (!phoneNumber) {
                    this.showToast('Digite um número de telefone válido', 'error');
                    return;
                }
                
                this.phoneNumber = phoneNumber;
                
                // Gerar código de 6 dígitos
                this.smsCode = Math.floor(100000 + Math.random() * 900000);
                
                // Simular envio de SMS (em produção, integrar com API de SMS)
                console.log(`Código de verificação para ${phoneNumber}: ${this.smsCode}`);
                
                // Fechar modal atual e abrir modal de verificação
                this.closeModal('phone-login-modal');
                document.getElementById('sms-verification-modal').style.display = 'flex';
                
                // Iniciar contagem regressiva para reenvio
                this.startCountdown();
                
                this.showToast('Código de verificação enviado por SMS', 'success');
            },
            
            // Iniciar contagem regressiva para reenvio
            startCountdown: function() {
                const countdownEl = document.getElementById('countdown');
                const resendEl = document.getElementById('resend-code');
                let seconds = 60;
                
                countdownEl.textContent = seconds;
                
                const countdownInterval = setInterval(() => {
                    seconds--;
                    countdownEl.textContent = seconds;
                    
                    if (seconds <= 0) {
                        clearInterval(countdownInterval);
                        resendEl.innerHTML = 'Não recebeu o código? <a href="javascript:void(0)" onclick="CustomerPortal.resendCode()">Reenviar código</a>';
                    }
                }, 1000);
            },
            
            // Reenviar código
            resendCode: function() {
                // Gerar novo código
                this.smsCode = Math.floor(100000 + Math.random() * 900000);
                
                // Simular reenvio de SMS
                console.log(`Novo código de verificação para ${this.phoneNumber}: ${this.smsCode}`);
                
                // Reiniciar contagem regressiva
                document.getElementById('resend-code').innerHTML = 'Não recebeu o código? <span class="countdown" id="countdown">60</span>s para reenviar';
                this.startCountdown();
                
                this.showToast('Código reenviado com sucesso', 'success');
            },
            
            // Verificar código SMS
            verifySMSCode: function() {
                const enteredCode = document.getElementById('sms-code').value;
                
                if (!enteredCode || enteredCode.length !== 6) {
                    this.showToast('Digite um código de 6 dígitos', 'error');
                    return;
                }
                
                if (parseInt(enteredCode) === this.smsCode) {
                    // Código correto - fazer login
                    const user = {
                        id: 'phone_' + Date.now(),
                        name: 'Usuário ' + this.phoneNumber,
                        phone: this.phoneNumber,
                        loginMethod: 'phone'
                    };
                    
                    localStorage.setItem('customerPortal_user', JSON.stringify(user));
                    this.currentUser = user;
                    this.checkLoginStatus();
                    this.closeModal('sms-verification-modal');
                    this.init();
                    this.showToast('Login realizado com sucesso!', 'success');
                } else {
                    this.showToast('Código incorreto. Tente novamente.', 'error');
                }
            },
            
            // Login com Google (simulado)
            loginWithGoogle: function() {
                // Simulação de login com Google
                const user = {
                    id: 'google_' + Date.now(),
                    name: 'Usuário Google',
                    email: 'usuario@gmail.com',
                    loginMethod: 'google'
                };
                
                localStorage.setItem('customerPortal_user', JSON.stringify(user));
                this.currentUser = user;
                this.checkLoginStatus();
                this.init();
                this.showToast('Login com Google realizado com sucesso!', 'success');
            },
            
            // Logout
            logout: function() {
                localStorage.removeItem('customerPortal_user');
                this.currentUser = null;
                this.checkLoginStatus();
                this.showToast('Logout realizado com sucesso', 'success');
            },
            
            // Carregar produtos de todas as empresas
            loadProducts: function() {
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                const productsContainer = document.getElementById('products-container');
                productsContainer.innerHTML = '';
                
                // Coletar todos os produtos de todas as empresas
                let allProducts = [];
                for (const empresaId in systemData.produtos) {
                    const empresa = (systemData.empresas || []).find(e => e.id == empresaId);
                    if (empresa && empresa.status === 'active') {
                        const produtos = systemData.produtos[empresaId] || [];
                        produtos.forEach(p => {
                            // Evitar duplicatas - verificar se produto já existe
                            const existingIndex = allProducts.findIndex(prod => 
                                prod.id === p.id && prod.empresaId === empresaId
                            );
                            
                            if (existingIndex === -1) {
                                allProducts.push({
                                    ...p,
                                    empresaId: empresaId,
                                    empresaNome: empresa.nome,
                                    empresaCodigo: empresa.codigo
                                });
                            }
                        });
                    }
                }
                
                // Aplicar ordenação
                allProducts = this.applySorting(allProducts);
                
                // Exibir produtos
                allProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <img src="${product.image || 'https://via.placeholder.com/250'}" alt="${product.nome}" class="product-image">
                        <div class="product-info">
                            <div class="product-company">${product.empresaNome} (${product.empresaCodigo})</div>
                            <div class="product-name">${product.nome}</div>
                            <div class="product-price">R$ ${product.preco.toFixed(2)}</div>
                            <button class="add-to-cart" onclick="CustomerPortal.addToCart(${product.id}, ${product.empresaId})">
                                <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                            </button>
                        </div>
                    `;
                    productsContainer.appendChild(productCard);
                });
            },
            
            // Aplicar ordenação aos produtos
            applySorting: function(products) {
                switch(this.currentSort) {
                    case 'price-asc':
                        return products.sort((a, b) => a.preco - b.preco);
                    case 'price-desc':
                        return products.sort((a, b) => b.preco - a.preco);
                    case 'company':
                        return products.sort((a, b) => a.empresaNome.localeCompare(b.empresaNome));
                    case 'sales':
                        // Ordenar por vendas (necessária implementação de tracking de vendas)
                        return products; // Placeholder - implementar lógica real
                    case 'company-featured':
                        // Ordenar com empresa em destaque (rotativo)
                        const featuredCompany = this.getFeaturedCompany();
                        return products.sort((a, b) => {
                            if (a.empresaId === featuredCompany) return -1;
                            if (b.empresaId === featuredCompany) return 1;
                            return a.empresaNome.localeCompare(b.empresaNome);
                        });
                    default:
                        return products;
                }
            },
            
            // Obter empresa em destaque (rotativo por dia)
            getFeaturedCompany: function() {
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                const activeCompanies = (systemData.empresas || []).filter(e => e.status === 'active');
                
                if (activeCompanies.length === 0) return null;
                
                // Usar o dia da semana para determinar a empresa em destaque
                const dayOfWeek = new Date().getDay();
                const companyIndex = dayOfWeek % activeCompanies.length;
                
                return activeCompanies[companyIndex].id;
            },
            
            // Carregar produtos mais vendidos
            loadBestSellers: function() {
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                const bestSellersContainer = document.getElementById('best-sellers-container');
                bestSellersContainer.innerHTML = '';
                
                // Coletar todos os pedidos para calcular produtos mais vendidos
                let allOrders = [];
                for (const empresaId in systemData.pedidos) {
                    const pedidos = systemData.pedidos[empresaId] || [];
                    allOrders = allOrders.concat(pedidos);
                }
                
                // Calcular produtos mais vendidos
                const productSales = {};
                allOrders.forEach(order => {
                    order.items.forEach(item => {
                        const key = `${item.produtoId}_${order.empresaId || 'unknown'}`;
                        if (!productSales[key]) {
                            productSales[key] = {
                                productId: item.produtoId,
                                empresaId: order.empresaId || 'unknown',
                                sales: 0
                            };
                        }
                        productSales[key].sales += item.quantidade;
                    });
                });
                
                // Obter detalhes dos produtos mais vendidos
                const bestSellerProducts = [];
                for (const key in productSales) {
                    const { productId, empresaId, sales } = productSales[key];
                    
                    // Encontrar o produto
                    for (const empId in systemData.produtos) {
                        if (empId != empresaId) continue;
                        
                        const product = (systemData.produtos[empId] || []).find(p => p.id == productId);
                        if (product) {
                            const empresa = (systemData.empresas || []).find(e => e.id == empId);
                            bestSellerProducts.push({
                                ...product,
                                empresaId: empId,
                                empresaNome: empresa ? empresa.nome : 'Desconhecida',
                                sales: sales
                            });
                            break;
                        }
                    }
                }
                
                // Ordenar por vendas e pegar os top 5
                bestSellerProducts.sort((a, b) => b.sales - a.sales);
                const topProducts = bestSellerProducts.slice(0, 5);
                
                // Exibir produtos mais vendidos
                topProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <img src="${product.image || 'https://via.placeholder.com/250'}" alt="${product.nome}" class="product-image">
                        <div class="product-info">
                            <div class="product-name">${product.nome}</div>
                            <div class="product-price">R$ ${product.preco.toFixed(2)}</div>
                            <div style="color: var(--primary-color); font-weight: bold;">
                                <i class="fas fa-trophy"></i> ${product.sales} vendas
                            </div>
                            <button class="add-to-cart" onclick="CustomerPortal.addToCart(${product.id}, ${product.empresaId})">
                                <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                            </button>
                        </div>
                    `;
                    bestSellersContainer.appendChild(productCard);
                });
            },
            
            // Carregar filtro de empresas
            loadCompaniesFilter: function() {
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                const companyFilter = document.getElementById('company-filter');
                companyFilter.innerHTML = '<option value="">Todas as empresas</option>';
                
                // Usar Set para evitar empresas duplicadas
                const uniqueCompanies = new Set();
                
                (systemData.empresas || []).forEach(empresa => {
                    if (empresa.status === 'active' && !uniqueCompanies.has(empresa.id)) {
                        uniqueCompanies.add(empresa.id);
                        const option = document.createElement('option');
                        option.value = empresa.id;
                        option.textContent = `${empresa.nome} (${empresa.codigo})`;
                        companyFilter.appendChild(option);
                    }
                });
                
                companyFilter.addEventListener('change', () => this.filterProducts());
            },
            
            // Carregar filtro de categorias
            loadCategoriesFilter: function() {
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                const categoryFilter = document.getElementById('category-filter');
                categoryFilter.innerHTML = '<option value="">Todas as categorias</option>';
                
                // Coletar categorias únicas
                const categories = new Set();
                for (const empresaId in systemData.produtos) {
                    const produtos = systemData.produtos[empresaId] || [];
                    produtos.forEach(p => {
                        if (p.categoria) categories.add(p.categoria);
                    });
                }
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
                
                categoryFilter.addEventListener('change', () => this.filterProducts());
            },
            
            // Filtrar produtos
            filterProducts: function() {
                const companyFilter = document.getElementById('company-filter').value;
                const categoryFilter = document.getElementById('category-filter').value;
                const searchInput = document.getElementById('search-input').value.toLowerCase();
                
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                const productsContainer = document.getElementById('products-container');
                productsContainer.innerHTML = '';
                
                // Coletar todos os produtos com filtros aplicados
                let allProducts = [];
                for (const empresaId in systemData.produtos) {
                    const empresa = (systemData.empresas || []).find(e => e.id == empresaId);
                    if (empresa && empresa.status === 'active') {
                        // Aplicar filtro de empresa
                        if (companyFilter && empresaId !== companyFilter) continue;
                        
                        const produtos = systemData.produtos[empresaId] || [];
                        produtos.forEach(p => {
                            // Aplicar filtro de categoria
                            if (categoryFilter && p.categoria !== categoryFilter) return;
                            
                            // Aplicar filtro de busca
                            if (searchInput && 
                                !p.nome.toLowerCase().includes(searchInput) &&
                                !p.categoria.toLowerCase().includes(searchInput) &&
                                !empresa.nome.toLowerCase().includes(searchInput)) return;
                            
                            allProducts.push({
                                ...p,
                                empresaId: empresaId,
                                empresaNome: empresa.nome,
                                empresaCodigo: empresa.codigo
                            });
                        });
                    }
                }
                
                // Aplicar ordenação
                allProducts = this.applySorting(allProducts);
                
                // Exibir produtos filtrados
                allProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <img src="${product.image || 'https://via.placeholder.com/250'}" alt="${product.nome}" class="product-image">
                        <div class="product-info">
                            <div class="product-company">${product.empresaNome} (${product.empresaCodigo})</div>
                            <div class="product-name">${product.nome}</div>
                            <div class="product-price">R$ ${product.preco.toFixed(2)}</div>
                            <button class="add-to-cart" onclick="CustomerPortal.addToCart(${product.id}, ${product.empresaId})">
                                <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                            </button>
                        </div>
                    `;
                    productsContainer.appendChild(productCard);
                });
            },
            
            // Adicionar produto ao carrinho
            addToCart: function(productId, empresaId) {
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                const product = (systemData.produtos[empresaId] || []).find(p => p.id == productId);
                
                if (!product) {
                    alert('Produto não encontrado!');
                    return;
                }
                
                // Verificar se o produto já está no carrinho
                const existingItem = this.cart.find(item => item.id === productId && item.empresaId === empresaId);
                
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    this.cart.push({
                        id: product.id,
                        empresaId: empresaId,
                        name: product.nome,
                        price: product.preco,
                        quantity: 1,
                        image: product.image,
                        empresa: (systemData.empresas || []).find(e => e.id == empresaId)?.nome || 'Desconhecida'
                    });
                }
                
                this.saveCartToStorage();
                this.updateCartUI();
                this.showToast('Produto adicionado ao carrinho!', 'success');
            },
            
            // Remover item do carrinho
            removeFromCart: function(productId, empresaId) {
                this.cart = this.cart.filter(item => !(item.id === productId && item.empresaId === empresaId));
                this.saveCartToStorage();
                this.updateCartUI();
                this.showToast('Produto removido do carrinho!', 'success');
            },
            
            // Atualizar quantidade do item
            updateQuantity: function(productId, empresaId, change) {
                const item = this.cart.find(item => item.id === productId && item.empresaId === empresaId);
                
                if (item) {
                    item.quantity += change;
                    
                    if (item.quantity <= 0) {
                        this.removeFromCart(productId, empresaId);
                    } else {
                        this.saveCartToStorage();
                        this.updateCartUI();
                    }
                }
            },
            
            // Salvar carrinho no localStorage
            saveCartToStorage: function() {
                localStorage.setItem('customerPortal_cart', JSON.stringify(this.cart));
            },
            
            // Carregar carrinho do localStorage
            loadCartFromStorage: function() {
                const savedCart = localStorage.getItem('customerPortal_cart');
                if (savedCart) {
                    this.cart = JSON.parse(savedCart);
                }
            },
            
            // Atualizar interface do carrinho
            updateCartUI: function() {
                const cartItems = document.getElementById('cart-items');
                const cartTotal = document.getElementById('cart-total');
                
                cartItems.innerHTML = '';
                
                if (this.cart.length === 0) {
                    cartItems.innerHTML = '<p>Seu carrinho está vazio</p>';
                    cartTotal.textContent = 'Total: R$ 0,00';
                    return;
                }
                
                let total = 0;
                
                this.cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.innerHTML = `
                        <div class="cart-item-info">
                            <strong>${item.name}</strong>
                            <div>${item.empresa} - R$ ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="cart-item-actions">
                            <button onclick="CustomerPortal.updateQuantity(${item.id}, ${item.empresaId}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="CustomerPortal.updateQuantity(${item.id}, ${item.empresaId}, 1)">+</button>
                            <button onclick="CustomerPortal.removeFromCart(${item.id}, ${item.empresaId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    cartItems.appendChild(cartItem);
                });
                
                cartTotal.textContent = `Total: R$ ${total.toFixed(2)}`;
            },
            
            // Mostrar modal de finalização
            showCheckoutModal: function() {
                if (this.cart.length === 0) {
                    this.showToast('Adicione produtos ao carrinho primeiro', 'error');
                    return;
                }
                
                document.getElementById('checkout-modal').style.display = 'flex';
            },
            
            // Selecionar método de pagamento
            selectPayment: function(method) {
                this.selectedPayment = method;
                
                // Atualizar UI
                document.querySelectorAll('.payment-method').forEach(el => {
                    el.classList.remove('selected');
                });
                
                event.currentTarget.classList.add('selected');
            },
            
            // Finalizar pedido
            finalizeOrder: function() {
                const name = document.getElementById('customer-name').value;
                const email = document.getElementById('customer-email').value;
                const phone = document.getElementById('customer-phone').value;
                const address = document.getElementById('customer-address').value;
                const city = document.getElementById('customer-city').value;
                const state = document.getElementById('customer-state').value;
                const zip = document.getElementById('customer-zip').value;
                const cpf = document.getElementById('customer-cpf').value;
                
                if (!name || !email || !phone || !address || !city || !state || !zip || !cpf) {
                    this.showToast('Preencha todos os campos obrigatórios', 'error');
                    return;
                }
                
                if (!this.selectedPayment) {
                    this.showToast('Selecione uma forma de pagamento', 'error');
                    return;
                }
                
                // Calcular totais
                let subtotal = 0;
                this.cart.forEach(item => {
                    subtotal += item.price * item.quantity;
                });
                
                // Criar orçamento
                const quote = {
                    id: Date.now(),
                    customer: { name, email, phone, address, city, state, zip, cpf },
                    items: [...this.cart],
                    subtotal,
                    total: subtotal, // Sem frete por enquanto
                    paymentMethod: this.selectedPayment,
                    status: 'pending',
                    date: new Date().toISOString()
                };
                
                // Salvar orçamento e cadastrar cliente
                this.saveQuote(quote);
                this.registerCustomerInSystem({
                    name: name,
                    email: email,
                    phone: phone,
                    address: address,
                    city: city,
                    state: state,
                    zip: zip,
                    cpf: cpf
                });
                
                // Limpar carrinho
                this.cart = [];
                this.saveCartToStorage();
                this.updateCartUI();
                
                // Fechar modal
                this.closeModal('checkout-modal');
                
                this.showToast('Pedido realizado com sucesso! O vendedor entrará em contato para definir o frete e finalizar o pedido.', 'success');
            },
            
            // Salvar orçamento
            saveQuote: function(quote) {
                let quotes = JSON.parse(localStorage.getItem('customerPortal_quotes') || '[]');
                quotes.push(quote);
                localStorage.setItem('customerPortal_quotes', JSON.stringify(quotes));
                
                // Também salvar no sistema principal (como orçamento)
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                
                // Agrupar itens por empresa para criar orçamentos individuais
                const itemsByCompany = {};
                quote.items.forEach(item => {
                    if (!itemsByCompany[item.empresaId]) {
                        itemsByCompany[item.empresaId] = [];
                    }
                    itemsByCompany[item.empresaId].push(item);
                });
                
                // Criar orçamento para cada empresa
                for (const empresaId in itemsByCompany) {
                    const empresaItems = itemsByCompany[empresaId];
                    let empresaSubtotal = 0;
                    empresaItems.forEach(item => {
                        empresaSubtotal += item.price * item.quantity;
                    });
                    
                    const empresaQuote = {
                        id: quote.id + parseInt(empresaId),
                        clienteId: null, // Cliente externo
                        clienteNome: quote.customer.name,
                        clienteEmail: quote.customer.email,
                        clienteTelefone: quote.customer.phone,
                        clienteCPF: quote.customer.cpf,
                        data: new Date().toISOString(),
                        validoAte: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        items: empresaItems.map(item => ({
                            produtoId: item.id,
                            quantidade: item.quantity,
                            preco: item.price,
                            total: item.price * item.quantity
                        })),
                        total: empresaSubtotal,
                        status: 'pending',
                        // Informações de entrega
                        entrega: {
                            endereco: quote.customer.address,
                            cidade: quote.customer.city,
                            estado: quote.customer.state,
                            cep: quote.customer.zip
                        }
                    };
                    
                    // Adicionar ao sistema
                    if (!systemData.orcamentos) systemData.orcamentos = {};
                    if (!systemData.orcamentos[empresaId]) systemData.orcamentos[empresaId] = [];
                    systemData.orcamentos[empresaId].push(empresaQuote);
                }
                
                localStorage.setItem('systemControlPro_data', JSON.stringify(systemData));
            },
            
            // Cadastrar cliente no sistema principal
            registerCustomerInSystem: function(customerData) {
                const systemData = JSON.parse(localStorage.getItem('systemControlPro_data') || '{}');
                
                // Para cada empresa no carrinho, cadastrar o cliente
                const empresasNoCarrinho = [...new Set(this.cart.map(item => item.empresaId))];
                
                empresasNoCarrinho.forEach(empresaId => {
                    if (!systemData.clientes) systemData.clientes = {};
                    if (!systemData.clientes[empresaId]) systemData.clientes[empresaId] = [];
                    
                    // Verificar se cliente já existe
                    const clienteExistente = systemData.clientes[empresaId].find(
                        c => c.email === customerData.email || c.cpfCnpj === customerData.cpf
                    );
                    
                    if (!clienteExistente) {
                        // Criar novo cliente
                        const novoCliente = {
                            id: Date.now(),
                            nome: customerData.name,
                            email: customerData.email,
                            telefone: customerData.phone,
                            cpfCnpj: customerData.cpf,
                            endereco: `${customerData.address}, ${customerData.city}, ${customerData.state}, ${customerData.zip}`,
                            dataCadastro: new Date().toISOString(),
                            status: 'active'
                        };
                        
                        systemData.clientes[empresaId].push(novoCliente);
                    }
                });
                
                // Salvar dados atualizados
                localStorage.setItem('systemControlPro_data', JSON.stringify(systemData));
            },
            
            // Fechar modal
            closeModal: function(modalId) {
                document.getElementById(modalId).style.display = 'none';
            },
            
            // Mostrar notificação
            showToast: function(message, type) {
                // Implementação simples com alerta (pode ser substituída por um sistema de toast mais elaborado)
                alert(`[${type.toUpperCase()}] ${message}`);
            }
        };

        // Inicializar o portal quando a página carregar
        window.onload = function() {
            CustomerPortal.init();
            
            // Adicionar evento de busca
            document.getElementById('search-input').addEventListener('input', () => {
                CustomerPortal.filterProducts();
            });
        };
    </script>
</body>
</html>
